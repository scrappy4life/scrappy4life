var ta=s=>{throw TypeError(s)};var Zi=(s,t,e)=>t.has(s)||ta("Cannot "+e);var o=(s,t,e)=>(Zi(s,t,"read from private field"),e?e.call(s):t.get(s)),y=(s,t,e)=>t.has(s)?ta("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),w=(s,t,e,n)=>(Zi(s,t,"write to private field"),n?n.call(s,e):t.set(s,e),e),m=(s,t,e)=>(Zi(s,t,"access private method"),e);var Qi=(s,t,e,n)=>({set _(i){w(s,t,i,e)},get _(){return o(s,t,n)}});(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();var fn,pn;const Oe=class Oe{constructor(){y(this,pn,new EventTarget)}static getInstance(){return o(Oe,fn)||w(Oe,fn,new Oe),o(Oe,fn)}on(t,e){o(this,pn).addEventListener(t,n=>{e(n.detail)})}off(t,e){o(this,pn).removeEventListener(t,n=>{e(n.detail)})}emit(t,e){o(this,pn).dispatchEvent(new CustomEvent(t,{detail:e}))}};fn=new WeakMap,pn=new WeakMap,y(Oe,fn);let M=Oe;const rh={"thing:_base":{metadata:{description:"The static (persistent, serializable) data of a Thing. Based on JSON Canvas (for required properties like `type` and `id`) and JSON Schema (for format types like `date-time`)."},extends_:[],properties:[{name:"name",type:"string",description:"Name used in formulae and scripts. Must be start with a lowercase letter, then contain letters, numbers, and underscores, and not be a reserved word or name.",category:"Identity",disallowFormula:!1,pattern:"^(?!(?:break|case|catch|class|const|continue|debugger|default|delete|do|else|export|extends|false|finally|for|function|if|import|in|instanceof|new|null|return|super|switch|this|throw|true|try|typeof|var|void|while|with|let|static|yield|await|enum|implements|interface|package|private|protected|public|arguments|as|async|eval|from|get|of|set|window|document|navigator|location|history|screen|performance)$)[A-Za-z][\\w]*$",minLength:1},{name:"type",type:"ThingType",description:"Type",readonly:!0,category:"Identity"},{name:"id",type:"ThingId",description:"Unique identifier",readonly:!0,category:"Identity"},{name:"parentId",type:"string | undefined",description:"Parent's unique identifier, if any",category:"Identity",readonly:!0,disallowFormula:!1},{name:"x",type:"number",description:"X position",category:"Layout"},{name:"y",type:"number",description:"Y position",category:"Layout"},{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:100,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:100,min:10},{name:"visible",type:"boolean",description:"Visible or hidden",category:"Layout",default:!0}]},"thing:button":{metadata:{title:"Button",description:"Simple button that performs an action when pushed.",category:"Interaction"},extends_:["thing:_base","thing:_bordered","thing:_styledtext"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:40,min:10},{name:"borderRadius",type:"number",description:"Border radius in pixels",category:"Appearance",default:4,min:0},{name:"backgroundColor",type:"string",description:"Background color",category:"Appearance",format:"color",default:"#efefef"},{name:"alignHorizontal",type:"AlignHorizontal",description:"Text horizontal alignment",category:"Text",format:"align-horizontal",default:"center",enum:["left","center","right"]},{name:"title",type:"string",description:"The text to display on the button",category:"Text",default:"Button"},{name:"enabled",type:"boolean",description:"Whether the button is currently enabled/clickable",default:!0},{name:"whenClicked",type:"string",description:"JavaScript code to execute when button is clicked",format:"code-js",default:'alert("Ahoy, world!")'}],methods:[{name:"click",description:"Triggers the button's click action, executing the script defined in the whenClicked slot.",parameters:[],returns:{type:"any",description:"The result of executing the whenClicked script, if any"}}]},"thing:checkbox":{metadata:{title:"Boolean Checkbox",description:"Stores an editable boolean (on/off, true/false) value. Can be used as form input (`isFormInput` returns true).",category:"Value"},extends_:["thing:_base"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:20,min:10},{name:"value",type:"boolean",description:"Checkbox value",category:"Value",default:!1},{name:"enabled",type:"boolean",description:"Whether the checkbox is currently enabled/clickable",default:!0},{name:"title",type:"string",description:"Checkbox title",default:"Checkbox"}],methods:[]},"thing:terminal":{metadata:{title:"Command Prompt",description:"",category:"System"},extends_:["thing:_base"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:560,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:320,min:10},{name:"backgroundColor",type:"string",description:"Background color",category:"Appearance",format:"color",default:"#000000"},{name:"fontSize",type:"number",description:"Text font size in pixels",category:"Appearance",format:"font-family",default:11,min:1},{name:"textColor",type:"string",description:"Text color",category:"Appearance",format:"color",default:"#00ff00"},{name:"value",type:"string",description:"Text value",default:`   _____              
  (, /  |  /)         
    /---| (/   ___    
 ) /    |_/ )_(_) (_/_
(_/              .-/  
                (_/   

For help, type "help".

`}],methods:[]},"thing:datetime":{metadata:{title:"Date/Time Field",description:"Stores an editable date/time value. Can be used as form input (`isFormInput` returns true).",category:"Value"},extends_:["thing:_base","thing:_bordered","thing:_styledtext"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:240,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:24,min:10},{name:"value",type:"string",description:"Date/time value in RFC 3339 format\n\n@example `1984-01-24T18:45:00.800Z`",category:"Value",format:"date-time",step:1},{name:"enabled",type:"boolean",description:"Whether the date/time field is currently enabled/clickable",default:!0}],methods:[{name:"setValueToNow",description:"Sets the `value` to `now()`, the current local time.",parameters:[]},{name:"getFormattedValue",description:'Gets the date/time `value` formatted according to the `dateStyle` and `timeStyle` options. The format is determined by the browser\'s current locale settings.\nthing.getFormattedValue("full", "short") // Returns e.g. "Wednesday, January 1, 2025 at 9:41 PM"',parameters:[],returns:{type:"any",description:"A localized string representation of the current date/time value"}}]},"thing:frame":{metadata:{title:"Frame",description:"",category:"Shape"},extends_:["thing:_base","thing:_bordered"],properties:[],methods:[]},"thing:html":{metadata:{title:"Web Embed",description:"",category:"External Content"},extends_:["thing:_base","thing:_bordered"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:512,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:384,min:10},{name:"value",type:"string",description:"HTML content",default:'<blockquote class="twitter-tweet"><p lang="en" dir="ltr">I believe there’s going to be four main categories of software moving forward:<br><br>- Commercial software<br>- Boutique software<br>- Personal software<br>- Disposable software<br><br>Disposable is a sustainable way of executing a use case without the need to maintain it.<a href="https://t.co/L6YyrudF0L">https://t.co/L6YyrudF0L</a> <a href="https://t.co/FV9qyGVDpm">https://t.co/FV9qyGVDpm</a> <a href="https://t.co/kTHs7zKaYv">pic.twitter.com/kTHs7zKaYv</a></p>&mdash; David Hoang (@davidhoang) <a href="https://twitter.com/davidhoang/status/1802140453292372272?ref_src=twsrc%5Etfw">June 16, 2024</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"><\/script>'}],methods:[]},"thing:jscanvas":{metadata:{title:"JS Canvas",description:"A Thing with a JavaScript canvas and event handlers for drawing.",category:"Interaction"},extends_:["thing:_base","thing:_bordered"],properties:[{name:"whenCreated",type:"string",description:"Code to run when created",format:"code-js",default:"// Setup code here"},{name:"whenMouseMoved",type:"string",description:"Code to run when mouse moves",format:"code-js",default:`const canvas = document.getElementById(this.id).querySelector('canvas');
const ctx = canvas.getContext('2d');
const rect = canvas.getBoundingClientRect();
const mouseX = event.clientX - rect.left;
const mouseY = event.clientY - rect.top;

ctx.clearRect(0, 0, canvas.width, canvas.height);

const eyeWidth = canvas.width * 0.35;
const eyeHeight = canvas.height * 0.5;
const eyeSpacing = canvas.width * 0.1;

function drawEye(centerX, centerY, width, height, mouseX, mouseY) {
  ctx.fillStyle = "white";
  ctx.strokeStyle = "black";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.ellipse(centerX, centerY, width/2, height/2, 0, Math.PI * 2, 0);
  ctx.fill();
  ctx.stroke();

  // Calculate pupil position
  const angle = Math.atan2(mouseY - centerY, mouseX - centerX);
  const maxPupilOffset = Math.min(width, height) * 0.2;
  const pupilX = centerX + Math.cos(angle) * maxPupilOffset;
  const pupilY = centerY + Math.sin(angle) * maxPupilOffset;

  // Draw pupil
  const pupilSize = Math.min(width, height) * 0.2;
  ctx.fillStyle = "black";
  ctx.beginPath();
  ctx.arc(pupilX, pupilY, pupilSize, 0, Math.PI * 2);
  ctx.fill();
}

// Draw eyes
drawEye(
  canvas.width/2 - eyeWidth - eyeSpacing/2, 
  canvas.height/2, 
  eyeWidth,
  eyeHeight,
  mouseX,
  mouseY
);
drawEye(
  canvas.width/2 + eyeSpacing/2, 
  canvas.height/2,
  eyeWidth,
  eyeHeight,
  mouseX,
  mouseY
);`},{name:"whenMousePressed",type:"string",description:"Code to run when mouse pressed",format:"code-js",default:"// Mouse pressed"},{name:"whenMouseReleased",type:"string",description:"Code to run when mouse released",format:"code-js",default:"// Mouse released"},{name:"whenResized",type:"string",description:"Code to run when canvas resized",format:"code-js",default:"// Resized to ${width} x ${height}"},{name:"whenDestroyed",type:"string",description:"Code to run when destroyed",format:"code-js",default:"// Cleanup code here"}],methods:[]},"thing:data":{metadata:{title:"JSON Editor",description:"Stores an editable JSON value with a structured editor interface.",category:"Value"},extends_:["thing:_base","thing:_bordered"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:400,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:300,min:10},{name:"value",type:"JsonValue",description:"JSON value (object, array, etc.)",category:"Value",default:{stationId:"ESSA",stationname:"Stockholm Arlanda",temperature:-2.5,isOperational:!0,precipitation:.8,lastMaintenance:null,sensors:["temp","wind","humidity","snow"],location:{latitude:59.6497,longitude:17.9237,elevation:42}}}],methods:[]},"thing:label":{metadata:{title:"Text Label",description:"Stores a non-editable text value.",category:"Value"},extends_:["thing:_base","thing:_bordered","thing:_styledtext"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:20,min:10},{name:"borderWidth",type:"number",description:"Border width in pixels",category:"Appearance",default:0,min:0},{name:"alignVertical",type:"AlignVertical",description:"Text vertical alignment",category:"Text",format:"align-vertical",default:"top",enum:["top","middle","bottom"]},{name:"value",type:"string",description:"Label text",category:"Value",default:"Label"}],methods:[]},"thing:line":{metadata:{title:"Line",description:"Simple line.",category:"Shape"},extends_:["thing:_base"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:100,min:1},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:100,min:1},{name:"strokeColor",type:"string",description:"Line stroke color",format:"color",default:"#000000"},{name:"strokeWidth",type:"number",description:"Line stroke width in pixels",default:2,min:1}],methods:[]},"thing:markdown":{metadata:{title:"Text Markdown",description:"",category:"Value"},extends_:["thing:_base"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:512,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:384,min:10},{name:"value",type:"string",description:"Text value in Markdown format",category:"Value",default:`# Hello World

This is a **bold** and *italic* text with \`code\`.

## Lists
* Item 1
* Item 2
  * Nested item
1. Ordered item 1
2. Ordered item 2

## Code Block
\`\`\`typescript
interface Example {
  name: string;
  value: number;
}
\`\`\`

## Table
| Header 1 | Header 2 |
|:---------|:--------:|
| Cell 1   | Cell 2   |
| Cell 3   | Cell 4   |

> This is a blockquote

[Link](https://example.com)
![Image](https://upload.wikimedia.org/wikipedia/commons/a/a9/Example.jpg)

---
`}],methods:[]},"thing:number":{metadata:{title:"Number Field",description:"Stores an editable number value. Can be used as form input (`isFormInput` returns true).",category:"Value"},extends_:["thing:_base","thing:_bordered","thing:_styledtext"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:24,min:10},{name:"value",type:"number",description:"Number value",category:"Value",default:0},{name:"min",type:"number",description:"Mininum value",category:"Value",optional:!0},{name:"max",type:"number",description:"Maximum value",category:"Value",optional:!0},{name:"step",type:"number",description:"Number value",category:"Value",optional:!0},{name:"enabled",type:"boolean",description:"Whether the number field is currently enabled/clickable",default:!0}],methods:[{name:"randomize",description:"Sets `value` to a random number between the `min` and `max` values, inclusive. If `min` and `max` are not set, defaults to 0 and 100, respectively.",parameters:[]}]},"thing:participant":{metadata:{title:"Participant",description:"Represents a participant with an avatar and editable display name.",category:"System"},extends_:["thing:_base","thing:_bordered"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:220,min:40},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:40,min:40},{name:"participantId",type:"string",description:"Unique identifier",category:"Data",readonly:!0},{name:"value",type:"string",description:"Display name",category:"Data",readonly:!0},{name:"avatarColor",type:"string",description:"Avatar color",category:"Data",format:"color",readonly:!0}],methods:[]},"thing:range":{metadata:{title:"Number Slider",description:"Stores a number value, settable through a graphical interface. Can be used as form input (`isFormInput` returns true).",category:"Value"},extends_:["thing:_base"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:20,min:10},{name:"value",type:"number",description:"Number value",category:"Value",default:50},{name:"min",type:"number",description:"Mininum value",category:"Value",default:0},{name:"max",type:"number",description:"Maximum value",category:"Value",default:100},{name:"step",type:"number",description:"Number value",category:"Value",optional:!0},{name:"enabled",type:"boolean",description:"Whether the range input is currently enabled/clickable",default:!0},{name:"whenChanged",type:"string",description:"JavaScript code to execute when value is changed",format:"code-js"}],methods:[]},"thing:_bordered":{metadata:{description:""},extends_:[],properties:[{name:"borderColor",type:"string",description:"Border color",category:"Appearance",format:"color",default:"#000000"},{name:"borderWidth",type:"number",description:"Border width in pixels",category:"Appearance",default:2,min:0},{name:"borderRadius",type:"number",description:"Border radius in pixels",category:"Appearance",default:0,min:0},{name:"backgroundColor",type:"string",description:"Background color",category:"Appearance",format:"color",default:"#ffffff"},{name:"opacity",type:"number",description:"Opacity",category:"Appearance",default:100,min:0,max:100}]},"thing:_styledtext":{metadata:{description:""},extends_:[],properties:[{name:"fontFamily",type:"FontFamily",description:"Text font family name",category:"Text",format:"font-family",default:"sans-serif",enum:["sans-serif","serif","monospace","cursive","fantasy"]},{name:"fontSize",type:"number",description:"Text font size in pixels",category:"Text",format:"font-family",default:16,min:1},{name:"textColor",type:"string",description:"Text color",category:"Text",format:"color",default:"#000000"},{name:"alignHorizontal",type:"AlignHorizontal",description:"Text horizontal alignment",category:"Text",format:"align-horizontal",default:"left",enum:["left","center","right"]}]},"thing:text":{metadata:{title:"Text Field",description:"Stores an editable text value. Can be used as form input (`isFormInput` returns true).",category:"Value",icon:"input-cursor-text"},extends_:["thing:_base","thing:_bordered","thing:_styledtext"],properties:[{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:24,min:10},{name:"value",type:"string",description:"Text value",category:"Value",default:"Text"},{name:"allowsMultipleLines",type:"boolean",description:"Allows multiple lines",default:!1},{name:"enabled",type:"boolean",description:"Whether the text field is currently enabled/clickable",default:!0}],methods:[]},"thing:timer":{metadata:{title:"Timer",description:"",category:"Interaction"},extends_:["thing:_base","thing:_bordered"],properties:[{name:"width",type:"number",description:"Width in pixels",category:"Layout",default:40,min:10},{name:"height",type:"number",description:"Height in pixels",category:"Layout",default:40,min:10},{name:"duration",type:"number",description:"Duration in seconds",category:"Timer",default:10},{name:"repeats",type:"boolean",description:"Repeat after completion",category:"Timer",default:!1},{name:"whenComplete",type:"string",description:"JavaScript code to execute when timer fires",category:"Timer",format:"code-js",default:'alert("Timer complete!")'}],methods:[{name:"start",description:"Starts or resumes the timer countdown. When the timer reaches zero, it will execute the whenComplete script. If the repeats flag is set, the timer will automatically restart.",parameters:[]},{name:"pause",description:"Pauses the timer countdown at its current value. The timer can be resumed from this point using start().",parameters:[]},{name:"toggle",description:"Toggles the timer between running and paused states.",parameters:[]},{name:"stop",description:"Stops the timer and resets to initial duration",parameters:[]},{name:"fire",description:"Immediately triggers the timer completion script If repeats is true, the timer will restart after firing.",parameters:[]}]}};function fr(s){return rh[s]}function Bn(s,t=!0){const e=fr(s);if(!e)return{};let n=[];if(e.extends_&&t)for(let i of e.extends_){const r=fr(i);r!=null&&r.properties&&n.push(...r.properties)}return e.properties&&n.push(...e.properties),Object.fromEntries(n.map(i=>[i.name,i]))}const oh=new Set(["Math","Object","Array","String","Number","Boolean","Date","RegExp","JSON","Promise","Error","console","window","document"]);function ea(s){try{new Function("return "+s),s=s.replace(/'[^']*'|"[^"]*"|`[^`]*`/g,"");const t=s.match(new RegExp("(?<!\\.)(?<!\\.\\s)\\b[a-zA-Z$_][a-zA-Z0-9$_]*\\b","g"))||[];return[...new Set(t)].filter(e=>!oh.has(e))}catch{return[]}}var ms,ge,me;const Vo=class Vo extends HTMLElement{constructor(){super();y(this,ms);y(this,ge);y(this,me);this.addEventListener("dblclick",e=>{this.classList.contains("editing")||(e.stopPropagation(),M.getInstance().emit("editing",{id:this.id}))})}setThing(e){this.id=e.id,w(this,ms,new WeakRef(e))}getThing(){var e;return(e=o(this,ms))==null?void 0:e.deref()}connectedCallback(){this.contentElement||(this.style.position="absolute",this.style.display="flex",this.style.boxSizing="border-box",this.contentElement=this.createContentElement(),this.contentElement.className="thing-content",this.contentElement.style.width="100%",this.contentElement.style.height="100%",this.contentElement.style.boxSizing="border-box",this.appendChild(this.contentElement),w(this,ge,document.createElement("div")),o(this,ge).className="thing-name",o(this,ge).textContent=this.getThing().name,this.appendChild(o(this,ge)),w(this,me,document.createElement("div")),o(this,me).className="thing-status",this.appendChild(o(this,me)))}applyData(e){e.name&&(this.setAttribute("name",e.name),o(this,ge).textContent=e.name),e.x!==void 0&&(this.style.left=`${e.x}px`),e.y!==void 0&&(this.style.top=`${e.y}px`),e.width!==void 0&&(this.style.width=`${e.width}px`),e.height!==void 0&&(this.style.height=`${e.height}px`),e.visible!==void 0&&this.classList.toggle("thing-hidden",!e.visible)}needsDisplay(){this.displayErrorText(void 0);const e=this.getThing().getDisplayData();this.applyData(e)}displayErrorText(e){e?o(this,me).textContent=`❌ ${e}`:o(this,me).textContent=""}};ms=new WeakMap,ge=new WeakMap,me=new WeakMap,Vo.SHAPE="rect";let V=Vo;var mt,Ue,ys,pr;class Q{constructor(t,e,n){y(this,ys);y(this,mt);y(this,Ue);this.element=t,w(this,mt,structuredClone(e)),w(this,Ue,n);const i=Bn(e.type);if(Object.entries(i).length===0)throw new Error(`No properties found for thing type ${e.type}`);for(const[r,a]of Object.entries(i))Object.defineProperty(this,r,{get(){return this.getSlotDisplayValue(r)},...!a.readonly&&{set(l){this.setSlotValue(r,l)}},enumerable:!0,configurable:!0}),Object.defineProperty(this,r+"$",{get(){return this.getSlotFormula(r)},...(!a.readonly||!a.disallowFormula)&&{set(l){this.setSlotFormula(r,l)}},enumerable:!0,configurable:!0});t.setThing(this)}static getThingInfo(){const t=fr(this.TYPE),e=Bn(this.TYPE),n=t.methods||[],i=Object.fromEntries(n.map(r=>[r.name,r]));return{metadata:t.metadata,propertiesRecord:e,methodsRecord:i}}getThingInfo(){return this.constructor.getThingInfo()}getSlotDisplayValue(t){const e=o(this,mt)[t],n=m(this,ys,pr).call(this,e);if(n)try{const i=`return ${n}`;return o(this,Ue).eval(i,this,this)}catch(i){this.setError(i);return}else return e}getSlotValue(t){const e=o(this,mt)[t];if(!e.startsWith("="))return e}getSlotFormula(t){const e=o(this,mt)[t];return m(this,ys,pr).call(this,e)}setSlotValue(t,e){this.saveChangeToStore(t,e)}setSlotFormula(t,e){const n=e!==void 0?"="+e:"";this.setSlotValue(t,n)}getDisplayData(){const t={};for(const e of Object.keys(o(this,mt)))t[e]=this.getSlotDisplayValue(e);return t}saveChangeToStore(t,e){o(this,Ue).updateThing(this.id,{[t]:e})}_setRawData(t){w(this,mt,structuredClone(t))}getRawData(){return o(this,mt)}toJSON(){return o(this,mt)}setError(t){this.element.displayErrorText(t?String(t):void 0)}findReferencedSymbols(){const t=[],e=Bn(this.type);for(const[n,i]of Object.entries(e)){if(i.type==="code-js"){const a=o(this,mt)[n];if(a){const l=ea(a);t.push(...l)}}const r=this.getSlotFormula(n);if(r){const a=ea(r);t.push(...a)}}return t}teardown(){this.element.remove(),w(this,Ue,{})}}mt=new WeakMap,Ue=new WeakMap,ys=new WeakSet,pr=function(t){return typeof t=="string"&&t.startsWith("=")?t.slice(1):void 0};function Dt(s,t){t.borderColor!==void 0&&(s.style.borderColor=t.borderColor),t.borderWidth!==void 0&&(s.style.borderWidth=`${t.borderWidth}px`,s.style.borderStyle=t.borderWidth>0?"solid":"none"),t.borderRadius!==void 0&&(s.style.borderRadius=`${t.borderRadius}px`),t.backgroundColor!==void 0&&(s.style.backgroundColor=t.backgroundColor),t.opacity!==void 0&&(s.style.opacity=`${t.opacity}%`)}function Gs(s,t){t.alignHorizontal!==void 0&&(s.style.textAlign=t.alignHorizontal),t.fontFamily!==void 0&&(s.style.fontFamily=t.fontFamily),t.fontSize!==void 0&&(s.style.fontSize=`${t.fontSize}px`),t.textColor!==void 0&&(s.style.color=t.textColor)}const Da="button";var st;const Fo=class Fo extends V{constructor(){super(...arguments);y(this,st)}createContentElement(){const e=document.createElement("button");return e.addEventListener("click",()=>{this.getThing().click()}),w(this,st,e),e}applyData(e){super.applyData(e),Dt(o(this,st),e),Gs(o(this,st),e),e.title!==void 0&&(o(this,st).textContent=e.title),e.enabled!==void 0&&(o(this,st).disabled=!e.enabled,o(this,st).style.opacity=e.enabled?"1.0":"0.2")}isFieldEditor(){return!0}beginEditing(){o(this,st).contentEditable="plaintext-only";const e=document.createRange();e.selectNodeContents(o(this,st));const n=window.getSelection();n==null||n.removeAllRanges(),n==null||n.addRange(e)}getEditableData(){return{title:o(this,st).textContent||""}}endEditing(){var e;(e=window.getSelection())==null||e.removeAllRanges(),o(this,st).contentEditable="false",o(this,st).blur()}};st=new WeakMap,Fo.TAG_NAME=`ahoy-${Da}`;let gi=Fo;const Yn=class Yn extends Q{constructor(t,e){const n=document.createElement(gi.TAG_NAME);super(n,t,e)}click(){try{return C.getInstance().eval(this.whenClicked,this)}catch(t){this.setError(t)}}};Yn.NAME="Button",Yn.TYPE=`thing:${Da}`,Yn.ELEMENT_CLASS=gi;let gr=Yn;const Ta="checkbox";var Ve,Lt;const Po=class Po extends V{constructor(){super(...arguments);y(this,Ve);y(this,Lt)}createContentElement(){this.style.alignItems="center";const e=document.createElement("div"),n=document.createElement("input");n.type="checkbox",n.id=`${this.id}-checkbox`,n.addEventListener("change",()=>{this.getThing().saveChangeToStore("value",n.checked)}),w(this,Ve,n);const i=document.createElement("label");return i.htmlFor=n.id,w(this,Lt,i),e.appendChild(n),e.appendChild(i),e}applyData(e){super.applyData(e),e.value!==void 0&&(o(this,Ve).checked=e.value),e.enabled!==void 0&&(o(this,Ve).disabled=!e.enabled),e.title!==void 0&&(o(this,Lt).textContent=e.title)}isFieldEditor(){return!0}beginEditing(){o(this,Lt).contentEditable="plaintext-only";const e=document.createRange();e.selectNodeContents(o(this,Lt));const n=window.getSelection();n==null||n.removeAllRanges(),n==null||n.addRange(e)}getEditableData(){return{value:o(this,Ve).checked,title:o(this,Lt).textContent||""}}endEditing(){var e;(e=window.getSelection())==null||e.removeAllRanges(),o(this,Lt).contentEditable="false",o(this,Lt).blur()}};Ve=new WeakMap,Lt=new WeakMap,Po.TAG_NAME=`ahoy-${Ta}`;let mi=Po;const Gn=class Gn extends Q{constructor(t,e){const n=document.createElement(mi.TAG_NAME);super(n,t,e)}get isFormInput(){return!0}};Gn.NAME="Boolean Checkbox",Gn.TYPE=`thing:${Ta}`,Gn.ELEMENT_CLASS=mi;let mr=Gn;const Ne={NEW_ITEM:"New Item",ITEMS:"items",PROPERTIES:"properties",EXPAND:"Expand",COLLAPSE:"Collapse",ADD_ITEM:"Add Item",REMOVE_ITEM:"Remove Item",KEY:"Key",TYPE:"Type",VALUE:"Value"},La=document.createElement("template");La.innerHTML=`
  <style>
    table {
      width: 100%;
      text-align: left;
      border-collapse: collapse;
      border: 1px solid rgba(0, 0, 0, 0.5);
    }
    thead {
      background-color: #efefef;
    }
    tr {
      border: 1px solid #efefef;
    }

    th, td {
      position: relative;
      border-left: 1px solid rgba(0, 0, 0, 0.5);
      padding: 0 4px;
      font-size: small;
    }
    td:first-child, th:first-child {
      border-left: none;
    }

    th:first-child {
      width: 30%;
    }
    th:nth-child(2) {
      width: 72px;
    }
    th:last-child {
      width: 28px;
    }

    .keyCell {
      display: flex;
      align-items: center;
    }

    /* Expand/collapse */
    .expand-btn {
      cursor: pointer;
      width: 1em;
    }
    .expand-btn::after {
      content: "▶";
    }
    tr:not(.collapsed) > td .expand-btn::after {
      content: "▼";
    }
    tr.hidden {
      display: none;
    }

    input:not([type="checkbox"]), select {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid transparent;
      border-radius: 2px;    
      display: block; // needed for vertical alignment
    }

    /* Readonly state */
    :host([readonly]) {
      th:last-child,
      td:last-child {
        display: none;
      }

      input[readonly] {
        outline: none;
      }
      select[disabled] {
        /* Remove dropdown arrow */
        -moz-appearance: none;
        -webkit-appearance: none;
      }
    }
      
    /* Interactive/editable state */
    :host(:not([readonly])) {
      tr:hover {
        background-color: #f5f5f5;
      }

      .resize-handle {
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        cursor: col-resize;
      }
      .resize-handle:hover {
        background-color: #0001;
      }
      .resize-handle.resizing {
        background-color: #0004;
      }

      .action-btn {
        cursor: pointer;
        font-size: small;
        opacity: 0.5;
      }
      .action-btn:hover {
        opacity: 1.0;
      }
      .action-btn-remove {
        float: right;
      }

      input:not([type="checkbox"]):hover, select:hover {
        border: 1px solid black;
      }
    }
  </style>
  <table>
    <thead>
      <tr>
        <th>${Ne.KEY}<div class="resize-handle"></div></th>
        <th>${Ne.TYPE}<div class="resize-handle"></div></th>
        <th>${Ne.VALUE}<div class="resize-handle"></div></th>
        <th></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
`;var yt,Fe,ws,it,v,Me,Ma,yr,rn,wr,ii,ri,on,ue,Oa,br,Na,Ra,$a,Er;class ah extends HTMLElement{constructor(){super();y(this,v);y(this,yt);y(this,Fe,new Set);y(this,ws,0);y(this,it,null);this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(La.content.cloneNode(!0)),w(this,yt,this.shadowRoot.querySelector("tbody")),m(this,v,Ma).call(this)}get value(){return o(this,it)}set value(e){w(this,it,e),this.render(),m(this,v,Me).call(this)}static get observedAttributes(){return["value","readonly"]}get readonly(){return this.hasAttribute("readonly")}set readonly(e){e?this.setAttribute("readonly",""):this.removeAttribute("readonly")}attributeChangedCallback(e,n,i){if(e==="value")try{w(this,it,JSON.parse(i)),this.render()}catch(r){console.error("Invalid JSON value:",r)}else e==="readonly"&&this.render()}render(){o(this,yt).innerHTML="",w(this,ws,0);const e=m(this,v,ii).call(this,"root",o(this,it));o(this,yt).appendChild(e),m(this,v,ri).call(this,"root",o(this,it),1,"0")}}yt=new WeakMap,Fe=new WeakMap,ws=new WeakMap,it=new WeakMap,v=new WeakSet,Me=function(){this.dispatchEvent(new CustomEvent("change",{detail:{value:o(this,it)}}))},Ma=function(){const e=(n,i)=>{var c;const r={element:n,initialX:i.clientX,initialWidth:n.offsetWidth},a=h=>{const d=parseInt(r.element.dataset.minWidth||"50",10),u=Math.max(r.initialWidth+(h.clientX-r.initialX),d);r.element.style.width=`${u}px`},l=()=>{var h;(h=r.element.querySelector(".resize-handle"))==null||h.classList.remove("resizing"),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};(c=n.querySelector(".resize-handle"))==null||c.classList.add("resizing"),document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)};this.shadowRoot.querySelectorAll("th").forEach(n=>{var i;(i=n.querySelector(".resize-handle"))==null||i.addEventListener("mousedown",r=>e(n,r))})},yr=function(e,n){let i=e;for(;i;){const r=i.getAttribute("parent-id");if(r===n)return!0;if(i=o(this,yt).querySelector(`tr[node-id="${r}"]`),!i)break}return!1},rn=function(e){return Array.isArray(e)?"array":e===null?"null":typeof e},wr=function(e){let n=e;for(;n;){const i=n.getAttribute("parent-id");if(!i)break;const r=o(this,yt).querySelector(`tr[node-id="${i}"]`);if(!r)break;if(r.classList.contains("collapsed"))return!0;n=r}return!1},ii=function(e,n,i=0,r){const a=document.createElement("tr"),l=m(this,v,rn).call(this,n),c=l==="array"||l==="object";a.setAttribute("key",e.toString()),a.setAttribute("depth",i.toString());const h=c?(Qi(this,ws)._++).toString():void 0;h&&(a.setAttribute("node-id",h),a.setAttribute("collapsible",""),o(this,Fe).has(h)&&a.classList.add("collapsed")),r&&(a.setAttribute("parent-id",r),m(this,v,wr).call(this,a)&&a.classList.add("hidden"));const d=document.createElement("td");if(d.className="keyCell",d.style.paddingLeft=`${i*20}px`,c){const b=document.createElement("span");b.className="expand-btn",b.onclick=()=>{a.classList.contains("collapsed")?(a.classList.remove("collapsed"),o(this,Fe).delete(h),Array.from(a.parentElement.children).forEach(x=>{m(this,v,yr).call(this,x,h)&&(m(this,v,wr).call(this,x)||x.classList.remove("hidden"))})):(a.classList.add("collapsed"),o(this,Fe).add(h),Array.from(a.parentElement.children).forEach(x=>{m(this,v,yr).call(this,x,h)&&x.classList.add("hidden")}))},d.appendChild(b)}if(typeof e=="number")d.appendChild(document.createTextNode(e.toString()));else{const b=document.createElement("input");b.value=e,b.readOnly=this.readonly,this.readonly||(b.onchange=E=>m(this,v,Ra).call(this,a,E.target.value)),d.appendChild(b)}a.appendChild(d);const u=document.createElement("td"),f=document.createElement("select");["boolean","number","string","null","array","object"].forEach(b=>{const E=document.createElement("option");E.value=b,E.textContent=b,E.selected=b===l,f.appendChild(E)}),f.disabled=this.readonly,this.readonly||(f.onchange=b=>m(this,v,$a).call(this,a,b.target.value)),u.appendChild(f),a.appendChild(u);const p=document.createElement("td");switch(l){case"boolean":const b=document.createElement("input");b.type="checkbox",b.checked=n,b.disabled=this.readonly,this.readonly||(b.onchange=x=>m(this,v,Er).call(this,a,x.target.checked)),p.appendChild(b);break;case"number":case"string":const E=document.createElement("input");E.type=l==="number"?"number":"text",E.value=n,E.readOnly=this.readonly,this.readonly||(E.onchange=x=>m(this,v,Er).call(this,a,l==="number"?Number(x.target.value):x.target.value)),p.appendChild(E);break;case"array":p.textContent=`(${n.length} ${Ne.ITEMS})`;break;case"object":p.textContent=`(${Object.keys(n).length} ${Ne.PROPERTIES})`;break;case"null":p.textContent="null";break}a.appendChild(p);const g=document.createElement("td");if(c){const b=document.createElement("span");b.textContent="➕",b.classList.add("action-btn","action-btn-add"),b.onclick=()=>m(this,v,Oa).call(this,a),g.appendChild(b)}if(i>0){const b=document.createElement("span");b.textContent="➖",b.classList.add("action-btn","action-btn-remove"),b.onclick=()=>m(this,v,Na).call(this,a),g.appendChild(b)}return a.appendChild(g),a},ri=function(e,n,i,r){Array.isArray(n)?n.forEach((a,l)=>{const c=m(this,v,ii).call(this,l,a,i,r);if(o(this,yt).appendChild(c),m(this,v,rn).call(this,a)==="array"||m(this,v,rn).call(this,a)==="object"){const h=c.getAttribute("node-id");h&&m(this,v,ri).call(this,l,a,i+1,h)}}):typeof n=="object"&&n!==null&&Object.entries(n).forEach(([a,l])=>{const c=m(this,v,ii).call(this,a,l,i,r);if(o(this,yt).appendChild(c),m(this,v,rn).call(this,l)==="array"||m(this,v,rn).call(this,l)==="object"){const h=c.getAttribute("node-id");h&&m(this,v,ri).call(this,a,l,i+1,h)}})},on=function(e){const n=[];let i=e;for(;i&&!i.matches("tbody");){const r=i.getAttribute("key");if(r==="root")break;n.unshift(r);const a=i.getAttribute("parent-id");i=a?o(this,yt).querySelector(`tr[node-id="${a}"]`):i.parentElement}return n},ue=function(e){return e.length===0?o(this,it):e.reduce((n,i)=>{if(n&&typeof n=="object")return n[i]},o(this,it))},Oa=function(e){const n=m(this,v,on).call(this,e),i=m(this,v,ue).call(this,n);Array.isArray(i)?i.push(""):typeof i=="object"&&i!==null&&(i[Ne.NEW_ITEM]=""),this.render(),m(this,v,Me).call(this)},br=function(e){o(this,Fe).delete(e),Array.from(o(this,yt).querySelectorAll(`tr[parent-id="${e}"]`)).forEach(i=>{const r=i.getAttribute("node-id");r&&m(this,v,br).call(this,r)})},Na=function(e){const n=e.getAttribute("node-id");n&&m(this,v,br).call(this,n);const i=m(this,v,on).call(this,e);if(i.length===0)return;const r=i.slice(0,-1),a=i[i.length-1],l=r.length===0?o(this,it):m(this,v,ue).call(this,r);Array.isArray(l)?l.splice(a,1):l&&typeof l=="object"&&delete l[a],this.render(),m(this,v,Me).call(this)},Ra=function(e,n){const i=m(this,v,on).call(this,e);if(i.length===0)return;const r=i[i.length-1];if(typeof r=="string"&&r!==n){const a=i.slice(0,-1),l=m(this,v,ue).call(this,a),c=m(this,v,ue).call(this,i);l&&typeof l=="object"&&(delete l[r],l[n]=c,e.setAttribute("key",n),this.render(),m(this,v,Me).call(this))}},$a=function(e,n){const i=m(this,v,on).call(this,e);if(i.length===0)return;const r=m(this,v,ue).call(this,i);let a;switch(n){case"boolean":a=!!r;break;case"number":a=Number(r)||0;break;case"string":a=String(r);break;case"null":a=null;break;case"array":a=Array.isArray(r)?r:[r];break;case"object":a=typeof r=="object"&&r!==null?r:{[Ne.NEW_ITEM]:r};break}const l=i.slice(0,-1),c=i[i.length-1],h=l.length===0?o(this,it):m(this,v,ue).call(this,l);h&&typeof h=="object"&&(h[c]=a,this.render(),m(this,v,Me).call(this))},Er=function(e,n){const i=m(this,v,on).call(this,e);if(i.length===0)return;const r=i.slice(0,-1),a=i[i.length-1],l=r.length===0?o(this,it):m(this,v,ue).call(this,r);l&&typeof l=="object"&&(l[a]=n,this.render(),m(this,v,Me).call(this))};customElements.define("json-editor",ah);const Ua="data";var Pe;const Ho=class Ho extends V{constructor(){super(...arguments);y(this,Pe)}createContentElement(){const e=document.createElement("json-editor");return e.style.overflow="auto",w(this,Pe,e),e}applyData(e){super.applyData(e),Dt(o(this,Pe),e),e.value!==void 0&&(o(this,Pe).value=e.value)}isFieldEditor(){return!1}beginEditing(){}getEditableData(){return{value:o(this,Pe).value}}endEditing(){}};Pe=new WeakMap,Ho.TAG_NAME=`ahoy-${Ua}`;let yi=Ho;const Jn=class Jn extends Q{constructor(t,e){const n=document.createElement(yi.TAG_NAME);super(n,t,e)}};Jn.NAME="JSON Editor",Jn.TYPE=`thing:${Ua}`,Jn.ELEMENT_CLASS=yi;let vr=Jn;const Va="datetime";var wt;const Bo=class Bo extends V{constructor(){super(...arguments);y(this,wt)}createContentElement(){const e=document.createElement("input");return e.type="datetime-local",e.addEventListener("input",()=>{this.getThing().saveChangeToStore("value",e.value)}),w(this,wt,e),e}applyData(e){super.applyData(e),Dt(o(this,wt),e),Gs(o(this,wt),e),e.value!==void 0&&(o(this,wt).value=e.value),e.enabled!==void 0&&(o(this,wt).disabled=!e.enabled)}isFieldEditor(){return!0}beginEditing(){o(this,wt).focus(),o(this,wt).select()}getEditableData(){return{value:o(this,wt).value}}endEditing(){o(this,wt).blur()}};wt=new WeakMap,Bo.TAG_NAME=`ahoy-${Va}`;let wi=Bo;const cn=class cn extends Q{constructor(t,e){t.value=new Date().toLocaleString("sv").replace(" ","T");const n=document.createElement(wi.TAG_NAME);super(n,t,e)}get isFormInput(){return!0}static now(){return new Date().toLocaleString("sv").replace(" ","T")}setValueToNow(){this.value=cn.now()}getFormattedValue(t="medium",e="medium"){const n=Date.parse(this.value),i={};return t!=="none"&&(i.dateStyle=t),e!=="none"&&(i.timeStyle=e),new Intl.DateTimeFormat(void 0,i).format(n)}};cn.NAME="Date/Time Field",cn.TYPE=`thing:${Va}`,cn.ELEMENT_CLASS=wi;let Sr=cn;const Fa="frame";var bs;const zo=class zo extends V{constructor(){super(...arguments);y(this,bs)}createContentElement(){const e=document.createElement("div");return e.style.position="relative",e.style.overflow="clip",e.style.borderWidth="1px",e.style.borderStyle="solid",w(this,bs,e),e}applyData(e){super.applyData(e),Dt(o(this,bs),e)}};bs=new WeakMap,zo.TAG_NAME=`ahoy-${Fa}`;let bi=zo;const qn=class qn extends Q{constructor(t,e){const n=document.createElement(bi.TAG_NAME);super(n,t,e)}};qn.NAME="Frame",qn.TYPE=`thing:${Fa}`,qn.ELEMENT_CLASS=bi;let kr=qn;const Pa="label";var ht;const jo=class jo extends V{constructor(){super(...arguments);y(this,ht)}createContentElement(){const e=document.createElement("div");return w(this,ht,e),o(this,ht)}connectedCallback(){super.connectedCallback(),o(this,ht).style.height="auto"}applyData(e){if(super.applyData(e),Dt(this,e),Gs(o(this,ht),e),e.alignVertical!==void 0)switch(e.alignVertical){case"top":this.style.alignItems="flex-start";break;case"middle":this.style.alignItems="center";break;case"bottom":this.style.alignItems="flex-end";break}e.value!==void 0&&(o(this,ht).textContent=e.value)}isFieldEditor(){return!0}beginEditing(){o(this,ht).contentEditable="plaintext-only";const e=document.createRange();e.selectNodeContents(o(this,ht));const n=window.getSelection();n==null||n.removeAllRanges(),n==null||n.addRange(e)}getEditableData(){return{value:o(this,ht).textContent||""}}endEditing(){var e;(e=window.getSelection())==null||e.removeAllRanges(),o(this,ht).contentEditable="false",o(this,ht).blur()}};ht=new WeakMap,jo.TAG_NAME=`ahoy-${Pa}`;let Ei=jo;const Kn=class Kn extends Q{constructor(t,e){const n=document.createElement(Ei.TAG_NAME);super(n,t,e)}};Kn.NAME="Text Label",Kn.TYPE=`thing:${Pa}`,Kn.ELEMENT_CLASS=Ei;let xr=Kn;const Ha="line";var z;const Hi=class Hi extends V{constructor(){super(...arguments);y(this,z)}createContentElement(){const e=document.createElement("div");e.style.position="relative";const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.style.width="100%",n.style.height="100%",n.style.position="absolute",n.style.inset="0",n.setAttribute("preserveAspectRatio","none");const i=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttribute("vector-effect","non-scaling-stroke"),w(this,z,i),n.appendChild(i),e.appendChild(n),e}applyData(e){if(super.applyData(e),e.width!==void 0||e.height!==void 0){const n=parseInt(this.style.width),i=parseInt(this.style.height),r=parseInt(o(this,z).getAttribute("stroke-width")||"2");n<=r?(o(this,z).setAttribute("x1","50%"),o(this,z).setAttribute("x2","50%"),o(this,z).setAttribute("y1","0"),o(this,z).setAttribute("y2","100%")):i<=r?(o(this,z).setAttribute("x1","0"),o(this,z).setAttribute("x2","100%"),o(this,z).setAttribute("y1","50%"),o(this,z).setAttribute("y2","50%")):(o(this,z).setAttribute("x1","0"),o(this,z).setAttribute("x2","100%"),o(this,z).setAttribute("y1","0"),o(this,z).setAttribute("y2","100%"))}e.strokeColor!==void 0&&o(this,z).setAttribute("stroke",e.strokeColor),e.strokeWidth!==void 0&&o(this,z).setAttribute("stroke-width",e.strokeWidth.toString())}};z=new WeakMap,Hi.TAG_NAME=`ahoy-${Ha}`,Hi.SHAPE="line";let vi=Hi;const Xn=class Xn extends Q{constructor(t,e){const n=document.createElement(vi.TAG_NAME);super(n,t,e)}};Xn.NAME="Line",Xn.TYPE=`thing:${Ha}`,Xn.ELEMENT_CLASS=vi;let Cr=Xn;const Ba="markdown";var ye,rt,He;const Wo=class Wo extends V{constructor(){super(...arguments);y(this,ye);y(this,rt);y(this,He,"")}createContentElement(){const e=document.createElement("div");e.style.position="relative",e.style.backgroundColor="#ffffff",e.style.height="100%";const n=document.createElement("div");n.className="markdown-preview",n.style.height="100%",n.style.width="100%",n.style.padding="1em",n.style.boxSizing="border-box",n.style.overflow="auto",w(this,ye,n);const i=document.createElement("textarea");return i.className="markdown-editor",i.style.position="absolute",i.style.top="0",i.style.left="0",i.style.height="100%",i.style.width="100%",i.style.padding="1em",i.style.boxSizing="border-box",i.style.resize="none",i.style.display="none",i.addEventListener("input",()=>{this.getThing().saveChangeToStore("value",i.value)}),w(this,rt,i),e.appendChild(o(this,ye)),e.appendChild(o(this,rt)),e}applyData(e){if(super.applyData(e),e.value!==void 0){w(this,He,e.value),o(this,rt).value=e.value;const i=new lh().toHtml(o(this,He));o(this,ye).innerHTML=i}}isFieldEditor(){return!1}beginEditing(){o(this,ye).style.display="none",o(this,rt).style.display="block",o(this,rt).value=o(this,He),o(this,rt).focus(),o(this,rt).setSelectionRange(0,0),o(this,rt).scrollTo({left:0,top:0})}getEditableData(){return{value:o(this,rt).value||""}}endEditing(){o(this,rt).style.display="none",o(this,ye).style.display="block",w(this,He,o(this,rt).value||"")}};ye=new WeakMap,rt=new WeakMap,He=new WeakMap,Wo.TAG_NAME=`ahoy-${Ba}`;let Si=Wo;const Zn=class Zn extends Q{constructor(t,e){const n=document.createElement(Si.TAG_NAME);super(n,t,e)}};Zn.NAME="Text Markdown",Zn.TYPE=`thing:${Ba}`,Zn.ELEMENT_CLASS=Si;let Ir=Zn;class lh{cleanText(t){return t.replace(/\r\n/g,`
`).trim()}parseInlineElements(t){return t=t.replace(/`([^`]+)`/g,"<code>$1</code>"),t=t.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__([^_]+)__/g,"<strong>$1</strong>"),t=t.replace(/\*([^*]+)\*/g,"<em>$1</em>"),t=t.replace(/_([^_]+)_/g,"<em>$1</em>"),t=t.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,'<img src="$2" alt="$1">'),t=t.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>'),t}escapeHtml(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,n=>e[n])}parseList(t,e){function n(u,f){const p=f?"ol":"ul";let g=`<${p}>
`;for(const b of u){if(g+=`<li>${b.content}`,b.children.length>0){const E=b.children.filter(Le=>Le.isOrdered),x=b.children.filter(Le=>!Le.isOrdered);E.length>0&&(g+=n(E,!0)),x.length>0&&(g+=n(x,!1))}g+=`</li>
`}return g+=`</${p}>
`,g}const i=[];let r=e,a=0,l=null;for(;r<t.length;){const f=t[r].match(/^(\s*)([-*]|\d+\.)\s(.+)/);if(!f)break;const[,p,g,b]=f,E=p.length,x=/\d+\./.test(g),sn={content:this.parseInlineElements(b),indentLevel:E,isOrdered:x,children:[]};E>a&&l?l.children.push(sn):(i.push(sn),l=sn,a=E),r++}const c=i.filter(u=>u.isOrdered),h=i.filter(u=>!u.isOrdered);let d="";return h.length>0&&(d+=n(h,!1)),c.length>0&&(d+=n(c,!0)),[d,r]}parseCodeBlock(t){let e=[],n=1;for(;n<t.length&&!t[n].startsWith("```");)e.push(t[n]),n++;const i=t[0].slice(3).trim(),r=this.escapeHtml(e.join(`
`));return[`<pre><code${i?` class="language-${i}"`:""}>${r}</code></pre>`,n+1]}parseTable(t){let e=0;const n=t[e].split("|").filter(a=>a.trim());e++;const i=t[e].split("|").filter(a=>a.trim()).map(a=>(a=a.trim(),a.startsWith(":")&&a.endsWith(":")?"center":a.endsWith(":")?"right":"left"));e++;let r=`<table>
<thead>
<tr>
`;for(n.forEach((a,l)=>{r+=`<th align="${i[l]}">${this.parseInlineElements(a.trim())}</th>
`}),r+=`</tr>
</thead>
<tbody>
`;e<t.length&&t[e].includes("|");){const a=t[e].split("|").filter(l=>l.trim());if(a.length===0)break;r+=`<tr>
`,a.forEach((l,c)=>{r+=`<td align="${i[c]}">${this.parseInlineElements(l.trim())}</td>
`}),r+=`</tr>
`,e++}return r+=`</tbody>
</table>`,[r,e]}parseBlockquote(t,e){let n=[],i=e;for(;i<t.length&&t[i].startsWith(">");)n.push(t[i].slice(1).trim()),i++;return[`<blockquote>${this.parseInlineElements(n.join(`
`))}</blockquote>`,i]}toHtml(t){const e=this.cleanText(t).split(`
`);let n="",i=0;for(;i<e.length;){const r=e[i].trim();if(!r){i++;continue}const a=r.match(/^(#{1,6})\s+(.+)$/);if(a){const c=a[1].length,h=this.parseInlineElements(a[2].trim());n+=`<h${c}>${h}</h${c}>
`,i++;continue}if(r.startsWith("```")){const[c,h]=this.parseCodeBlock(e.slice(i));n+=c+`
`,i+=h;continue}if(/^(\s*)([-*]|\d+\.)\s/.test(r)){const[c,h]=this.parseList(e,i);n+=c,i=h;continue}if(r.includes("|")&&i+1<e.length&&e[i+1].includes("|")){const[c,h]=this.parseTable(e.slice(i));n+=c+`
`,i+=h;continue}if(r.startsWith(">")){const[c,h]=this.parseBlockquote(e,i);n+=c+`
`,i=h;continue}if(/^[-*_]{3,}$/.test(r)){n+=`<hr>
`,i++;continue}let l="";for(;i<e.length&&e[i].trim();)l+=(l?" ":"")+e[i].trim(),i++;l&&(n+=`<p>${this.parseInlineElements(l)}</p>
`)}return n.trim()}}const za="number";var tt;const Yo=class Yo extends V{constructor(){super(...arguments);y(this,tt)}createContentElement(){const e=document.createElement("input");return e.type="number",e.addEventListener("focus",()=>e.select()),e.addEventListener("change",()=>{this.getThing().saveChangeToStore("value",parseFloat(e.value))}),w(this,tt,e),e}applyData(e){super.applyData(e),Dt(o(this,tt),e),Gs(o(this,tt),e),e.value!==void 0&&(o(this,tt).value=e.value.toString()),e.min!==void 0&&(o(this,tt).min=e.min.toString()),e.max!==void 0&&(o(this,tt).max=e.max.toString()),e.step!==void 0&&(o(this,tt).step=e.step.toString()),e.enabled!==void 0&&(o(this,tt).disabled=!e.enabled)}isFieldEditor(){return!0}beginEditing(){o(this,tt).focus(),o(this,tt).select()}getEditableData(){return{value:parseFloat(o(this,tt).value)}}endEditing(){o(this,tt).blur()}};tt=new WeakMap,Yo.TAG_NAME=`ahoy-${za}`;let ki=Yo;const Qn=class Qn extends Q{constructor(t,e){const n=document.createElement(ki.TAG_NAME);super(n,t,e)}get isFormInput(){return!0}randomize(){const t=this.min?this.min:0,e=this.max?this.max:100;this.setSlotValue("value",t+Math.floor(Math.random()*(e-t+1)))}};Qn.NAME="Number Field",Qn.TYPE=`thing:${za}`,Qn.ELEMENT_CLASS=ki;let Ar=Qn;const ja="range";var Jt;const Go=class Go extends V{constructor(){super(...arguments);y(this,Jt)}createContentElement(){const e=document.createElement("input");return e.type="range",e.addEventListener("input",()=>{this.getThing().saveChangeToStore("value",parseFloat(e.value)),this.getThing().valueChanged()}),w(this,Jt,e),e}applyData(e){super.applyData(e),e.value!==void 0&&(o(this,Jt).value=e.value.toString()),e.min!==void 0&&(o(this,Jt).min=e.min.toString()),e.max!==void 0&&(o(this,Jt).max=e.max.toString()),e.step!==void 0&&(o(this,Jt).step=e.step.toString()),e.enabled!==void 0&&(o(this,Jt).disabled=!e.enabled)}};Jt=new WeakMap,Go.TAG_NAME=`ahoy-${ja}`;let xi=Go;const ts=class ts extends Q{constructor(t,e){const n=document.createElement(xi.TAG_NAME);super(n,t,e)}get isFormInput(){return!0}valueChanged(){try{return C.getInstance().eval(this.whenChanged,this)}catch(t){this.setError(t)}}};ts.NAME="Number Slider",ts.TYPE=`thing:${ja}`,ts.ELEMENT_CLASS=xi;let _r=ts;var Es,Tr;class Dr{constructor(){y(this,Es)}list(){return C.getInstance().getAllThings().map(t=>t.name)}new(t,e){const n="thing:"+t;if(!(n in Li))throw new Error(`usage: new <thing-type>
Available thing types: ${Object.keys(Li).map(r=>r.split(":")[1]).join(", ")}`);const i=C.getInstance().createThing({type:n,...e});return C.getInstance().getThing(i)}get(t){return C.getInstance().getThingByName(t)}delete(t){if(!t)throw new Error("usage: delete <thing-id>");const e=C.getInstance().getThingByName(t);if(!e)throw new Error(`Thing "${t}" not found`);return C.getInstance().deleteThing(e.id),!0}copy(t){if(!t)throw new Error("usage: copy <thing-id>");const e=C.getInstance(),n=e.getThingByName(t);if(!n)throw new Error(`Thing "${t}" not found`);const i=e.copyThing(n.id);if(!i)throw new Error("Copy failed");return e.getThing(i)}getall(){return C.getInstance().getAllThings()}restoreFromUrl(t,e){try{return fetch(t).then(n=>{if(!n.ok)throw new Error(`Failed to fetch snapshot (${n.status}: ${n.statusText})`);return n.text()}).then(n=>{try{C.getInstance().clearData(),m(this,Es,Tr).call(this,n)}catch(i){e&&e(i)}}).catch(n=>{console.error(`Error loading snapshot: ${n.message}`),e&&e(n)}),!0}catch(n){return console.error(`Failed to initiate fetch: ${n}`),e&&e(n),!1}}load(){const t=document.createElement("input");return t.type="file",t.accept="application/json",t.onchange=()=>{var i;const e=(i=t.files)==null?void 0:i[0];if(!e)throw new Error("No file selected");const n=new FileReader;n.onload=()=>{try{const r=n.result;m(this,Es,Tr).call(this,r)}catch(r){throw new Error(`Failed to load file: ${r}`)}},n.onerror=()=>{throw new Error("Failed to read file")},n.readAsText(e)},t.click(),!0}save(){const t={version:this.version(),nodes:this.getall()},e=JSON.stringify(t),n=new Blob([e],{type:"application/json"}),i=URL.createObjectURL(n),a=`ahoy-export-${new Date().toISOString().split("T")[0]}.json`,l=document.createElement("a");return l.href=i,l.download=a,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(i),a}participants(){return C.getInstance().userManager.allUsers}beep(){try{const t=window.AudioContext||window.webkitAudioContext;if(!t)return;const e=new t,n=e.createOscillator();n.type="sine",n.frequency.value=1e3;const i=e.createGain();i.gain.value=.2,i.connect(e.destination),n.connect(i),n.start(),i.gain.setValueAtTime(.2,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+.5),setTimeout(()=>{n.stop(),n.disconnect(),i.disconnect()},500)}catch(t){console.error("Failed to play beep sound:",t)}}version(){return"1.0.0"}}Es=new WeakSet,Tr=function(t){const e=JSON.parse(t);if(!e||typeof e!="object")throw new Error("Invalid format: Expected object with version and nodes");if(!("version"in e))throw new Error("Invalid format: Missing version field");if(!("nodes"in e)||!Array.isArray(e.nodes))throw new Error("Invalid format: Missing or invalid nodes array");if(!e.nodes.every(n=>typeof n=="object"&&n!==null&&"type"in n&&n.type.startsWith("thing:")))throw new Error("Invalid format: Each node must be a Thing with valid type");return C.getInstance().loadData(e.nodes),!0};const Wa="terminal",Re="> ";var j,_e,Ya,Ga,Ja;const Jo=class Jo extends V{constructor(){super(...arguments);y(this,_e);y(this,j)}createContentElement(){const e=document.createElement("textarea");return e.addEventListener("input",()=>{this.getThing().saveChangeToStore("value",e.value)}),e.addEventListener("keydown",m(this,_e,Ja).bind(this)),e.style.resize="none",e.style.padding="1em",e.spellcheck=!1,e.dataset.codeField="true",w(this,j,e),e}applyData(e){super.applyData(e),e.value!==void 0&&(o(this,j).value=e.value,o(this,j).scrollTop=o(this,j).scrollHeight),e.fontSize&&(o(this,j).style.fontSize=`${e.fontSize}px`),e.textColor&&(o(this,j).style.color=e.textColor),e.backgroundColor&&(o(this,j).style.backgroundColor=e.backgroundColor)}};j=new WeakMap,_e=new WeakSet,Ya=function(){const e=o(this,j).selectionStart,n=o(this,j).value.lastIndexOf(`
`,e-1)+1,i=o(this,j).value.indexOf(`
`,e);return o(this,j).value.slice(n,i===-1?void 0:i)},Ga=function(e){const n=o(this,j).selectionStart,i=o(this,j).value.lastIndexOf(`
`,n-1)+1,r=o(this,j).value.indexOf(`
`,n),a=o(this,j).value.slice(0,i),l=r===-1?"":o(this,j).value.slice(r);this.getThing().value=a+e+l},Ja=function(e){if(e.key==="Enter"){e.preventDefault();const n=m(this,_e,Ya).call(this),i=n.startsWith(Re)?n.slice(Re.length).trim():n.trim();this.getThing().evaluateCommand(i)}else if(e.key==="ArrowUp"||e.key==="ArrowDown"){e.preventDefault();const n=e.key==="ArrowUp"?"up":"down",i=this.getThing().navigateHistory(n);m(this,_e,Ga).call(this,Re+i)}},Jo.TAG_NAME=`ahoy-${Wa}`;let Ci=Jo;const tr=16;var we,Mt,De,qa,Ka,Xa;const es=class es extends Q{constructor(e,n){e.value.endsWith(Re)||(e.value+=Re);const i=document.createElement(Ci.TAG_NAME);super(i,e,n);y(this,De);y(this,we,[]);y(this,Mt,-1)}navigateHistory(e){return e==="up"?w(this,Mt,Math.min(o(this,Mt)+1,o(this,we).length-1)):w(this,Mt,Math.max(-1,o(this,Mt)-1)),o(this,Mt)>=0?o(this,we)[o(this,Mt)]:""}evaluateCommand(e){if(this.value+=`
`,e.length>0)try{switch(e){case"clear":this.value="";break;case"help":{this.value+=m(this,De,Xa).call(this),this.value+=`
`;break}default:{let n;const[i,...r]=e.split(/\s+/);if(i in Dr.prototype){let a=r.length>0?`return system.${i}("${r.join(" ")}")`:`return system.${i}()`;n=C.getInstance().eval(a,this)}else{const a=`return ${e}`;n=C.getInstance().eval(a,this)}n!==void 0&&(this.value+=`${JSON.stringify(n,null,4)}`,this.value+=`
`)}}}catch(n){n.name==="ReferenceError"&&e==="xyzzy"?(this.value+='A hollow voice says "Ahoy!"',this.value+=`
`):(this.value+=String(n),this.value+=`
`)}e.length>0&&m(this,De,Ka).call(this,e),w(this,Mt,-1),this.value+=Re}};we=new WeakMap,Mt=new WeakMap,De=new WeakSet,qa=function(){const e=this.value.split(`
`);let n=0,i=0;for(let r=e.length-1;r>=0;r--)if(e[r].startsWith(Re)&&(n++,n===tr)){i=r;break}n>=tr&&(this.value=e.slice(i).join(`
`))},Ka=function(e){o(this,we).unshift(e),o(this,we).length>tr&&o(this,we).pop(),m(this,De,qa).call(this)},Xa=function(){return`Built-in commands: ${[...Object.getOwnPropertyNames(Dr.prototype).filter(i=>i!=="constructor"&&!i.startsWith("_")),"clear"].join(", ")}.
Or enter a JavaScript expression. You can reference any Thing by name.`},es.NAME="Command Prompt",es.TYPE=`thing:${Wa}`,es.ELEMENT_CLASS=Ci;let Lr=es;const Za="text";var J;const qo=class qo extends V{constructor(){super(...arguments);y(this,J)}createContentElement(){const e=document.createElement("textarea");return e.addEventListener("focus",()=>e.select()),e.addEventListener("input",()=>{this.getThing().saveChangeToStore("value",e.value)}),e.addEventListener("keydown",n=>{n.target.rows===1&&n.key==="Enter"&&(n.target.blur(),n.preventDefault())}),e.addEventListener("blur",n=>{n.target.rows===1&&(n.target.scrollLeft=0)}),w(this,J,e),e.style.resize="none",e.style.overflow="hidden",e.style.padding="0px 2px",e.rows=1,e.style.lineHeight=this.style.height,e}applyData(e){super.applyData(e),Dt(o(this,J),e),Gs(o(this,J),e),e.value!==void 0&&(o(this,J).value=e.value),e.enabled!==void 0&&(o(this,J).disabled=!e.enabled),e.allowsMultipleLines!==void 0&&(o(this,J).rows=e.allowsMultipleLines?0:1,o(this,J).wrap=e.allowsMultipleLines?"soft":"off",e.allowsMultipleLines?o(this,J).style.lineHeight="normal":o(this,J).style.lineHeight=this.style.height)}isFieldEditor(){return o(this,J).rows===1}beginEditing(){o(this,J).focus(),o(this,J).select()}getEditableData(){return{value:o(this,J).value||""}}endEditing(){o(this,J).blur()}};J=new WeakMap,qo.TAG_NAME=`ahoy-${Za}`;let Ii=qo;const ns=class ns extends Q{constructor(t,e){const n=document.createElement(Ii.TAG_NAME);super(n,t,e)}get isFormInput(){return!0}};ns.NAME="Text Field",ns.TYPE=`thing:${Za}`,ns.ELEMENT_CLASS=Ii;let Mr=ns;const Qa="timer";var Ot,Nt,Ze,tl,Or;const Ko=class Ko extends V{constructor(){super(...arguments);y(this,Ze);y(this,Ot);y(this,Nt)}createContentElement(){const e=document.createElement("div");e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.width="100%",e.style.height="100%",e.style.cursor="pointer",e.style.backgroundColor="#eee",e.style.borderRadius="4px",w(this,Ot,document.createElementNS("http://www.w3.org/2000/svg","svg")),o(this,Ot).style.transform="scale(0.7)",w(this,Nt,document.createElementNS("http://www.w3.org/2000/svg","path")),o(this,Nt).setAttribute("fill","black"),o(this,Ot).appendChild(o(this,Nt)),e.appendChild(o(this,Ot));const n=document.createElement("style"),i="@keyframes timer-flash { 50% { fill: rgb(148, 55, 255); } }";return n.textContent=i,this.appendChild(n),e.addEventListener("click",()=>{this.getThing().toggle()}),e}applyData(e){super.applyData(e),Dt(this,e),m(this,Ze,tl).call(this)}startAnimation(){o(this,Nt).style.animation="timer-flash 1s ease-in-out infinite"}stopAnimation(){o(this,Nt).style.animation=""}};Ot=new WeakMap,Nt=new WeakMap,Ze=new WeakSet,tl=function(){const e=this.getThing(),n=e.remainingSeconds/e.duration,i=parseInt(this.style.width),r=parseInt(this.style.height);o(this,Ot).setAttribute("width",i.toString()),o(this,Ot).setAttribute("height",r.toString()),o(this,Ot).setAttribute("viewBox","-1 -1 2 2");const a=2*Math.PI,l=a*n,c=-a/4-l,h=-a/4,d=m(this,Ze,Or).call(this,1,h),u=m(this,Ze,Or).call(this,1,c);if(n===1||e.duration===1)o(this,Nt).setAttribute("d","M 0,0 L 1,0 A 1,1 0 1,0 -1,0 A 1,1 0 1,0 1,0");else{const f=h-c<=Math.PI?0:1,p=`M 0,0 L ${d.x},${d.y} A 1,1 0 ${f},0 ${u.x},${u.y} Z`;o(this,Nt).setAttribute("d",p)}},Or=function(e,n){return{x:e*Math.cos(n),y:e*Math.sin(n)}},Ko.TAG_NAME=`ahoy-${Qa}`;let Ai=Ko;var xt,Ct;const ss=class ss extends Q{constructor(e,n){const i=document.createElement(Ai.TAG_NAME);super(i,e,n);y(this,xt);y(this,Ct);w(this,xt,this.duration)}setSlotValue(e,n){e==="duration"&&(this.pause(),w(this,xt,n)),super.setSlotValue(e,n)}get isRunning(){return o(this,Ct)!==void 0}get remainingSeconds(){return o(this,xt)}start(){o(this,Ct)&&window.clearInterval(o(this,Ct));const e=()=>{const i=1e3-Date.now()%1e3;w(this,Ct,window.setTimeout(n,i))},n=()=>{o(this,Ct)!==void 0&&(Qi(this,xt)._--,this.element.needsDisplay(),o(this,xt)<=0?(w(this,xt,0),this.pause(),window.setTimeout(()=>{this.fire(),w(this,xt,this.duration),this.element.needsDisplay()},100)):e())};e(),this.element.startAnimation()}pause(){o(this,Ct)&&(window.clearInterval(o(this,Ct)),w(this,Ct,void 0)),this.element.stopAnimation()}toggle(){this.isRunning?this.pause():this.start()}stop(){this.pause(),w(this,xt,this.duration),this.element.needsDisplay()}fire(){try{C.getInstance().eval(this.whenComplete,this)}catch(e){this.setError(e)}this.repeats?this.start():this.pause()}teardown(){this.pause(),super.teardown()}};xt=new WeakMap,Ct=new WeakMap,ss.NAME="Timer",ss.TYPE=`thing:${Qa}`,ss.ELEMENT_CLASS=Ai;let Nr=ss;const el="html";var gn;const Xo=class Xo extends V{constructor(){super(...arguments);y(this,gn)}createContentElement(){const e=document.createElement("iframe");return e.style.backgroundColor="#ffffff",e.style.overflow="auto",w(this,gn,e),e}applyData(e){super.applyData(e),Dt(o(this,gn),e),e.value&&(o(this,gn).srcdoc=e.value)}};gn=new WeakMap,Xo.TAG_NAME=`ahoy-${el}`;let _i=Xo;const is=class is extends Q{constructor(t,e){const n=document.createElement(_i.TAG_NAME);super(n,t,e)}};is.NAME="Web Embed",is.TYPE=`thing:${el}`,is.ELEMENT_CLASS=_i;let Rr=is;const nl="jscanvas";var ot,$,vs,Ss,ks,$r,xs,Cs,Is;const Zo=class Zo extends V{constructor(){super(...arguments);y(this,ks);y(this,ot);y(this,$);y(this,vs,0);y(this,Ss,0);y(this,xs,e=>{m(this,ks,$r).call(this),o(this,$).whenMouseMoved.trim()&&C.getInstance().eval(o(this,$).whenMouseMoved,o(this,$))});y(this,Cs,e=>{o(this,$).whenMousePressed.trim()&&C.getInstance().eval(o(this,$).whenMousePressed,o(this,$))});y(this,Is,e=>{o(this,$).whenMouseReleased.trim()&&C.getInstance().eval(o(this,$).whenMouseReleased,o(this,$))})}createContentElement(){const e=document.createElement("canvas");return w(this,ot,e),e.addEventListener("mousemove",o(this,xs)),e.addEventListener("mousedown",o(this,Cs)),e.addEventListener("mouseup",o(this,Is)),e}connectedCallback(){super.connectedCallback(),m(this,ks,$r).call(this),o(this,$).whenCreated.trim()&&C.getInstance().eval(o(this,$).whenCreated,o(this,$))}applyData(e){super.applyData(e),Dt(o(this,ot),e)}disconnectedCallback(){o(this,$).whenDestroyed.trim()&&C.getInstance().eval(o(this,$).whenDestroyed,o(this,$)),o(this,ot).removeEventListener("mousemove",o(this,xs)),o(this,ot).removeEventListener("mousedown",o(this,Cs)),o(this,ot).removeEventListener("mouseup",o(this,Is))}setThing(e){super.setThing(e),w(this,$,e)}};ot=new WeakMap,$=new WeakMap,vs=new WeakMap,Ss=new WeakMap,ks=new WeakSet,$r=function(){const e=o(this,ot).offsetWidth,n=o(this,ot).offsetHeight;(o(this,ot).width!==e||o(this,ot).height!==n)&&(o(this,ot).width=e,o(this,ot).height=n,(e!==o(this,vs)||n!==o(this,Ss))&&(o(this,$).whenResized.trim()&&C.getInstance().eval(o(this,$).whenResized,o(this,$)),w(this,vs,e),w(this,Ss,n)))},xs=new WeakMap,Cs=new WeakMap,Is=new WeakMap,Zo.TAG_NAME=`ahoy-${nl}`;let Di=Zo;const rs=class rs extends Q{constructor(t,e){const n=document.createElement(Di.TAG_NAME);super(n,t,e)}teardown(){if(this.whenDestroyed.trim())try{C.getInstance().eval(this.whenDestroyed,this)}catch(t){this.setError(t)}super.teardown()}};rs.NAME="JS Canvas",rs.TYPE=`thing:${nl}`,rs.ELEMENT_CLASS=Di;let Ur=rs;class ch extends HTMLElement{constructor(){super(),this.isOpen=!1,this._selectedIndex=-1,this.highlightedIndex=-1,this.options=[],this.mouseDownTime=0,this.attachShadow({mode:"open"}),this.render(),this.handleClickOutside=this.handleClickOutside.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}static get observedAttributes(){return["disabled","value"]}connectedCallback(){this.setupEventListeners(),this.initializeOptions(),this.hasAttribute("value")&&this.setSelectedByValue(this.getAttribute("value"))}disconnectedCallback(){this.cleanupEventListeners()}attributeChangedCallback(t,e,n){t==="disabled"?this.updateDisabledState():t==="value"&&e!==n&&this.setSelectedByValue(n)}render(){const t=`
      :host {
        display: inline-block;
        position: relative;
        width: fit-content;
        min-width: 120px;
      }

      @keyframes selectedBlink {
        0%, 100% { background: white; }
        50% { background: #0066cc; }
      }

      .select-button {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        padding: 4px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: white;
        cursor: pointer;
        text-align: left;
        font: inherit;
      }

      .select-button:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
      }

      .select-button:focus {
        outline: none;
        border-color: #0066cc;
        box-shadow: 0 0 0 2px rgba(0,102,204,0.2);
      }

      .options-container {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 100%;
        width: max-content;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
      }

      .options-container.open {
        display: block;
      }

      .option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        cursor: pointer;
      }

      .option:hover,
      .option.highlighted {
        background: #f0f0f0;
      }

      .option.selected {
        background: #e0e0e0;
      }

      .option.blink {
        animation: selectedBlink 0.2s ease-in-out;
      }

      ::slotted(*) {
        pointer-events: none;
      }
    `,e=`
      <button class="select-button" type="button" aria-haspopup="listbox">
        <slot name="selected">Select an option</slot>
      </button>
      <div class="options-container" role="listbox">
      </div>
    `;if(!this.shadowRoot)throw new Error("Shadow root is not initialized");this.shadowRoot.innerHTML=`
      <style>${t}</style>
      ${e}
    `;const n=this.shadowRoot.querySelector(".select-button"),i=this.shadowRoot.querySelector(".options-container");if(!n||!i)throw new Error("Failed to initialize required DOM elements");this.buttonEl=n,this.optionsContainerEl=i}setupEventListeners(){this.buttonEl.addEventListener("click",t=>this.handleClick(t)),this.buttonEl.addEventListener("mousedown",t=>this.handleMouseDown(t)),this.addEventListener("keydown",this.handleKeyDown),document.addEventListener("click",this.handleClickOutside)}cleanupEventListeners(){document.removeEventListener("click",this.handleClickOutside)}handleClick(t){if(this.disabled)return;const n=Date.now()-this.mouseDownTime>500;t.preventDefault(),n||t.composedPath().includes(this.buttonEl)&&this.isOpen&&this.closeDropdown()}handleMouseDown(t){if(this.disabled)return;this.mouseDownTime=Date.now(),this.openDropdown();const e=n=>{const r=Date.now()-this.mouseDownTime>=500,l=n.composedPath().find(c=>{var h;return c instanceof HTMLElement&&((h=c.classList)==null?void 0:h.contains("option"))});if(l){const c=parseInt(l.getAttribute("data-index")||"-1");if(c!==-1){this.selectOption(c),setTimeout(()=>this.closeDropdown(),200);return}}r&&this.closeDropdown(),this.mouseDownTime=0,document.removeEventListener("mouseup",e)};document.addEventListener("mouseup",e,{once:!0})}handleClickOutside(t){t.composedPath().includes(this)||this.closeDropdown()}handleKeyDown(t){if(!this.disabled)switch(t.key){case"Enter":case" ":this.isOpen?this.highlightedIndex!==-1&&(this.selectOption(this.highlightedIndex),setTimeout(()=>this.closeDropdown(),200)):this.openDropdown(),t.preventDefault();break;case"Escape":this.closeDropdown(),t.preventDefault();break;case"ArrowDown":this.isOpen||this.openDropdown(),this.highlightNextOption(),t.preventDefault();break;case"ArrowUp":this.isOpen||this.openDropdown(),this.highlightPreviousOption(),t.preventDefault();break}}openDropdown(){this.isOpen||(this.isOpen=!0,this.optionsContainerEl.classList.add("open"),this.buttonEl.setAttribute("aria-expanded","true"),this.highlightOption(this._selectedIndex>=0?this._selectedIndex:0))}closeDropdown(){if(!this.isOpen)return;const t=()=>{var n;this.isOpen=!1,this.optionsContainerEl.classList.remove("open"),this.buttonEl.setAttribute("aria-expanded","false");const e=(n=this.shadowRoot)==null?void 0:n.querySelector(".option.highlighted");e&&e.classList.remove("highlighted"),this.highlightedIndex=-1};if(this._selectedIndex>=0){this.triggerBlinkAnimation(),setTimeout(t,200);return}t()}initializeOptions(){this.options=[],this.optionsContainerEl.innerHTML="";const t=this.querySelectorAll("option");t.forEach((n,i)=>{const r=document.createElement("div");r.className="option",r.setAttribute("role","option"),r.setAttribute("data-index",i.toString()),Array.from(n.childNodes).forEach(a=>{r.appendChild(a.cloneNode(!0))}),r.addEventListener("click",()=>{this.selectOption(i),setTimeout(()=>this.closeDropdown(),200)}),r.addEventListener("mouseover",()=>{this.highlightOption(i)}),this.optionsContainerEl.appendChild(r),this.options.push({value:n.value,text:n.textContent||"",element:r,option:n})});const e=this.querySelector("option[selected]");if(e){const n=Array.from(t).indexOf(e);this.selectOption(n)}}triggerBlinkAnimation(){var e;const t=(e=this.options[this._selectedIndex])==null?void 0:e.element;t&&(t.classList.remove("blink"),t.offsetWidth,t.classList.add("blink"),setTimeout(()=>{t.classList.remove("blink")},200))}selectOption(t){if(t<0||t>=this.options.length)return;this._selectedIndex=t;const e=this.options[t];this.options.forEach((n,i)=>{i===t?n.option.slot="selected":n.option.slot=""}),this.options.forEach((n,i)=>{n.element.classList.toggle("selected",i===t),n.element.setAttribute("aria-selected",i===t?"true":"false")}),this.dispatchEvent(new CustomEvent("change",{detail:{value:e.value,index:t}}))}highlightOption(t){var n;if(t<0||t>=this.options.length)return;const e=(n=this.shadowRoot)==null?void 0:n.querySelector(".option.highlighted");e&&e.classList.remove("highlighted"),this.options[t].element.classList.add("highlighted"),this.highlightedIndex=t}highlightNextOption(){const t=(this.highlightedIndex+1)%this.options.length;this.highlightOption(t)}highlightPreviousOption(){const t=this.highlightedIndex-1;this.highlightOption(t>=0?t:this.options.length-1)}updateDisabledState(){const t=this.hasAttribute("disabled");this.buttonEl.disabled=t,t&&this.closeDropdown()}setSelectedByValue(t){if(t===null)return;const e=this.options.findIndex(n=>n.value===t);e!==-1&&this.selectOption(e)}get value(){return this.selectedIndex>=0?this.options[this.selectedIndex].value:""}set value(t){this.setSelectedByValue(t)}get selectedIndex(){return this._selectedIndex}set selectedIndex(t){this.selectOption(t)}get disabled(){return this.hasAttribute("disabled")}set disabled(t){t?this.setAttribute("disabled",""):this.removeAttribute("disabled")}}customElements.define("custom-select",ch);const na="ahoy:user";function Vr(s){const t=parseInt(s.slice(1,3),16),e=parseInt(s.slice(3,5),16),n=parseInt(s.slice(5,7),16);return t*.299+e*.587+n*.114<160}var et,be,mn,oi;class hh{constructor(t){y(this,mn);y(this,et);y(this,be);w(this,be,t);let e;const n=localStorage.getItem(na);n&&(e=JSON.parse(n)),e!=null&&e.uuid?w(this,et,e):(w(this,et,{uuid:crypto.randomUUID(),name:"Anonymous",color:"#"+Math.floor(Math.random()*16777215).toString(16)}),m(this,mn,oi).call(this)),o(this,be)&&o(this,be).call(this,o(this,et))}get uuid(){return o(this,et).uuid}get name(){return o(this,et).name}set name(t){o(this,et).name=t,m(this,mn,oi).call(this)}get color(){return o(this,et).color}set color(t){o(this,et).color=t,m(this,mn,oi).call(this)}get isLocal(){return o(this,et).isLocal}toJSON(){return{...o(this,et),isLocal:!0}}}et=new WeakMap,be=new WeakMap,mn=new WeakSet,oi=function(){localStorage.setItem(na,JSON.stringify(o(this,et))),o(this,be)&&o(this,be).call(this,o(this,et)),M.getInstance().emit("user",{id:this.uuid})};var Rt,yn,Be,wn,Bi,sl;class dh{constructor(t){y(this,Bi);y(this,Rt);y(this,yn);y(this,Be);y(this,wn);var e,n;w(this,Rt,t),w(this,yn,new hh((e=o(this,Rt))==null?void 0:e.setLocalState.bind(o(this,Rt)))),w(this,Be,[]),w(this,wn,m(this,Bi,sl).bind(this)),(n=o(this,Rt))==null||n.on("change",o(this,wn))}get localUser(){return o(this,yn)}get onlineRemoteUsers(){return o(this,Be)}get allUsers(){return[this.localUser,...this.onlineRemoteUsers]}teardown(){var t;(t=o(this,Rt))==null||t.off("change",o(this,wn))}}Rt=new WeakMap,yn=new WeakMap,Be=new WeakMap,wn=new WeakMap,Bi=new WeakSet,sl=function(t){o(this,Rt)&&(w(this,Be,Array.from(o(this,Rt).getStates().values()).filter(e=>e.uuid!==o(this,yn).uuid)),o(this,Be).forEach(e=>{M.getInstance().emit("user",{id:e.uuid})}))};const il="participant",rl=document.createElement("template");rl.innerHTML=`
  <style>
    .thing-content {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px;
      height: 100%;
      box-sizing: border-box;
    }

    .avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
    }

    select {
      border: 1px solid transparent;
      border-radius: 4px;
      background-color: transparent;

      appearance: none;
      cursor: pointer;
    }

    select:hover {
      appearance: auto;
      border-color: black;
    }

    /* Option styling */
    .option {
      width: 100%;
      margin: 0;
      outline: none;
    }

    .option:focus {
      background: rgba(148, 55, 255, 0.1);
    }
  </style>
`;var qt,at;const Qo=class Qo extends V{constructor(){super(...arguments);y(this,qt);y(this,at)}createContentElement(){return this.appendChild(rl.content.cloneNode(!0)),w(this,qt,document.createElement("div")),w(this,at,document.createElement("select")),o(this,at).style.flex="1",o(this,at).addEventListener("change",()=>{const e=o(this,at).options[o(this,at).selectedIndex],n=this.getThing();n.saveChangeToStore("participantId",e.value),n.saveChangeToStore("value",e.dataset.name||""),n.saveChangeToStore("avatarColor",e.dataset.color||"")}),o(this,qt).appendChild(o(this,at)),o(this,qt)}applyData(e){super.applyData(e),Dt(o(this,qt),e),e.avatarColor!==void 0&&(o(this,qt).style.backgroundColor=e.avatarColor,o(this,at).style.color=Vr(e.avatarColor)?"white":"black"),this.updateParticipantsList()}updateParticipantsList(){o(this,at).innerHTML="";const e=C.getInstance().userManager.allUsers,n=C.getInstance().userManager.localUser,i=this.getThing(),r=new Map;e.forEach(a=>{r.set(a.uuid,a)}),r.set(i.participantId,{uuid:i.participantId,name:i.value,color:i.avatarColor}),Array.from(r.values()).forEach((a,l)=>{const c=document.createElement("option");c.value=a.uuid,c.dataset.name=a.name,c.dataset.color=a.color;let h=a.name;a.uuid===n.uuid&&(h=`${a.name} (you)`),c.textContent=h,o(this,at).appendChild(c),a.uuid===i.participantId&&(o(this,at).selectedIndex=l,o(this,at).style.color=Vr(a.color)?"white":"black",o(this,qt).style.backgroundColor=a.color)})}};qt=new WeakMap,at=new WeakMap,Qo.TAG_NAME=`ahoy-${il}`;let Ti=Qo;var bn,zi,ol;const os=class os extends Q{constructor(e,n){if(!e.participantId){const r=C.getInstance().userManager.localUser;e.participantId=r.uuid,e.value=r.name,e.avatarColor=r.color}e._allUsers=JSON.parse(JSON.stringify(C.getInstance().userManager.allUsers));const i=document.createElement(Ti.TAG_NAME);super(i,e,n);y(this,zi);y(this,bn);w(this,bn,m(this,zi,ol).bind(this)),M.getInstance().on("user",o(this,bn))}teardown(){M.getInstance().off("user",o(this,bn)),super.teardown()}};bn=new WeakMap,zi=new WeakSet,ol=function({id:e}){const n=C.getInstance().userManager.localUser;e===this.participantId&&(this.setSlotValue("value",n.name),this.setSlotValue("avatarColor",n.color)),this.element.needsDisplay()},os.NAME="Participant",os.TYPE=`thing:${il}`,os.ELEMENT_CLASS=Ti;let Fr=os;const al=[xr,Mr,Ir,Ar,_r,mr,Sr,vr,gr,Nr,Ur,Cr,kr,Rr,Fr,Lr],Li=Object.fromEntries(al.map(s=>[s.TYPE,s]));for(const s of al)customElements.define(s.ELEMENT_CLASS.TAG_NAME,s.ELEMENT_CLASS);const ct=()=>new Map,Pr=s=>{const t=ct();return s.forEach((e,n)=>{t.set(n,e)}),t},Wt=(s,t,e)=>{let n=s.get(t);return n===void 0&&s.set(t,n=e()),n},uh=(s,t)=>{const e=[];for(const[n,i]of s)e.push(t(i,n));return e},fh=(s,t)=>{for(const[e,n]of s)if(t(n,e))return!0;return!1},Ce=()=>new Set,er=s=>s[s.length-1],ph=(s,t)=>{for(let e=0;e<t.length;e++)s.push(t[e])},oe=Array.from,gh=(s,t)=>{for(let e=0;e<s.length;e++)if(t(s[e],e,s))return!0;return!1},Hr=Array.isArray;class uo{constructor(){this._observers=ct()}on(t,e){return Wt(this._observers,t,Ce).add(e),e}once(t,e){const n=(...i)=>{this.off(t,n),e(...i)};this.on(t,n)}off(t,e){const n=this._observers.get(t);n!==void 0&&(n.delete(e),n.size===0&&this._observers.delete(t))}emit(t,e){return oe((this._observers.get(t)||ct()).values()).forEach(n=>n(...e))}destroy(){this._observers=ct()}}class ll{constructor(){this._observers=ct()}on(t,e){Wt(this._observers,t,Ce).add(e)}once(t,e){const n=(...i)=>{this.off(t,n),e(...i)};this.on(t,n)}off(t,e){const n=this._observers.get(t);n!==void 0&&(n.delete(e),n.size===0&&this._observers.delete(t))}emit(t,e){return oe((this._observers.get(t)||ct()).values()).forEach(n=>n(...e))}destroy(){this._observers=ct()}}const ae=Math.floor,ai=Math.abs,fo=(s,t)=>s<t?s:t,tn=(s,t)=>s>t?s:t,mh=Math.pow,cl=s=>s!==0?s<0:1/s<0,sa=1,ia=2,nr=4,sr=8,as=32,re=64,pt=128,ji=31,Br=63,Ge=127,yh=2147483647,hl=Number.MAX_SAFE_INTEGER,wh=Number.isInteger||(s=>typeof s=="number"&&isFinite(s)&&ae(s)===s),bh=String.fromCharCode,Eh=s=>s.toLowerCase(),vh=/^\s*/g,Sh=s=>s.replace(vh,""),kh=/([A-Z])/g,ra=(s,t)=>Sh(s.replace(kh,e=>`${t}${Eh(e)}`)),xh=s=>{const t=unescape(encodeURIComponent(s)),e=t.length,n=new Uint8Array(e);for(let i=0;i<e;i++)n[i]=t.codePointAt(i);return n},ls=typeof TextEncoder<"u"?new TextEncoder:null,Ch=s=>ls.encode(s),Ih=ls?Ch:xh;let zn=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});zn&&zn.decode(new Uint8Array).length===1&&(zn=null);class Js{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const X=()=>new Js,po=s=>{let t=s.cpos;for(let e=0;e<s.bufs.length;e++)t+=s.bufs[e].length;return t},R=s=>{const t=new Uint8Array(po(s));let e=0;for(let n=0;n<s.bufs.length;n++){const i=s.bufs[n];t.set(i,e),e+=i.length}return t.set(new Uint8Array(s.cbuf.buffer,0,s.cpos),e),t},Ah=(s,t)=>{const e=s.cbuf.length;e-s.cpos<t&&(s.bufs.push(new Uint8Array(s.cbuf.buffer,0,s.cpos)),s.cbuf=new Uint8Array(tn(e,t)*2),s.cpos=0)},G=(s,t)=>{const e=s.cbuf.length;s.cpos===e&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(e*2),s.cpos=0),s.cbuf[s.cpos++]=t},zr=G,S=(s,t)=>{for(;t>Ge;)G(s,pt|Ge&t),t=ae(t/128);G(s,Ge&t)},go=(s,t)=>{const e=cl(t);for(e&&(t=-t),G(s,(t>Br?pt:0)|(e?re:0)|Br&t),t=ae(t/64);t>0;)G(s,(t>Ge?pt:0)|Ge&t),t=ae(t/128)},jr=new Uint8Array(3e4),_h=jr.length/3,Dh=(s,t)=>{if(t.length<_h){const e=ls.encodeInto(t,jr).written||0;S(s,e);for(let n=0;n<e;n++)G(s,jr[n])}else P(s,Ih(t))},Th=(s,t)=>{const e=unescape(encodeURIComponent(t)),n=e.length;S(s,n);for(let i=0;i<n;i++)G(s,e.codePointAt(i))},Je=ls&&ls.encodeInto?Dh:Th,Wi=(s,t)=>{const e=s.cbuf.length,n=s.cpos,i=fo(e-n,t.length),r=t.length-i;s.cbuf.set(t.subarray(0,i),n),s.cpos+=i,r>0&&(s.bufs.push(s.cbuf),s.cbuf=new Uint8Array(tn(e*2,r)),s.cbuf.set(t.subarray(i)),s.cpos=r)},P=(s,t)=>{S(s,t.byteLength),Wi(s,t)},mo=(s,t)=>{Ah(s,t);const e=new DataView(s.cbuf.buffer,s.cpos,t);return s.cpos+=t,e},Lh=(s,t)=>mo(s,4).setFloat32(0,t,!1),Mh=(s,t)=>mo(s,8).setFloat64(0,t,!1),Oh=(s,t)=>mo(s,8).setBigInt64(0,t,!1),oa=new DataView(new ArrayBuffer(4)),Nh=s=>(oa.setFloat32(0,s),oa.getFloat32(0)===s),cs=(s,t)=>{switch(typeof t){case"string":G(s,119),Je(s,t);break;case"number":wh(t)&&ai(t)<=yh?(G(s,125),go(s,t)):Nh(t)?(G(s,124),Lh(s,t)):(G(s,123),Mh(s,t));break;case"bigint":G(s,122),Oh(s,t);break;case"object":if(t===null)G(s,126);else if(Hr(t)){G(s,117),S(s,t.length);for(let e=0;e<t.length;e++)cs(s,t[e])}else if(t instanceof Uint8Array)G(s,116),P(s,t);else{G(s,118);const e=Object.keys(t);S(s,e.length);for(let n=0;n<e.length;n++){const i=e[n];Je(s,i),cs(s,t[i])}}break;case"boolean":G(s,t?120:121);break;default:G(s,127)}};class aa extends Js{constructor(t){super(),this.w=t,this.s=null,this.count=0}write(t){this.s===t?this.count++:(this.count>0&&S(this,this.count-1),this.count=1,this.w(this,t),this.s=t)}}const la=s=>{s.count>0&&(go(s.encoder,s.count===1?s.s:-s.s),s.count>1&&S(s.encoder,s.count-2))};class li{constructor(){this.encoder=new Js,this.s=0,this.count=0}write(t){this.s===t?this.count++:(la(this),this.count=1,this.s=t)}toUint8Array(){return la(this),R(this.encoder)}}const ca=s=>{if(s.count>0){const t=s.diff*2+(s.count===1?0:1);go(s.encoder,t),s.count>1&&S(s.encoder,s.count-2)}};class ir{constructor(){this.encoder=new Js,this.s=0,this.count=0,this.diff=0}write(t){this.diff===t-this.s?(this.s=t,this.count++):(ca(this),this.count=1,this.diff=t-this.s,this.s=t)}toUint8Array(){return ca(this),R(this.encoder)}}class Rh{constructor(){this.sarr=[],this.s="",this.lensE=new li}write(t){this.s+=t,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(t.length)}toUint8Array(){const t=new Js;return this.sarr.push(this.s),this.s="",Je(t,this.sarr.join("")),Wi(t,this.lensE.toUint8Array()),R(t)}}const le=s=>new Error(s),Pt=()=>{throw le("Method unimplemented")},Bt=()=>{throw le("Unexpected case")},dl=le("Unexpected end of array"),ul=le("Integer out of Range");class Yi{constructor(t){this.arr=t,this.pos=0}}const Te=s=>new Yi(s),$h=s=>s.pos!==s.arr.length,Uh=(s,t)=>{const e=new Uint8Array(s.arr.buffer,s.pos+s.arr.byteOffset,t);return s.pos+=t,e},K=s=>Uh(s,k(s)),In=s=>s.arr[s.pos++],k=s=>{let t=0,e=1;const n=s.arr.length;for(;s.pos<n;){const i=s.arr[s.pos++];if(t=t+(i&Ge)*e,e*=128,i<pt)return t;if(t>hl)throw ul}throw dl},yo=s=>{let t=s.arr[s.pos++],e=t&Br,n=64;const i=(t&re)>0?-1:1;if(!(t&pt))return i*e;const r=s.arr.length;for(;s.pos<r;){if(t=s.arr[s.pos++],e=e+(t&Ge)*n,n*=128,t<pt)return i*e;if(e>hl)throw ul}throw dl},Vh=s=>{let t=k(s);if(t===0)return"";{let e=String.fromCodePoint(In(s));if(--t<100)for(;t--;)e+=String.fromCodePoint(In(s));else for(;t>0;){const n=t<1e4?t:1e4,i=s.arr.subarray(s.pos,s.pos+n);s.pos+=n,e+=String.fromCodePoint.apply(null,i),t-=n}return decodeURIComponent(escape(e))}},Fh=s=>zn.decode(K(s)),xe=zn?Fh:Vh,wo=(s,t)=>{const e=new DataView(s.arr.buffer,s.arr.byteOffset+s.pos,t);return s.pos+=t,e},Ph=s=>wo(s,4).getFloat32(0,!1),Hh=s=>wo(s,8).getFloat64(0,!1),Bh=s=>wo(s,8).getBigInt64(0,!1),zh=[s=>{},s=>null,yo,Ph,Hh,Bh,s=>!1,s=>!0,xe,s=>{const t=k(s),e={};for(let n=0;n<t;n++){const i=xe(s);e[i]=hs(s)}return e},s=>{const t=k(s),e=[];for(let n=0;n<t;n++)e.push(hs(s));return e},K],hs=s=>zh[127-In(s)](s);class ha extends Yi{constructor(t,e){super(t),this.reader=e,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),$h(this)?this.count=k(this)+1:this.count=-1),this.count--,this.s}}class ci extends Yi{constructor(t){super(t),this.s=0,this.count=0}read(){if(this.count===0){this.s=yo(this);const t=cl(this.s);this.count=1,t&&(this.s=-this.s,this.count=k(this)+2)}return this.count--,this.s}}class rr extends Yi{constructor(t){super(t),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const t=yo(this),e=t&1;this.diff=ae(t/2),this.count=1,e&&(this.count=k(this)+2)}return this.s+=this.diff,this.count--,this.s}}class jh{constructor(t){this.decoder=new ci(t),this.str=xe(this.decoder),this.spos=0}read(){const t=this.spos+this.decoder.read(),e=this.str.slice(this.spos,t);return this.spos=t,e}}const Wh=crypto.getRandomValues.bind(crypto),fl=()=>Wh(new Uint32Array(1))[0],Yh="10000000-1000-4000-8000"+-1e11,Gh=()=>Yh.replace(/[018]/g,s=>(s^fl()&15>>s/4).toString(16)),Ie=Date.now,An=s=>new Promise(s);Promise.all.bind(Promise);const da=s=>s===void 0?null:s;class Jh{constructor(){this.map=new Map}setItem(t,e){this.map.set(t,e)}getItem(t){return this.map.get(t)}}let pl=new Jh,bo=!0;try{typeof localStorage<"u"&&localStorage&&(pl=localStorage,bo=!1)}catch{}const gl=pl,qh=s=>bo||addEventListener("storage",s),Kh=s=>bo||removeEventListener("storage",s),Xh=Object.assign,ml=Object.keys,Zh=(s,t)=>{for(const e in s)t(s[e],e)},Qh=(s,t)=>{const e=[];for(const n in s)e.push(t(s[n],n));return e},ua=s=>ml(s).length,fa=s=>ml(s).length,td=s=>{for(const t in s)return!1;return!0},ed=(s,t)=>{for(const e in s)if(!t(s[e],e))return!1;return!0},yl=(s,t)=>Object.prototype.hasOwnProperty.call(s,t),nd=(s,t)=>s===t||fa(s)===fa(t)&&ed(s,(e,n)=>(e!==void 0||yl(t,n))&&t[n]===e),sd=Object.freeze,wl=s=>{for(const t in s){const e=s[t];(typeof e=="object"||typeof e=="function")&&wl(s[t])}return sd(s)},Eo=(s,t,e=0)=>{try{for(;e<s.length;e++)s[e](...t)}finally{e<s.length&&Eo(s,t,e+1)}},id=s=>s,rd=(s,t)=>s===t,jn=(s,t)=>{if(s==null||t==null)return rd(s,t);if(s.constructor!==t.constructor)return!1;if(s===t)return!0;switch(s.constructor){case ArrayBuffer:s=new Uint8Array(s),t=new Uint8Array(t);case Uint8Array:{if(s.byteLength!==t.byteLength)return!1;for(let e=0;e<s.length;e++)if(s[e]!==t[e])return!1;break}case Set:{if(s.size!==t.size)return!1;for(const e of s)if(!t.has(e))return!1;break}case Map:{if(s.size!==t.size)return!1;for(const e of s.keys())if(!t.has(e)||!jn(s.get(e),t.get(e)))return!1;break}case Object:if(ua(s)!==ua(t))return!1;for(const e in s)if(!yl(s,e)||!jn(s[e],t[e]))return!1;break;case Array:if(s.length!==t.length)return!1;for(let e=0;e<s.length;e++)if(!jn(s[e],t[e]))return!1;break;default:return!1}return!0},od=(s,t)=>t.includes(s);var bl={};const Ae=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",El=typeof window<"u"&&typeof document<"u"&&!Ae;let Tt;const ad=()=>{if(Tt===void 0)if(Ae){Tt=ct();const s=process.argv;let t=null;for(let e=0;e<s.length;e++){const n=s[e];n[0]==="-"?(t!==null&&Tt.set(t,""),t=n):t!==null&&(Tt.set(t,n),t=null)}t!==null&&Tt.set(t,"")}else typeof location=="object"?(Tt=ct(),(location.search||"?").slice(1).split("&").forEach(s=>{if(s.length!==0){const[t,e]=s.split("=");Tt.set(`--${ra(t,"-")}`,e),Tt.set(`-${ra(t,"-")}`,e)}})):Tt=ct();return Tt},Wr=s=>ad().has(s),Mi=s=>da(Ae?bl[s.toUpperCase().replaceAll("-","_")]:gl.getItem(s)),vl=s=>Wr("--"+s)||Mi(s)!==null;vl("production");const ld=Ae&&od(bl.FORCE_COLOR,["true","1","2"]),cd=ld||!Wr("--no-colors")&&!vl("no-color")&&(!Ae||process.stdout.isTTY)&&(!Ae||Wr("--color")||Mi("COLORTERM")!==null||(Mi("TERM")||"").includes("color")),Sl=s=>new Uint8Array(s),hd=(s,t,e)=>new Uint8Array(s,t,e),dd=s=>new Uint8Array(s),ud=s=>{let t="";for(let e=0;e<s.byteLength;e++)t+=bh(s[e]);return btoa(t)},fd=s=>Buffer.from(s.buffer,s.byteOffset,s.byteLength).toString("base64"),pd=s=>{const t=atob(s),e=Sl(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e},gd=s=>{const t=Buffer.from(s,"base64");return hd(t.buffer,t.byteOffset,t.byteLength)},md=El?ud:fd,yd=El?pd:gd,wd=s=>{const t=Sl(s.byteLength);return t.set(s),t};class bd{constructor(t,e){this.left=t,this.right=e}}const Yt=(s,t)=>new bd(s,t);typeof DOMParser<"u"&&new DOMParser;const Ed=s=>uh(s,(t,e)=>`${e}:${t};`).join(""),he=Symbol,kl=he(),xl=he(),vd=he(),Sd=he(),kd=he(),Cl=he(),xd=he(),vo=he(),Cd=he(),Id=s=>{var i;s.length===1&&((i=s[0])==null?void 0:i.constructor)===Function&&(s=s[0]());const t=[],e=[];let n=0;for(;n<s.length;n++){const r=s[n];if(r===void 0)break;if(r.constructor===String||r.constructor===Number)t.push(r);else if(r.constructor===Object)break}for(n>0&&e.push(t.join(""));n<s.length;n++){const r=s[n];r instanceof Symbol||e.push(r)}return e},Ad={[kl]:Yt("font-weight","bold"),[xl]:Yt("font-weight","normal"),[vd]:Yt("color","blue"),[kd]:Yt("color","green"),[Sd]:Yt("color","grey"),[Cl]:Yt("color","red"),[xd]:Yt("color","purple"),[vo]:Yt("color","orange"),[Cd]:Yt("color","black")},_d=s=>{var a;s.length===1&&((a=s[0])==null?void 0:a.constructor)===Function&&(s=s[0]());const t=[],e=[],n=ct();let i=[],r=0;for(;r<s.length;r++){const l=s[r],c=Ad[l];if(c!==void 0)n.set(c.left,c.right);else{if(l===void 0)break;if(l.constructor===String||l.constructor===Number){const h=Ed(n);r>0||h.length>0?(t.push("%c"+l),e.push(h)):t.push(l)}else break}}for(r>0&&(i=e,i.unshift(t.join("")));r<s.length;r++){const l=s[r];l instanceof Symbol||i.push(l)}return i},Il=cd?_d:Id,Dd=(...s)=>{console.log(...Il(s)),_l.forEach(t=>t.print(s))},Al=(...s)=>{console.warn(...Il(s)),s.unshift(vo),_l.forEach(t=>t.print(s))},_l=Ce(),Dl=s=>({[Symbol.iterator](){return this},next:s}),Td=(s,t)=>Dl(()=>{let e;do e=s.next();while(!e.done&&!t(e.value));return e}),or=(s,t)=>Dl(()=>{const{done:e,value:n}=s.next();return{done:e,value:e?void 0:t(n)}});class So{constructor(t,e){this.clock=t,this.len=e}}class $n{constructor(){this.clients=new Map}}const _n=(s,t,e)=>t.clients.forEach((n,i)=>{const r=s.doc.store.clients.get(i);for(let a=0;a<n.length;a++){const l=n[a];Bl(s,r,l.clock,l.len,e)}}),Ld=(s,t)=>{let e=0,n=s.length-1;for(;e<=n;){const i=ae((e+n)/2),r=s[i],a=r.clock;if(a<=t){if(t<a+r.len)return i;e=i+1}else n=i-1}return null},qs=(s,t)=>{const e=s.clients.get(t.client);return e!==void 0&&Ld(e,t.clock)!==null},ko=s=>{s.clients.forEach(t=>{t.sort((i,r)=>i.clock-r.clock);let e,n;for(e=1,n=1;e<t.length;e++){const i=t[n-1],r=t[e];i.clock+i.len>=r.clock?i.len=tn(i.len,r.clock+r.len-i.clock):(n<e&&(t[n]=r),n++)}t.length=n})},Yr=s=>{const t=new $n;for(let e=0;e<s.length;e++)s[e].clients.forEach((n,i)=>{if(!t.clients.has(i)){const r=n.slice();for(let a=e+1;a<s.length;a++)ph(r,s[a].clients.get(i)||[]);t.clients.set(i,r)}});return ko(t),t},ds=(s,t,e,n)=>{Wt(s.clients,t,()=>[]).push(new So(e,n))},Md=()=>new $n,Od=s=>{const t=Md();return s.clients.forEach((e,n)=>{const i=[];for(let r=0;r<e.length;r++){const a=e[r];if(a.deleted){const l=a.id.clock;let c=a.length;if(r+1<e.length)for(let h=e[r+1];r+1<e.length&&h.deleted;h=e[++r+1])c+=h.length;i.push(new So(l,c))}}i.length>0&&t.clients.set(n,i)}),t},Un=(s,t)=>{S(s.restEncoder,t.clients.size),oe(t.clients.entries()).sort((e,n)=>n[0]-e[0]).forEach(([e,n])=>{s.resetDsCurVal(),S(s.restEncoder,e);const i=n.length;S(s.restEncoder,i);for(let r=0;r<i;r++){const a=n[r];s.writeDsClock(a.clock),s.writeDsLen(a.len)}})},xo=s=>{const t=new $n,e=k(s.restDecoder);for(let n=0;n<e;n++){s.resetDsCurVal();const i=k(s.restDecoder),r=k(s.restDecoder);if(r>0){const a=Wt(t.clients,i,()=>[]);for(let l=0;l<r;l++)a.push(new So(s.readDsClock(),s.readDsLen()))}}return t},pa=(s,t,e)=>{const n=new $n,i=k(s.restDecoder);for(let r=0;r<i;r++){s.resetDsCurVal();const a=k(s.restDecoder),l=k(s.restDecoder),c=e.clients.get(a)||[],h=W(e,a);for(let d=0;d<l;d++){const u=s.readDsClock(),f=u+s.readDsLen();if(u<h){h<f&&ds(n,a,h,f-h);let p=zt(c,u),g=c[p];for(!g.deleted&&g.id.clock<u&&(c.splice(p+1,0,Pi(t,g,u-g.id.clock)),p++);p<c.length&&(g=c[p++],g.id.clock<f);)g.deleted||(f<g.id.clock+g.length&&c.splice(p,0,Pi(t,g,f-g.id.clock)),g.delete(t))}else ds(n,a,u,f-u)}}if(n.clients.size>0){const r=new qe;return S(r.restEncoder,0),Un(r,n),r.toUint8Array()}return null},Tl=fl;class Vn extends uo{constructor({guid:t=Gh(),collectionid:e=null,gc:n=!0,gcFilter:i=()=>!0,meta:r=null,autoLoad:a=!1,shouldLoad:l=!0}={}){super(),this.gc=n,this.gcFilter=i,this.clientID=Tl(),this.guid=t,this.collectionid=e,this.share=new Map,this.store=new Pl,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=l,this.autoLoad=a,this.meta=r,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=An(h=>{this.on("load",()=>{this.isLoaded=!0,h(this)})});const c=()=>An(h=>{const d=u=>{(u===void 0||u===!0)&&(this.off("sync",d),h())};this.on("sync",d)});this.on("sync",h=>{h===!1&&this.isSynced&&(this.whenSynced=c()),this.isSynced=h===void 0||h===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=c()}load(){const t=this._item;t!==null&&!this.shouldLoad&&T(t.parent.doc,e=>{e.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(oe(this.subdocs).map(t=>t.guid))}transact(t,e=null){return T(this,t,e)}get(t,e=q){const n=Wt(this.share,t,()=>{const r=new e;return r._integrate(this,null),r}),i=n.constructor;if(e!==q&&i!==e)if(i===q){const r=new e;r._map=n._map,n._map.forEach(a=>{for(;a!==null;a=a.left)a.parent=r}),r._start=n._start;for(let a=r._start;a!==null;a=a.right)a.parent=r;return r._length=n._length,this.share.set(t,r),r._integrate(this,null),r}else throw new Error(`Type with the name ${t} has already been defined with a different constructor`);return n}getArray(t=""){return this.get(t,dn)}getText(t=""){return this.get(t,Ln)}getMap(t=""){return this.get(t,Tn)}getXmlElement(t=""){return this.get(t,Mn)}getXmlFragment(t=""){return this.get(t,Ke)}toJSON(){const t={};return this.share.forEach((e,n)=>{t[n]=e.toJSON()}),t}destroy(){this.isDestroyed=!0,oe(this.subdocs).forEach(e=>e.destroy());const t=this._item;if(t!==null){this._item=null;const e=t.content;e.doc=new Vn({guid:this.guid,...e.opts,shouldLoad:!1}),e.doc._item=t,T(t.parent.doc,n=>{const i=e.doc;t.deleted||n.subdocsAdded.add(i),n.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class Ll{constructor(t){this.restDecoder=t}resetDsCurVal(){}readDsClock(){return k(this.restDecoder)}readDsLen(){return k(this.restDecoder)}}class Ml extends Ll{readLeftID(){return A(k(this.restDecoder),k(this.restDecoder))}readRightID(){return A(k(this.restDecoder),k(this.restDecoder))}readClient(){return k(this.restDecoder)}readInfo(){return In(this.restDecoder)}readString(){return xe(this.restDecoder)}readParentInfo(){return k(this.restDecoder)===1}readTypeRef(){return k(this.restDecoder)}readLen(){return k(this.restDecoder)}readAny(){return hs(this.restDecoder)}readBuf(){return wd(K(this.restDecoder))}readJSON(){return JSON.parse(xe(this.restDecoder))}readKey(){return xe(this.restDecoder)}}class Nd{constructor(t){this.dsCurrVal=0,this.restDecoder=t}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=k(this.restDecoder),this.dsCurrVal}readDsLen(){const t=k(this.restDecoder)+1;return this.dsCurrVal+=t,t}}class Dn extends Nd{constructor(t){super(t),this.keys=[],k(t),this.keyClockDecoder=new rr(K(t)),this.clientDecoder=new ci(K(t)),this.leftClockDecoder=new rr(K(t)),this.rightClockDecoder=new rr(K(t)),this.infoDecoder=new ha(K(t),In),this.stringDecoder=new jh(K(t)),this.parentInfoDecoder=new ha(K(t),In),this.typeRefDecoder=new ci(K(t)),this.lenDecoder=new ci(K(t))}readLeftID(){return new hn(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new hn(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return hs(this.restDecoder)}readBuf(){return K(this.restDecoder)}readJSON(){return hs(this.restDecoder)}readKey(){const t=this.keyClockDecoder.read();if(t<this.keys.length)return this.keys[t];{const e=this.stringDecoder.read();return this.keys.push(e),e}}}class Ol{constructor(){this.restEncoder=X()}toUint8Array(){return R(this.restEncoder)}resetDsCurVal(){}writeDsClock(t){S(this.restEncoder,t)}writeDsLen(t){S(this.restEncoder,t)}}class Ks extends Ol{writeLeftID(t){S(this.restEncoder,t.client),S(this.restEncoder,t.clock)}writeRightID(t){S(this.restEncoder,t.client),S(this.restEncoder,t.clock)}writeClient(t){S(this.restEncoder,t)}writeInfo(t){zr(this.restEncoder,t)}writeString(t){Je(this.restEncoder,t)}writeParentInfo(t){S(this.restEncoder,t?1:0)}writeTypeRef(t){S(this.restEncoder,t)}writeLen(t){S(this.restEncoder,t)}writeAny(t){cs(this.restEncoder,t)}writeBuf(t){P(this.restEncoder,t)}writeJSON(t){Je(this.restEncoder,JSON.stringify(t))}writeKey(t){Je(this.restEncoder,t)}}class Nl{constructor(){this.restEncoder=X(),this.dsCurrVal=0}toUint8Array(){return R(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(t){const e=t-this.dsCurrVal;this.dsCurrVal=t,S(this.restEncoder,e)}writeDsLen(t){t===0&&Bt(),S(this.restEncoder,t-1),this.dsCurrVal+=t}}class qe extends Nl{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new ir,this.clientEncoder=new li,this.leftClockEncoder=new ir,this.rightClockEncoder=new ir,this.infoEncoder=new aa(zr),this.stringEncoder=new Rh,this.parentInfoEncoder=new aa(zr),this.typeRefEncoder=new li,this.lenEncoder=new li}toUint8Array(){const t=X();return S(t,0),P(t,this.keyClockEncoder.toUint8Array()),P(t,this.clientEncoder.toUint8Array()),P(t,this.leftClockEncoder.toUint8Array()),P(t,this.rightClockEncoder.toUint8Array()),P(t,R(this.infoEncoder)),P(t,this.stringEncoder.toUint8Array()),P(t,R(this.parentInfoEncoder)),P(t,this.typeRefEncoder.toUint8Array()),P(t,this.lenEncoder.toUint8Array()),Wi(t,R(this.restEncoder)),R(t)}writeLeftID(t){this.clientEncoder.write(t.client),this.leftClockEncoder.write(t.clock)}writeRightID(t){this.clientEncoder.write(t.client),this.rightClockEncoder.write(t.clock)}writeClient(t){this.clientEncoder.write(t)}writeInfo(t){this.infoEncoder.write(t)}writeString(t){this.stringEncoder.write(t)}writeParentInfo(t){this.parentInfoEncoder.write(t?1:0)}writeTypeRef(t){this.typeRefEncoder.write(t)}writeLen(t){this.lenEncoder.write(t)}writeAny(t){cs(this.restEncoder,t)}writeBuf(t){P(this.restEncoder,t)}writeJSON(t){cs(this.restEncoder,t)}writeKey(t){const e=this.keyMap.get(t);e===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(t)):this.keyClockEncoder.write(e)}}const Rd=(s,t,e,n)=>{n=tn(n,t[0].id.clock);const i=zt(t,n);S(s.restEncoder,t.length-i),s.writeClient(e),S(s.restEncoder,n);const r=t[i];r.write(s,n-r.id.clock);for(let a=i+1;a<t.length;a++)t[a].write(s,0)},Co=(s,t,e)=>{const n=new Map;e.forEach((i,r)=>{W(t,r)>i&&n.set(r,i)}),Gi(t).forEach((i,r)=>{e.has(r)||n.set(r,0)}),S(s.restEncoder,n.size),oe(n.entries()).sort((i,r)=>r[0]-i[0]).forEach(([i,r])=>{Rd(s,t.clients.get(i),i,r)})},$d=(s,t)=>{const e=ct(),n=k(s.restDecoder);for(let i=0;i<n;i++){const r=k(s.restDecoder),a=new Array(r),l=s.readClient();let c=k(s.restDecoder);e.set(l,{i:0,refs:a});for(let h=0;h<r;h++){const d=s.readInfo();switch(ji&d){case 0:{const u=s.readLen();a[h]=new St(A(l,c),u),c+=u;break}case 10:{const u=k(s.restDecoder);a[h]=new kt(A(l,c),u),c+=u;break}default:{const u=(d&(re|pt))===0,f=new N(A(l,c),null,(d&pt)===pt?s.readLeftID():null,null,(d&re)===re?s.readRightID():null,u?s.readParentInfo()?t.get(s.readString()):s.readLeftID():null,u&&(d&as)===as?s.readString():null,lc(s,d));a[h]=f,c+=f.length}}}}return e},Ud=(s,t,e)=>{const n=[];let i=oe(e.keys()).sort((p,g)=>p-g);if(i.length===0)return null;const r=()=>{if(i.length===0)return null;let p=e.get(i[i.length-1]);for(;p.refs.length===p.i;)if(i.pop(),i.length>0)p=e.get(i[i.length-1]);else return null;return p};let a=r();if(a===null)return null;const l=new Pl,c=new Map,h=(p,g)=>{const b=c.get(p);(b==null||b>g)&&c.set(p,g)};let d=a.refs[a.i++];const u=new Map,f=()=>{for(const p of n){const g=p.id.client,b=e.get(g);b?(b.i--,l.clients.set(g,b.refs.slice(b.i)),e.delete(g),b.i=0,b.refs=[]):l.clients.set(g,[p]),i=i.filter(E=>E!==g)}n.length=0};for(;;){if(d.constructor!==kt){const g=Wt(u,d.id.client,()=>W(t,d.id.client))-d.id.clock;if(g<0)n.push(d),h(d.id.client,d.id.clock-1),f();else{const b=d.getMissing(s,t);if(b!==null){n.push(d);const E=e.get(b)||{refs:[],i:0};if(E.refs.length===E.i)h(b,W(t,b)),f();else{d=E.refs[E.i++];continue}}else(g===0||g<d.length)&&(d.integrate(s,g),u.set(d.id.client,d.id.clock+d.length))}}if(n.length>0)d=n.pop();else if(a!==null&&a.i<a.refs.length)d=a.refs[a.i++];else{if(a=r(),a===null)break;d=a.refs[a.i++]}}if(l.clients.size>0){const p=new qe;return Co(p,l,new Map),S(p.restEncoder,0),{missing:c,update:p.toUint8Array()}}return null},Vd=(s,t)=>Co(s,t.doc.store,t.beforeState),Fd=(s,t,e,n=new Dn(s))=>T(t,i=>{i.local=!1;let r=!1;const a=i.doc,l=a.store,c=$d(n,a),h=Ud(i,l,c),d=l.pendingStructs;if(d){for(const[f,p]of d.missing)if(p<W(l,f)){r=!0;break}if(h){for(const[f,p]of h.missing){const g=d.missing.get(f);(g==null||g>p)&&d.missing.set(f,p)}d.update=Ni([d.update,h.update])}}else l.pendingStructs=h;const u=pa(n,i,l);if(l.pendingDs){const f=new Dn(Te(l.pendingDs));k(f.restDecoder);const p=pa(f,i,l);u&&p?l.pendingDs=Ni([u,p]):l.pendingDs=u||p}else l.pendingDs=u;if(r){const f=l.pendingStructs.update;l.pendingStructs=null,Rl(i.doc,f)}},e,!1),Rl=(s,t,e,n=Dn)=>{const i=Te(t);Fd(i,s,e,new n(i))},$l=(s,t,e)=>Rl(s,t,e,Ml),Pd=(s,t,e=new Map)=>{Co(s,t.store,e),Un(s,Od(t.store))},Hd=(s,t=new Uint8Array([0]),e=new qe)=>{const n=Ul(t);Pd(e,s,n);const i=[e.toUint8Array()];if(s.store.pendingDs&&i.push(s.store.pendingDs),s.store.pendingStructs&&i.push(iu(s.store.pendingStructs.update,t)),i.length>1){if(e.constructor===Ks)return nu(i.map((r,a)=>a===0?r:ou(r)));if(e.constructor===qe)return Ni(i)}return i[0]},Io=(s,t)=>Hd(s,t,new Ks),Bd=s=>{const t=new Map,e=k(s.restDecoder);for(let n=0;n<e;n++){const i=k(s.restDecoder),r=k(s.restDecoder);t.set(i,r)}return t},Ul=s=>Bd(new Ll(Te(s))),Vl=(s,t)=>(S(s.restEncoder,t.size),oe(t.entries()).sort((e,n)=>n[0]-e[0]).forEach(([e,n])=>{S(s.restEncoder,e),S(s.restEncoder,n)}),s),zd=(s,t)=>Vl(s,Gi(t.store)),jd=(s,t=new Nl)=>(s instanceof Map?Vl(t,s):zd(t,s),t.toUint8Array()),Wd=s=>jd(s,new Ol);class Yd{constructor(){this.l=[]}}const ga=()=>new Yd,ma=(s,t)=>s.l.push(t),ya=(s,t)=>{const e=s.l,n=e.length;s.l=e.filter(i=>t!==i),n===s.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},Fl=(s,t,e)=>Eo(s.l,[t,e]);class hn{constructor(t,e){this.client=t,this.clock=e}}const ti=(s,t)=>s===t||s!==null&&t!==null&&s.client===t.client&&s.clock===t.clock,A=(s,t)=>new hn(s,t),Gd=s=>{for(const[t,e]of s.doc.share.entries())if(e===s)return t;throw Bt()},Oi=(s,t)=>{for(;t!==null;){if(t.parent===s)return!0;t=t.parent._item}return!1},an=(s,t)=>t===void 0?!s.deleted:t.sv.has(s.id.client)&&(t.sv.get(s.id.client)||0)>s.id.clock&&!qs(t.ds,s.id),Gr=(s,t)=>{const e=Wt(s.meta,Gr,Ce),n=s.doc.store;e.has(t)||(t.sv.forEach((i,r)=>{i<W(n,r)&&lt(s,A(r,i))}),_n(s,t.ds,i=>{}),e.add(t))};class Pl{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const Gi=s=>{const t=new Map;return s.clients.forEach((e,n)=>{const i=e[e.length-1];t.set(n,i.id.clock+i.length)}),t},W=(s,t)=>{const e=s.clients.get(t);if(e===void 0)return 0;const n=e[e.length-1];return n.id.clock+n.length},Hl=(s,t)=>{let e=s.clients.get(t.id.client);if(e===void 0)e=[],s.clients.set(t.id.client,e);else{const n=e[e.length-1];if(n.id.clock+n.length!==t.id.clock)throw Bt()}e.push(t)},zt=(s,t)=>{let e=0,n=s.length-1,i=s[n],r=i.id.clock;if(r===t)return n;let a=ae(t/(r+i.length-1)*n);for(;e<=n;){if(i=s[a],r=i.id.clock,r<=t){if(t<r+i.length)return a;e=a+1}else n=a-1;a=ae((e+n)/2)}throw Bt()},Jd=(s,t)=>{const e=s.clients.get(t.client);return e[zt(e,t.clock)]},hi=Jd,Jr=(s,t,e)=>{const n=zt(t,e),i=t[n];return i.id.clock<e&&i instanceof N?(t.splice(n+1,0,Pi(s,i,e-i.id.clock)),n+1):n},lt=(s,t)=>{const e=s.doc.store.clients.get(t.client);return e[Jr(s,e,t.clock)]},wa=(s,t,e)=>{const n=t.clients.get(e.client),i=zt(n,e.clock),r=n[i];return e.clock!==r.id.clock+r.length-1&&r.constructor!==St&&n.splice(i+1,0,Pi(s,r,e.clock-r.id.clock+1)),r},qd=(s,t,e)=>{const n=s.clients.get(t.id.client);n[zt(n,t.id.clock)]=e},Bl=(s,t,e,n,i)=>{if(n===0)return;const r=e+n;let a=Jr(s,t,e),l;do l=t[a++],r<l.id.clock+l.length&&Jr(s,t,r),i(l);while(a<t.length&&t[a].id.clock<r)};class Kd{constructor(t,e,n){this.doc=t,this.deleteSet=new $n,this.beforeState=Gi(t.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=e,this.meta=new Map,this.local=n,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const ba=(s,t)=>t.deleteSet.clients.size===0&&!fh(t.afterState,(e,n)=>t.beforeState.get(n)!==e)?!1:(ko(t.deleteSet),Vd(s,t),Un(s,t.deleteSet),!0),Ea=(s,t,e)=>{const n=t._item;(n===null||n.id.clock<(s.beforeState.get(n.id.client)||0)&&!n.deleted)&&Wt(s.changed,t,Ce).add(e)},di=(s,t)=>{let e=s[t],n=s[t-1],i=t;for(;i>0;e=n,n=s[--i-1]){if(n.deleted===e.deleted&&n.constructor===e.constructor&&n.mergeWith(e)){e instanceof N&&e.parentSub!==null&&e.parent._map.get(e.parentSub)===e&&e.parent._map.set(e.parentSub,n);continue}break}const r=t-i;return r&&s.splice(t+1-r,r),r},Xd=(s,t,e)=>{for(const[n,i]of s.clients.entries()){const r=t.clients.get(n);for(let a=i.length-1;a>=0;a--){const l=i[a],c=l.clock+l.len;for(let h=zt(r,l.clock),d=r[h];h<r.length&&d.id.clock<c;d=r[++h]){const u=r[h];if(l.clock+l.len<=u.id.clock)break;u instanceof N&&u.deleted&&!u.keep&&e(u)&&u.gc(t,!1)}}}},Zd=(s,t)=>{s.clients.forEach((e,n)=>{const i=t.clients.get(n);for(let r=e.length-1;r>=0;r--){const a=e[r],l=fo(i.length-1,1+zt(i,a.clock+a.len-1));for(let c=l,h=i[c];c>0&&h.id.clock>=a.clock;h=i[c])c-=1+di(i,c)}})},zl=(s,t)=>{if(t<s.length){const e=s[t],n=e.doc,i=n.store,r=e.deleteSet,a=e._mergeStructs;try{ko(r),e.afterState=Gi(e.doc.store),n.emit("beforeObserverCalls",[e,n]);const l=[];e.changed.forEach((c,h)=>l.push(()=>{(h._item===null||!h._item.deleted)&&h._callObserver(e,c)})),l.push(()=>{e.changedParentTypes.forEach((c,h)=>{h._dEH.l.length>0&&(h._item===null||!h._item.deleted)&&(c=c.filter(d=>d.target._item===null||!d.target._item.deleted),c.forEach(d=>{d.currentTarget=h,d._path=null}),c.sort((d,u)=>d.path.length-u.path.length),Fl(h._dEH,c,e))})}),l.push(()=>n.emit("afterTransaction",[e,n])),Eo(l,[]),e._needFormattingCleanup&&Eu(e)}finally{n.gc&&Xd(r,i,n.gcFilter),Zd(r,i),e.afterState.forEach((d,u)=>{const f=e.beforeState.get(u)||0;if(f!==d){const p=i.clients.get(u),g=tn(zt(p,f),1);for(let b=p.length-1;b>=g;)b-=1+di(p,b)}});for(let d=a.length-1;d>=0;d--){const{client:u,clock:f}=a[d].id,p=i.clients.get(u),g=zt(p,f);g+1<p.length&&di(p,g+1)>1||g>0&&di(p,g)}if(!e.local&&e.afterState.get(n.clientID)!==e.beforeState.get(n.clientID)&&(Dd(vo,kl,"[yjs] ",xl,Cl,"Changed the client-id because another client seems to be using it."),n.clientID=Tl()),n.emit("afterTransactionCleanup",[e,n]),n._observers.has("update")){const d=new Ks;ba(d,e)&&n.emit("update",[d.toUint8Array(),e.origin,n,e])}if(n._observers.has("updateV2")){const d=new qe;ba(d,e)&&n.emit("updateV2",[d.toUint8Array(),e.origin,n,e])}const{subdocsAdded:l,subdocsLoaded:c,subdocsRemoved:h}=e;(l.size>0||h.size>0||c.size>0)&&(l.forEach(d=>{d.clientID=n.clientID,d.collectionid==null&&(d.collectionid=n.collectionid),n.subdocs.add(d)}),h.forEach(d=>n.subdocs.delete(d)),n.emit("subdocs",[{loaded:c,added:l,removed:h},n,e]),h.forEach(d=>d.destroy())),s.length<=t+1?(n._transactionCleanups=[],n.emit("afterAllTransactions",[n,s])):zl(s,t+1)}}},T=(s,t,e=null,n=!0)=>{const i=s._transactionCleanups;let r=!1,a=null;s._transaction===null&&(r=!0,s._transaction=new Kd(s,e,n),i.push(s._transaction),i.length===1&&s.emit("beforeAllTransactions",[s]),s.emit("beforeTransaction",[s._transaction,s]));try{a=t(s._transaction)}finally{if(r){const l=s._transaction===i[0];s._transaction=null,l&&zl(i,0)}}return a};class Qd{constructor(t,e){this.insertions=e,this.deletions=t,this.meta=new Map}}const va=(s,t,e)=>{_n(s,e.deletions,n=>{n instanceof N&&t.scope.some(i=>Oi(i,n))&&No(n,!1)})},Sa=(s,t,e)=>{let n=null;const i=s.doc,r=s.scope;T(i,l=>{for(;t.length>0&&s.currStackItem===null;){const c=i.store,h=t.pop(),d=new Set,u=[];let f=!1;_n(l,h.insertions,p=>{if(p instanceof N){if(p.redone!==null){let{item:g,diff:b}=Gu(c,p.id);b>0&&(g=lt(l,A(g.id.client,g.id.clock+b))),p=g}!p.deleted&&r.some(g=>Oi(g,p))&&u.push(p)}}),_n(l,h.deletions,p=>{p instanceof N&&r.some(g=>Oi(g,p))&&!qs(h.insertions,p.id)&&d.add(p)}),d.forEach(p=>{f=ac(l,p,d,h.insertions,s.ignoreRemoteMapChanges,s)!==null||f});for(let p=u.length-1;p>=0;p--){const g=u[p];s.deleteFilter(g)&&(g.delete(l),f=!0)}s.currStackItem=f?h:null}l.changed.forEach((c,h)=>{c.has(null)&&h._searchMarker&&(h._searchMarker.length=0)}),n=l},s);const a=s.currStackItem;if(a!=null){const l=n.changedParentTypes;s.emit("stack-item-popped",[{stackItem:a,type:e,changedParentTypes:l,origin:s},s]),s.currStackItem=null}return a};class tu extends uo{constructor(t,{captureTimeout:e=500,captureTransaction:n=c=>!0,deleteFilter:i=()=>!0,trackedOrigins:r=new Set([null]),ignoreRemoteMapChanges:a=!1,doc:l=Hr(t)?t[0].doc:t.doc}={}){super(),this.scope=[],this.doc=l,this.addToScope(t),this.deleteFilter=i,r.add(this),this.trackedOrigins=r,this.captureTransaction=n,this.undoStack=[],this.redoStack=[],this.undoing=!1,this.redoing=!1,this.currStackItem=null,this.lastChange=0,this.ignoreRemoteMapChanges=a,this.captureTimeout=e,this.afterTransactionHandler=c=>{if(!this.captureTransaction(c)||!this.scope.some(E=>c.changedParentTypes.has(E))||!this.trackedOrigins.has(c.origin)&&(!c.origin||!this.trackedOrigins.has(c.origin.constructor)))return;const h=this.undoing,d=this.redoing,u=h?this.redoStack:this.undoStack;h?this.stopCapturing():d||this.clear(!1,!0);const f=new $n;c.afterState.forEach((E,x)=>{const Le=c.beforeState.get(x)||0,sn=E-Le;sn>0&&ds(f,x,Le,sn)});const p=Ie();let g=!1;if(this.lastChange>0&&p-this.lastChange<this.captureTimeout&&u.length>0&&!h&&!d){const E=u[u.length-1];E.deletions=Yr([E.deletions,c.deleteSet]),E.insertions=Yr([E.insertions,f])}else u.push(new Qd(c.deleteSet,f)),g=!0;!h&&!d&&(this.lastChange=p),_n(c,c.deleteSet,E=>{E instanceof N&&this.scope.some(x=>Oi(x,E))&&No(E,!0)});const b=[{stackItem:u[u.length-1],origin:c.origin,type:h?"redo":"undo",changedParentTypes:c.changedParentTypes},this];g?this.emit("stack-item-added",b):this.emit("stack-item-updated",b)},this.doc.on("afterTransaction",this.afterTransactionHandler),this.doc.on("destroy",()=>{this.destroy()})}addToScope(t){t=Hr(t)?t:[t],t.forEach(e=>{this.scope.every(n=>n!==e)&&(e.doc!==this.doc&&Al("[yjs#509] Not same Y.Doc"),this.scope.push(e))})}addTrackedOrigin(t){this.trackedOrigins.add(t)}removeTrackedOrigin(t){this.trackedOrigins.delete(t)}clear(t=!0,e=!0){(t&&this.canUndo()||e&&this.canRedo())&&this.doc.transact(n=>{t&&(this.undoStack.forEach(i=>va(n,this,i)),this.undoStack=[]),e&&(this.redoStack.forEach(i=>va(n,this,i)),this.redoStack=[]),this.emit("stack-cleared",[{undoStackCleared:t,redoStackCleared:e}])})}stopCapturing(){this.lastChange=0}undo(){this.undoing=!0;let t;try{t=Sa(this,this.undoStack,"undo")}finally{this.undoing=!1}return t}redo(){this.redoing=!0;let t;try{t=Sa(this,this.redoStack,"redo")}finally{this.redoing=!1}return t}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}destroy(){this.trackedOrigins.delete(this),this.doc.off("afterTransaction",this.afterTransactionHandler),super.destroy()}}function*eu(s){const t=k(s.restDecoder);for(let e=0;e<t;e++){const n=k(s.restDecoder),i=s.readClient();let r=k(s.restDecoder);for(let a=0;a<n;a++){const l=s.readInfo();if(l===10){const c=k(s.restDecoder);yield new kt(A(i,r),c),r+=c}else if(ji&l){const c=(l&(re|pt))===0,h=new N(A(i,r),null,(l&pt)===pt?s.readLeftID():null,null,(l&re)===re?s.readRightID():null,c?s.readParentInfo()?s.readString():s.readLeftID():null,c&&(l&as)===as?s.readString():null,lc(s,l));yield h,r+=h.length}else{const c=s.readLen();yield new St(A(i,r),c),r+=c}}}}class Ao{constructor(t,e){this.gen=eu(t),this.curr=null,this.done=!1,this.filterSkips=e,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===kt);return this.curr}}class _o{constructor(t){this.currClient=0,this.startClock=0,this.written=0,this.encoder=t,this.clientStructs=[]}}const nu=s=>Ni(s,Ml,Ks),su=(s,t)=>{if(s.constructor===St){const{client:e,clock:n}=s.id;return new St(A(e,n+t),s.length-t)}else if(s.constructor===kt){const{client:e,clock:n}=s.id;return new kt(A(e,n+t),s.length-t)}else{const e=s,{client:n,clock:i}=e.id;return new N(A(n,i+t),null,A(n,i+t-1),null,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t))}},Ni=(s,t=Dn,e=qe)=>{if(s.length===1)return s[0];const n=s.map(d=>new t(Te(d)));let i=n.map(d=>new Ao(d,!0)),r=null;const a=new e,l=new _o(a);for(;i=i.filter(f=>f.curr!==null),i.sort((f,p)=>{if(f.curr.id.client===p.curr.id.client){const g=f.curr.id.clock-p.curr.id.clock;return g===0?f.curr.constructor===p.curr.constructor?0:f.curr.constructor===kt?1:-1:g}else return p.curr.id.client-f.curr.id.client}),i.length!==0;){const d=i[0],u=d.curr.id.client;if(r!==null){let f=d.curr,p=!1;for(;f!==null&&f.id.clock+f.length<=r.struct.id.clock+r.struct.length&&f.id.client>=r.struct.id.client;)f=d.next(),p=!0;if(f===null||f.id.client!==u||p&&f.id.clock>r.struct.id.clock+r.struct.length)continue;if(u!==r.struct.id.client)pe(l,r.struct,r.offset),r={struct:f,offset:0},d.next();else if(r.struct.id.clock+r.struct.length<f.id.clock)if(r.struct.constructor===kt)r.struct.length=f.id.clock+f.length-r.struct.id.clock;else{pe(l,r.struct,r.offset);const g=f.id.clock-r.struct.id.clock-r.struct.length;r={struct:new kt(A(u,r.struct.id.clock+r.struct.length),g),offset:0}}else{const g=r.struct.id.clock+r.struct.length-f.id.clock;g>0&&(r.struct.constructor===kt?r.struct.length-=g:f=su(f,g)),r.struct.mergeWith(f)||(pe(l,r.struct,r.offset),r={struct:f,offset:0},d.next())}}else r={struct:d.curr,offset:0},d.next();for(let f=d.curr;f!==null&&f.id.client===u&&f.id.clock===r.struct.id.clock+r.struct.length&&f.constructor!==kt;f=d.next())pe(l,r.struct,r.offset),r={struct:f,offset:0}}r!==null&&(pe(l,r.struct,r.offset),r=null),Do(l);const c=n.map(d=>xo(d)),h=Yr(c);return Un(a,h),a.toUint8Array()},iu=(s,t,e=Dn,n=qe)=>{const i=Ul(t),r=new n,a=new _o(r),l=new e(Te(s)),c=new Ao(l,!1);for(;c.curr;){const d=c.curr,u=d.id.client,f=i.get(u)||0;if(c.curr.constructor===kt){c.next();continue}if(d.id.clock+d.length>f)for(pe(a,d,tn(f-d.id.clock,0)),c.next();c.curr&&c.curr.id.client===u;)pe(a,c.curr,0),c.next();else for(;c.curr&&c.curr.id.client===u&&c.curr.id.clock+c.curr.length<=f;)c.next()}Do(a);const h=xo(l);return Un(r,h),r.toUint8Array()},jl=s=>{s.written>0&&(s.clientStructs.push({written:s.written,restEncoder:R(s.encoder.restEncoder)}),s.encoder.restEncoder=X(),s.written=0)},pe=(s,t,e)=>{s.written>0&&s.currClient!==t.id.client&&jl(s),s.written===0&&(s.currClient=t.id.client,s.encoder.writeClient(t.id.client),S(s.encoder.restEncoder,t.id.clock+e)),t.write(s.encoder,e),s.written++},Do=s=>{jl(s);const t=s.encoder.restEncoder;S(t,s.clientStructs.length);for(let e=0;e<s.clientStructs.length;e++){const n=s.clientStructs[e];S(t,n.written),Wi(t,n.restEncoder)}},ru=(s,t,e,n)=>{const i=new e(Te(s)),r=new Ao(i,!1),a=new n,l=new _o(a);for(let h=r.curr;h!==null;h=r.next())pe(l,t(h),0);Do(l);const c=xo(i);return Un(a,c),a.toUint8Array()},ou=s=>ru(s,id,Dn,Ks),ka="You must not compute changes after the event-handler fired.";class Ji{constructor(t,e){this.target=t,this.currentTarget=t,this.transaction=e,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=au(this.currentTarget,this.target))}deletes(t){return qs(this.transaction.deleteSet,t.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw le(ka);const t=new Map,e=this.target;this.transaction.changed.get(e).forEach(i=>{if(i!==null){const r=e._map.get(i);let a,l;if(this.adds(r)){let c=r.left;for(;c!==null&&this.adds(c);)c=c.left;if(this.deletes(r))if(c!==null&&this.deletes(c))a="delete",l=er(c.content.getContent());else return;else c!==null&&this.deletes(c)?(a="update",l=er(c.content.getContent())):(a="add",l=void 0)}else if(this.deletes(r))a="delete",l=er(r.content.getContent());else return;t.set(i,{action:a,oldValue:l})}}),this._keys=t}return this._keys}get delta(){return this.changes.delta}adds(t){return t.id.clock>=(this.transaction.beforeState.get(t.id.client)||0)}get changes(){let t=this._changes;if(t===null){if(this.transaction.doc._transactionCleanups.length===0)throw le(ka);const e=this.target,n=Ce(),i=Ce(),r=[];if(t={added:n,deleted:i,delta:r,keys:this.keys},this.transaction.changed.get(e).has(null)){let l=null;const c=()=>{l&&r.push(l)};for(let h=e._start;h!==null;h=h.right)h.deleted?this.deletes(h)&&!this.adds(h)&&((l===null||l.delete===void 0)&&(c(),l={delete:0}),l.delete+=h.length,i.add(h)):this.adds(h)?((l===null||l.insert===void 0)&&(c(),l={insert:[]}),l.insert=l.insert.concat(h.content.getContent()),n.add(h)):((l===null||l.retain===void 0)&&(c(),l={retain:0}),l.retain+=h.length);l!==null&&l.retain===void 0&&c()}this._changes=t}return t}}const au=(s,t)=>{const e=[];for(;t._item!==null&&t!==s;){if(t._item.parentSub!==null)e.unshift(t._item.parentSub);else{let n=0,i=t._item.parent._start;for(;i!==t._item&&i!==null;)!i.deleted&&i.countable&&(n+=i.length),i=i.right;e.unshift(n)}t=t._item.parent}return e},Z=()=>{Al("Invalid access: Add Yjs type to a document before reading data.")},Wl=80;let To=0;class lu{constructor(t,e){t.marker=!0,this.p=t,this.index=e,this.timestamp=To++}}const cu=s=>{s.timestamp=To++},Yl=(s,t,e)=>{s.p.marker=!1,s.p=t,t.marker=!0,s.index=e,s.timestamp=To++},hu=(s,t,e)=>{if(s.length>=Wl){const n=s.reduce((i,r)=>i.timestamp<r.timestamp?i:r);return Yl(n,t,e),n}else{const n=new lu(t,e);return s.push(n),n}},qi=(s,t)=>{if(s._start===null||t===0||s._searchMarker===null)return null;const e=s._searchMarker.length===0?null:s._searchMarker.reduce((r,a)=>ai(t-r.index)<ai(t-a.index)?r:a);let n=s._start,i=0;for(e!==null&&(n=e.p,i=e.index,cu(e));n.right!==null&&i<t;){if(!n.deleted&&n.countable){if(t<i+n.length)break;i+=n.length}n=n.right}for(;n.left!==null&&i>t;)n=n.left,!n.deleted&&n.countable&&(i-=n.length);for(;n.left!==null&&n.left.id.client===n.id.client&&n.left.id.clock+n.left.length===n.id.clock;)n=n.left,!n.deleted&&n.countable&&(i-=n.length);return e!==null&&ai(e.index-i)<n.parent.length/Wl?(Yl(e,n,i),e):hu(s._searchMarker,n,i)},us=(s,t,e)=>{for(let n=s.length-1;n>=0;n--){const i=s[n];if(e>0){let r=i.p;for(r.marker=!1;r&&(r.deleted||!r.countable);)r=r.left,r&&!r.deleted&&r.countable&&(i.index-=r.length);if(r===null||r.marker===!0){s.splice(n,1);continue}i.p=r,r.marker=!0}(t<i.index||e>0&&t===i.index)&&(i.index=tn(t,i.index+e))}},Ki=(s,t,e)=>{const n=s,i=t.changedParentTypes;for(;Wt(i,s,()=>[]).push(e),s._item!==null;)s=s._item.parent;Fl(n._eH,e,t)};class q{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=ga(),this._dEH=ga(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(t,e){this.doc=t,this._item=e}_copy(){throw Pt()}clone(){throw Pt()}_write(t){}get _first(){let t=this._start;for(;t!==null&&t.deleted;)t=t.right;return t}_callObserver(t,e){!t.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(t){ma(this._eH,t)}observeDeep(t){ma(this._dEH,t)}unobserve(t){ya(this._eH,t)}unobserveDeep(t){ya(this._dEH,t)}toJSON(){}}const Gl=(s,t,e)=>{s.doc??Z(),t<0&&(t=s._length+t),e<0&&(e=s._length+e);let n=e-t;const i=[];let r=s._start;for(;r!==null&&n>0;){if(r.countable&&!r.deleted){const a=r.content.getContent();if(a.length<=t)t-=a.length;else{for(let l=t;l<a.length&&n>0;l++)i.push(a[l]),n--;t=0}}r=r.right}return i},Jl=s=>{s.doc??Z();const t=[];let e=s._start;for(;e!==null;){if(e.countable&&!e.deleted){const n=e.content.getContent();for(let i=0;i<n.length;i++)t.push(n[i])}e=e.right}return t},fs=(s,t)=>{let e=0,n=s._start;for(s.doc??Z();n!==null;){if(n.countable&&!n.deleted){const i=n.content.getContent();for(let r=0;r<i.length;r++)t(i[r],e++,s)}n=n.right}},ql=(s,t)=>{const e=[];return fs(s,(n,i)=>{e.push(t(n,i,s))}),e},du=s=>{let t=s._start,e=null,n=0;return{[Symbol.iterator](){return this},next:()=>{if(e===null){for(;t!==null&&t.deleted;)t=t.right;if(t===null)return{done:!0,value:void 0};e=t.content.getContent(),n=0,t=t.right}const i=e[n++];return e.length<=n&&(e=null),{done:!1,value:i}}}},Kl=(s,t)=>{s.doc??Z();const e=qi(s,t);let n=s._start;for(e!==null&&(n=e.p,t-=e.index);n!==null;n=n.right)if(!n.deleted&&n.countable){if(t<n.length)return n.content.getContent()[t];t-=n.length}},Ri=(s,t,e,n)=>{let i=e;const r=s.doc,a=r.clientID,l=r.store,c=e===null?t._start:e.right;let h=[];const d=()=>{h.length>0&&(i=new N(A(a,W(l,a)),i,i&&i.lastId,c,c&&c.id,t,null,new Xe(h)),i.integrate(s,0),h=[])};n.forEach(u=>{if(u===null)h.push(u);else switch(u.constructor){case Number:case Object:case Boolean:case Array:case String:h.push(u);break;default:switch(d(),u.constructor){case Uint8Array:case ArrayBuffer:i=new N(A(a,W(l,a)),i,i&&i.lastId,c,c&&c.id,t,null,new Xs(new Uint8Array(u))),i.integrate(s,0);break;case Vn:i=new N(A(a,W(l,a)),i,i&&i.lastId,c,c&&c.id,t,null,new Zs(u)),i.integrate(s,0);break;default:if(u instanceof q)i=new N(A(a,W(l,a)),i,i&&i.lastId,c,c&&c.id,t,null,new de(u)),i.integrate(s,0);else throw new Error("Unexpected content type in insert operation")}}}),d()},Xl=()=>le("Length exceeded!"),Zl=(s,t,e,n)=>{if(e>t._length)throw Xl();if(e===0)return t._searchMarker&&us(t._searchMarker,e,n.length),Ri(s,t,null,n);const i=e,r=qi(t,e);let a=t._start;for(r!==null&&(a=r.p,e-=r.index,e===0&&(a=a.prev,e+=a&&a.countable&&!a.deleted?a.length:0));a!==null;a=a.right)if(!a.deleted&&a.countable){if(e<=a.length){e<a.length&&lt(s,A(a.id.client,a.id.clock+e));break}e-=a.length}return t._searchMarker&&us(t._searchMarker,i,n.length),Ri(s,t,a,n)},uu=(s,t,e)=>{let i=(t._searchMarker||[]).reduce((r,a)=>a.index>r.index?a:r,{index:0,p:t._start}).p;if(i)for(;i.right;)i=i.right;return Ri(s,t,i,e)},Ql=(s,t,e,n)=>{if(n===0)return;const i=e,r=n,a=qi(t,e);let l=t._start;for(a!==null&&(l=a.p,e-=a.index);l!==null&&e>0;l=l.right)!l.deleted&&l.countable&&(e<l.length&&lt(s,A(l.id.client,l.id.clock+e)),e-=l.length);for(;n>0&&l!==null;)l.deleted||(n<l.length&&lt(s,A(l.id.client,l.id.clock+n)),l.delete(s),n-=l.length),l=l.right;if(n>0)throw Xl();t._searchMarker&&us(t._searchMarker,i,-r+n)},$i=(s,t,e)=>{const n=t._map.get(e);n!==void 0&&n.delete(s)},Lo=(s,t,e,n)=>{const i=t._map.get(e)||null,r=s.doc,a=r.clientID;let l;if(n==null)l=new Xe([n]);else switch(n.constructor){case Number:case Object:case Boolean:case Array:case String:l=new Xe([n]);break;case Uint8Array:l=new Xs(n);break;case Vn:l=new Zs(n);break;default:if(n instanceof q)l=new de(n);else throw new Error("Unexpected content type")}new N(A(a,W(r.store,a)),i,i&&i.lastId,null,null,t,e,l).integrate(s,0)},Mo=(s,t)=>{s.doc??Z();const e=s._map.get(t);return e!==void 0&&!e.deleted?e.content.getContent()[e.length-1]:void 0},tc=s=>{const t={};return s.doc??Z(),s._map.forEach((e,n)=>{e.deleted||(t[n]=e.content.getContent()[e.length-1])}),t},ec=(s,t)=>{s.doc??Z();const e=s._map.get(t);return e!==void 0&&!e.deleted},fu=(s,t)=>{const e={};return s._map.forEach((n,i)=>{let r=n;for(;r!==null&&(!t.sv.has(r.id.client)||r.id.clock>=(t.sv.get(r.id.client)||0));)r=r.left;r!==null&&an(r,t)&&(e[i]=r.content.getContent()[r.length-1])}),e},ei=s=>(s.doc??Z(),Td(s._map.entries(),t=>!t[1].deleted));class pu extends Ji{}class dn extends q{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(t){const e=new dn;return e.push(t),e}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new dn}clone(){const t=new dn;return t.insert(0,this.toArray().map(e=>e instanceof q?e.clone():e)),t}get length(){return this.doc??Z(),this._length}_callObserver(t,e){super._callObserver(t,e),Ki(this,t,new pu(this,t))}insert(t,e){this.doc!==null?T(this.doc,n=>{Zl(n,this,t,e)}):this._prelimContent.splice(t,0,...e)}push(t){this.doc!==null?T(this.doc,e=>{uu(e,this,t)}):this._prelimContent.push(...t)}unshift(t){this.insert(0,t)}delete(t,e=1){this.doc!==null?T(this.doc,n=>{Ql(n,this,t,e)}):this._prelimContent.splice(t,e)}get(t){return Kl(this,t)}toArray(){return Jl(this)}slice(t=0,e=this.length){return Gl(this,t,e)}toJSON(){return this.map(t=>t instanceof q?t.toJSON():t)}map(t){return ql(this,t)}forEach(t){fs(this,t)}[Symbol.iterator](){return du(this)}_write(t){t.writeTypeRef(Fu)}}const gu=s=>new dn;class mu extends Ji{constructor(t,e,n){super(t,e),this.keysChanged=n}}class Tn extends q{constructor(t){super(),this._prelimContent=null,t===void 0?this._prelimContent=new Map:this._prelimContent=new Map(t)}_integrate(t,e){super._integrate(t,e),this._prelimContent.forEach((n,i)=>{this.set(i,n)}),this._prelimContent=null}_copy(){return new Tn}clone(){const t=new Tn;return this.forEach((e,n)=>{t.set(n,e instanceof q?e.clone():e)}),t}_callObserver(t,e){Ki(this,t,new mu(this,t,e))}toJSON(){this.doc??Z();const t={};return this._map.forEach((e,n)=>{if(!e.deleted){const i=e.content.getContent()[e.length-1];t[n]=i instanceof q?i.toJSON():i}}),t}get size(){return[...ei(this)].length}keys(){return or(ei(this),t=>t[0])}values(){return or(ei(this),t=>t[1].content.getContent()[t[1].length-1])}entries(){return or(ei(this),t=>[t[0],t[1].content.getContent()[t[1].length-1]])}forEach(t){this.doc??Z(),this._map.forEach((e,n)=>{e.deleted||t(e.content.getContent()[e.length-1],n,this)})}[Symbol.iterator](){return this.entries()}delete(t){this.doc!==null?T(this.doc,e=>{$i(e,this,t)}):this._prelimContent.delete(t)}set(t,e){return this.doc!==null?T(this.doc,n=>{Lo(n,this,t,e)}):this._prelimContent.set(t,e),e}get(t){return Mo(this,t)}has(t){return ec(this,t)}clear(){this.doc!==null?T(this.doc,t=>{this.forEach(function(e,n,i){$i(t,i,n)})}):this._prelimContent.clear()}_write(t){t.writeTypeRef(Pu)}}const yu=s=>new Tn,ke=(s,t)=>s===t||typeof s=="object"&&typeof t=="object"&&s&&t&&nd(s,t);class qr{constructor(t,e,n,i){this.left=t,this.right=e,this.index=n,this.currentAttributes=i}forward(){switch(this.right===null&&Bt(),this.right.content.constructor){case Y:this.right.deleted||Fn(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const xa=(s,t,e)=>{for(;t.right!==null&&e>0;){switch(t.right.content.constructor){case Y:t.right.deleted||Fn(t.currentAttributes,t.right.content);break;default:t.right.deleted||(e<t.right.length&&lt(s,A(t.right.id.client,t.right.id.clock+e)),t.index+=t.right.length,e-=t.right.length);break}t.left=t.right,t.right=t.right.right}return t},ni=(s,t,e,n)=>{const i=new Map,r=n?qi(t,e):null;if(r){const a=new qr(r.p.left,r.p,r.index,i);return xa(s,a,e-r.index)}else{const a=new qr(null,t._start,0,i);return xa(s,a,e)}},nc=(s,t,e,n)=>{for(;e.right!==null&&(e.right.deleted===!0||e.right.content.constructor===Y&&ke(n.get(e.right.content.key),e.right.content.value));)e.right.deleted||n.delete(e.right.content.key),e.forward();const i=s.doc,r=i.clientID;n.forEach((a,l)=>{const c=e.left,h=e.right,d=new N(A(r,W(i.store,r)),c,c&&c.lastId,h,h&&h.id,t,null,new Y(l,a));d.integrate(s,0),e.right=d,e.forward()})},Fn=(s,t)=>{const{key:e,value:n}=t;n===null?s.delete(e):s.set(e,n)},sc=(s,t)=>{for(;s.right!==null;){if(!(s.right.deleted||s.right.content.constructor===Y&&ke(t[s.right.content.key]??null,s.right.content.value)))break;s.forward()}},ic=(s,t,e,n)=>{const i=s.doc,r=i.clientID,a=new Map;for(const l in n){const c=n[l],h=e.currentAttributes.get(l)??null;if(!ke(h,c)){a.set(l,h);const{left:d,right:u}=e;e.right=new N(A(r,W(i.store,r)),d,d&&d.lastId,u,u&&u.id,t,null,new Y(l,c)),e.right.integrate(s,0),e.forward()}}return a},ar=(s,t,e,n,i)=>{e.currentAttributes.forEach((f,p)=>{i[p]===void 0&&(i[p]=null)});const r=s.doc,a=r.clientID;sc(e,i);const l=ic(s,t,e,i),c=n.constructor===String?new jt(n):n instanceof q?new de(n):new en(n);let{left:h,right:d,index:u}=e;t._searchMarker&&us(t._searchMarker,e.index,c.getLength()),d=new N(A(a,W(r.store,a)),h,h&&h.lastId,d,d&&d.id,t,null,c),d.integrate(s,0),e.right=d,e.index=u,e.forward(),nc(s,t,e,l)},Ca=(s,t,e,n,i)=>{const r=s.doc,a=r.clientID;sc(e,i);const l=ic(s,t,e,i);t:for(;e.right!==null&&(n>0||l.size>0&&(e.right.deleted||e.right.content.constructor===Y));){if(!e.right.deleted)switch(e.right.content.constructor){case Y:{const{key:c,value:h}=e.right.content,d=i[c];if(d!==void 0){if(ke(d,h))l.delete(c);else{if(n===0)break t;l.set(c,h)}e.right.delete(s)}else e.currentAttributes.set(c,h);break}default:n<e.right.length&&lt(s,A(e.right.id.client,e.right.id.clock+n)),n-=e.right.length;break}e.forward()}if(n>0){let c="";for(;n>0;n--)c+=`
`;e.right=new N(A(a,W(r.store,a)),e.left,e.left&&e.left.lastId,e.right,e.right&&e.right.id,t,null,new jt(c)),e.right.integrate(s,0),e.forward()}nc(s,t,e,l)},rc=(s,t,e,n,i)=>{let r=t;const a=ct();for(;r&&(!r.countable||r.deleted);){if(!r.deleted&&r.content.constructor===Y){const h=r.content;a.set(h.key,h)}r=r.right}let l=0,c=!1;for(;t!==r;){if(e===t&&(c=!0),!t.deleted){const h=t.content;switch(h.constructor){case Y:{const{key:d,value:u}=h,f=n.get(d)??null;(a.get(d)!==h||f===u)&&(t.delete(s),l++,!c&&(i.get(d)??null)===u&&f!==u&&(f===null?i.delete(d):i.set(d,f))),!c&&!t.deleted&&Fn(i,h);break}}}t=t.right}return l},wu=(s,t)=>{for(;t&&t.right&&(t.right.deleted||!t.right.countable);)t=t.right;const e=new Set;for(;t&&(t.deleted||!t.countable);){if(!t.deleted&&t.content.constructor===Y){const n=t.content.key;e.has(n)?t.delete(s):e.add(n)}t=t.left}},bu=s=>{let t=0;return T(s.doc,e=>{let n=s._start,i=s._start,r=ct();const a=Pr(r);for(;i;){if(i.deleted===!1)switch(i.content.constructor){case Y:Fn(a,i.content);break;default:t+=rc(e,n,i,r,a),r=Pr(a),n=i;break}i=i.right}}),t},Eu=s=>{const t=new Set,e=s.doc;for(const[n,i]of s.afterState.entries()){const r=s.beforeState.get(n)||0;i!==r&&Bl(s,e.store.clients.get(n),r,i,a=>{!a.deleted&&a.content.constructor===Y&&a.constructor!==St&&t.add(a.parent)})}T(e,n=>{_n(s,s.deleteSet,i=>{if(i instanceof St||!i.parent._hasFormatting||t.has(i.parent))return;const r=i.parent;i.content.constructor===Y?t.add(r):wu(n,i)});for(const i of t)bu(i)})},Ia=(s,t,e)=>{const n=e,i=Pr(t.currentAttributes),r=t.right;for(;e>0&&t.right!==null;){if(t.right.deleted===!1)switch(t.right.content.constructor){case de:case en:case jt:e<t.right.length&&lt(s,A(t.right.id.client,t.right.id.clock+e)),e-=t.right.length,t.right.delete(s);break}t.forward()}r&&rc(s,r,t.right,i,t.currentAttributes);const a=(t.left||t.right).parent;return a._searchMarker&&us(a._searchMarker,t.index,-n+e),t};class vu extends Ji{constructor(t,e,n){super(t,e),this.childListChanged=!1,this.keysChanged=new Set,n.forEach(i=>{i===null?this.childListChanged=!0:this.keysChanged.add(i)})}get changes(){if(this._changes===null){const t={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=t}return this._changes}get delta(){if(this._delta===null){const t=this.target.doc,e=[];T(t,n=>{const i=new Map,r=new Map;let a=this.target._start,l=null;const c={};let h="",d=0,u=0;const f=()=>{if(l!==null){let p=null;switch(l){case"delete":u>0&&(p={delete:u}),u=0;break;case"insert":(typeof h=="object"||h.length>0)&&(p={insert:h},i.size>0&&(p.attributes={},i.forEach((g,b)=>{g!==null&&(p.attributes[b]=g)}))),h="";break;case"retain":d>0&&(p={retain:d},td(c)||(p.attributes=Xh({},c))),d=0;break}p&&e.push(p),l=null}};for(;a!==null;){switch(a.content.constructor){case de:case en:this.adds(a)?this.deletes(a)||(f(),l="insert",h=a.content.getContent()[0],f()):this.deletes(a)?(l!=="delete"&&(f(),l="delete"),u+=1):a.deleted||(l!=="retain"&&(f(),l="retain"),d+=1);break;case jt:this.adds(a)?this.deletes(a)||(l!=="insert"&&(f(),l="insert"),h+=a.content.str):this.deletes(a)?(l!=="delete"&&(f(),l="delete"),u+=a.length):a.deleted||(l!=="retain"&&(f(),l="retain"),d+=a.length);break;case Y:{const{key:p,value:g}=a.content;if(this.adds(a)){if(!this.deletes(a)){const b=i.get(p)??null;ke(b,g)?g!==null&&a.delete(n):(l==="retain"&&f(),ke(g,r.get(p)??null)?delete c[p]:c[p]=g)}}else if(this.deletes(a)){r.set(p,g);const b=i.get(p)??null;ke(b,g)||(l==="retain"&&f(),c[p]=b)}else if(!a.deleted){r.set(p,g);const b=c[p];b!==void 0&&(ke(b,g)?b!==null&&a.delete(n):(l==="retain"&&f(),g===null?delete c[p]:c[p]=g))}a.deleted||(l==="insert"&&f(),Fn(i,a.content));break}}a=a.right}for(f();e.length>0;){const p=e[e.length-1];if(p.retain!==void 0&&p.attributes===void 0)e.pop();else break}}),this._delta=e}return this._delta}}class Ln extends q{constructor(t){super(),this._pending=t!==void 0?[()=>this.insert(0,t)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??Z(),this._length}_integrate(t,e){super._integrate(t,e);try{this._pending.forEach(n=>n())}catch(n){console.error(n)}this._pending=null}_copy(){return new Ln}clone(){const t=new Ln;return t.applyDelta(this.toDelta()),t}_callObserver(t,e){super._callObserver(t,e);const n=new vu(this,t,e);Ki(this,t,n),!t.local&&this._hasFormatting&&(t._needFormattingCleanup=!0)}toString(){this.doc??Z();let t="",e=this._start;for(;e!==null;)!e.deleted&&e.countable&&e.content.constructor===jt&&(t+=e.content.str),e=e.right;return t}toJSON(){return this.toString()}applyDelta(t,{sanitize:e=!0}={}){this.doc!==null?T(this.doc,n=>{const i=new qr(null,this._start,0,new Map);for(let r=0;r<t.length;r++){const a=t[r];if(a.insert!==void 0){const l=!e&&typeof a.insert=="string"&&r===t.length-1&&i.right===null&&a.insert.slice(-1)===`
`?a.insert.slice(0,-1):a.insert;(typeof l!="string"||l.length>0)&&ar(n,this,i,l,a.attributes||{})}else a.retain!==void 0?Ca(n,this,i,a.retain,a.attributes||{}):a.delete!==void 0&&Ia(n,i,a.delete)}}):this._pending.push(()=>this.applyDelta(t))}toDelta(t,e,n){this.doc??Z();const i=[],r=new Map,a=this.doc;let l="",c=this._start;function h(){if(l.length>0){const u={};let f=!1;r.forEach((g,b)=>{f=!0,u[b]=g});const p={insert:l};f&&(p.attributes=u),i.push(p),l=""}}const d=()=>{for(;c!==null;){if(an(c,t)||e!==void 0&&an(c,e))switch(c.content.constructor){case jt:{const u=r.get("ychange");t!==void 0&&!an(c,t)?(u===void 0||u.user!==c.id.client||u.type!=="removed")&&(h(),r.set("ychange",n?n("removed",c.id):{type:"removed"})):e!==void 0&&!an(c,e)?(u===void 0||u.user!==c.id.client||u.type!=="added")&&(h(),r.set("ychange",n?n("added",c.id):{type:"added"})):u!==void 0&&(h(),r.delete("ychange")),l+=c.content.str;break}case de:case en:{h();const u={insert:c.content.getContent()[0]};if(r.size>0){const f={};u.attributes=f,r.forEach((p,g)=>{f[g]=p})}i.push(u);break}case Y:an(c,t)&&(h(),Fn(r,c.content));break}c=c.right}h()};return t||e?T(a,u=>{t&&Gr(u,t),e&&Gr(u,e),d()},"cleanup"):d(),i}insert(t,e,n){if(e.length<=0)return;const i=this.doc;i!==null?T(i,r=>{const a=ni(r,this,t,!n);n||(n={},a.currentAttributes.forEach((l,c)=>{n[c]=l})),ar(r,this,a,e,n)}):this._pending.push(()=>this.insert(t,e,n))}insertEmbed(t,e,n){const i=this.doc;i!==null?T(i,r=>{const a=ni(r,this,t,!n);ar(r,this,a,e,n||{})}):this._pending.push(()=>this.insertEmbed(t,e,n||{}))}delete(t,e){if(e===0)return;const n=this.doc;n!==null?T(n,i=>{Ia(i,ni(i,this,t,!0),e)}):this._pending.push(()=>this.delete(t,e))}format(t,e,n){if(e===0)return;const i=this.doc;i!==null?T(i,r=>{const a=ni(r,this,t,!1);a.right!==null&&Ca(r,this,a,e,n)}):this._pending.push(()=>this.format(t,e,n))}removeAttribute(t){this.doc!==null?T(this.doc,e=>{$i(e,this,t)}):this._pending.push(()=>this.removeAttribute(t))}setAttribute(t,e){this.doc!==null?T(this.doc,n=>{Lo(n,this,t,e)}):this._pending.push(()=>this.setAttribute(t,e))}getAttribute(t){return Mo(this,t)}getAttributes(){return tc(this)}_write(t){t.writeTypeRef(Hu)}}const Su=s=>new Ln;class lr{constructor(t,e=()=>!0){this._filter=e,this._root=t,this._currentNode=t._start,this._firstCall=!0,t.doc??Z()}[Symbol.iterator](){return this}next(){let t=this._currentNode,e=t&&t.content&&t.content.type;if(t!==null&&(!this._firstCall||t.deleted||!this._filter(e)))do if(e=t.content.type,!t.deleted&&(e.constructor===Mn||e.constructor===Ke)&&e._start!==null)t=e._start;else for(;t!==null;)if(t.right!==null){t=t.right;break}else t.parent===this._root?t=null:t=t.parent._item;while(t!==null&&(t.deleted||!this._filter(t.content.type)));return this._firstCall=!1,t===null?{value:void 0,done:!0}:(this._currentNode=t,{value:t.content.type,done:!1})}}class Ke extends q{constructor(){super(),this._prelimContent=[]}get firstChild(){const t=this._first;return t?t.content.getContent()[0]:null}_integrate(t,e){super._integrate(t,e),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Ke}clone(){const t=new Ke;return t.insert(0,this.toArray().map(e=>e instanceof q?e.clone():e)),t}get length(){return this.doc??Z(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(t){return new lr(this,t)}querySelector(t){t=t.toUpperCase();const n=new lr(this,i=>i.nodeName&&i.nodeName.toUpperCase()===t).next();return n.done?null:n.value}querySelectorAll(t){return t=t.toUpperCase(),oe(new lr(this,e=>e.nodeName&&e.nodeName.toUpperCase()===t))}_callObserver(t,e){Ki(this,t,new Cu(this,e,t))}toString(){return ql(this,t=>t.toString()).join("")}toJSON(){return this.toString()}toDOM(t=document,e={},n){const i=t.createDocumentFragment();return n!==void 0&&n._createAssociation(i,this),fs(this,r=>{i.insertBefore(r.toDOM(t,e,n),null)}),i}insert(t,e){this.doc!==null?T(this.doc,n=>{Zl(n,this,t,e)}):this._prelimContent.splice(t,0,...e)}insertAfter(t,e){if(this.doc!==null)T(this.doc,n=>{const i=t&&t instanceof q?t._item:t;Ri(n,this,i,e)});else{const n=this._prelimContent,i=t===null?0:n.findIndex(r=>r===t)+1;if(i===0&&t!==null)throw le("Reference item not found");n.splice(i,0,...e)}}delete(t,e=1){this.doc!==null?T(this.doc,n=>{Ql(n,this,t,e)}):this._prelimContent.splice(t,e)}toArray(){return Jl(this)}push(t){this.insert(this.length,t)}unshift(t){this.insert(0,t)}get(t){return Kl(this,t)}slice(t=0,e=this.length){return Gl(this,t,e)}forEach(t){fs(this,t)}_write(t){t.writeTypeRef(zu)}}const ku=s=>new Ke;class Mn extends Ke{constructor(t="UNDEFINED"){super(),this.nodeName=t,this._prelimAttrs=new Map}get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_integrate(t,e){super._integrate(t,e),this._prelimAttrs.forEach((n,i)=>{this.setAttribute(i,n)}),this._prelimAttrs=null}_copy(){return new Mn(this.nodeName)}clone(){const t=new Mn(this.nodeName),e=this.getAttributes();return Zh(e,(n,i)=>{typeof n=="string"&&t.setAttribute(i,n)}),t.insert(0,this.toArray().map(n=>n instanceof q?n.clone():n)),t}toString(){const t=this.getAttributes(),e=[],n=[];for(const l in t)n.push(l);n.sort();const i=n.length;for(let l=0;l<i;l++){const c=n[l];e.push(c+'="'+t[c]+'"')}const r=this.nodeName.toLocaleLowerCase(),a=e.length>0?" "+e.join(" "):"";return`<${r}${a}>${super.toString()}</${r}>`}removeAttribute(t){this.doc!==null?T(this.doc,e=>{$i(e,this,t)}):this._prelimAttrs.delete(t)}setAttribute(t,e){this.doc!==null?T(this.doc,n=>{Lo(n,this,t,e)}):this._prelimAttrs.set(t,e)}getAttribute(t){return Mo(this,t)}hasAttribute(t){return ec(this,t)}getAttributes(t){return t?fu(this,t):tc(this)}toDOM(t=document,e={},n){const i=t.createElement(this.nodeName),r=this.getAttributes();for(const a in r){const l=r[a];typeof l=="string"&&i.setAttribute(a,l)}return fs(this,a=>{i.appendChild(a.toDOM(t,e,n))}),n!==void 0&&n._createAssociation(i,this),i}_write(t){t.writeTypeRef(Bu),t.writeKey(this.nodeName)}}const xu=s=>new Mn(s.readKey());class Cu extends Ji{constructor(t,e,n){super(t,n),this.childListChanged=!1,this.attributesChanged=new Set,e.forEach(i=>{i===null?this.childListChanged=!0:this.attributesChanged.add(i)})}}class Ui extends Tn{constructor(t){super(),this.hookName=t}_copy(){return new Ui(this.hookName)}clone(){const t=new Ui(this.hookName);return this.forEach((e,n)=>{t.set(n,e)}),t}toDOM(t=document,e={},n){const i=e[this.hookName];let r;return i!==void 0?r=i.createDom(this):r=document.createElement(this.hookName),r.setAttribute("data-yjs-hook",this.hookName),n!==void 0&&n._createAssociation(r,this),r}_write(t){t.writeTypeRef(ju),t.writeKey(this.hookName)}}const Iu=s=>new Ui(s.readKey());class Vi extends Ln{get nextSibling(){const t=this._item?this._item.next:null;return t?t.content.type:null}get prevSibling(){const t=this._item?this._item.prev:null;return t?t.content.type:null}_copy(){return new Vi}clone(){const t=new Vi;return t.applyDelta(this.toDelta()),t}toDOM(t=document,e,n){const i=t.createTextNode(this.toString());return n!==void 0&&n._createAssociation(i,this),i}toString(){return this.toDelta().map(t=>{const e=[];for(const i in t.attributes){const r=[];for(const a in t.attributes[i])r.push({key:a,value:t.attributes[i][a]});r.sort((a,l)=>a.key<l.key?-1:1),e.push({nodeName:i,attrs:r})}e.sort((i,r)=>i.nodeName<r.nodeName?-1:1);let n="";for(let i=0;i<e.length;i++){const r=e[i];n+=`<${r.nodeName}`;for(let a=0;a<r.attrs.length;a++){const l=r.attrs[a];n+=` ${l.key}="${l.value}"`}n+=">"}n+=t.insert;for(let i=e.length-1;i>=0;i--)n+=`</${e[i].nodeName}>`;return n}).join("")}toJSON(){return this.toString()}_write(t){t.writeTypeRef(Wu)}}const Au=s=>new Vi;class Oo{constructor(t,e){this.id=t,this.length=e}get deleted(){throw Pt()}mergeWith(t){return!1}write(t,e,n){throw Pt()}integrate(t,e){throw Pt()}}const _u=0;class St extends Oo{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){e>0&&(this.id.clock+=e,this.length-=e),Hl(t.doc.store,this)}write(t,e){t.writeInfo(_u),t.writeLen(this.length-e)}getMissing(t,e){return null}}class Xs{constructor(t){this.content=t}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new Xs(this.content)}splice(t){throw Pt()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeBuf(this.content)}getRef(){return 3}}const Du=s=>new Xs(s.readBuf());class ps{constructor(t){this.len=t}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new ps(this.len)}splice(t){const e=new ps(this.len-t);return this.len=t,e}mergeWith(t){return this.len+=t.len,!0}integrate(t,e){ds(t.deleteSet,e.id.client,e.id.clock,this.len),e.markDeleted()}delete(t){}gc(t){}write(t,e){t.writeLen(this.len-e)}getRef(){return 1}}const Tu=s=>new ps(s.readLen()),oc=(s,t)=>new Vn({guid:s,...t,shouldLoad:t.shouldLoad||t.autoLoad||!1});class Zs{constructor(t){t._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=t;const e={};this.opts=e,t.gc||(e.gc=!1),t.autoLoad&&(e.autoLoad=!0),t.meta!==null&&(e.meta=t.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new Zs(oc(this.doc.guid,this.opts))}splice(t){throw Pt()}mergeWith(t){return!1}integrate(t,e){this.doc._item=e,t.subdocsAdded.add(this.doc),this.doc.shouldLoad&&t.subdocsLoaded.add(this.doc)}delete(t){t.subdocsAdded.has(this.doc)?t.subdocsAdded.delete(this.doc):t.subdocsRemoved.add(this.doc)}gc(t){}write(t,e){t.writeString(this.doc.guid),t.writeAny(this.opts)}getRef(){return 9}}const Lu=s=>new Zs(oc(s.readString(),s.readAny()));class en{constructor(t){this.embed=t}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new en(this.embed)}splice(t){throw Pt()}mergeWith(t){return!1}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeJSON(this.embed)}getRef(){return 5}}const Mu=s=>new en(s.readJSON());class Y{constructor(t,e){this.key=t,this.value=e}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new Y(this.key,this.value)}splice(t){throw Pt()}mergeWith(t){return!1}integrate(t,e){const n=e.parent;n._searchMarker=null,n._hasFormatting=!0}delete(t){}gc(t){}write(t,e){t.writeKey(this.key),t.writeJSON(this.value)}getRef(){return 6}}const Ou=s=>new Y(s.readKey(),s.readJSON());class Fi{constructor(t){this.arr=t}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Fi(this.arr)}splice(t){const e=new Fi(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){const n=this.arr.length;t.writeLen(n-e);for(let i=e;i<n;i++){const r=this.arr[i];t.writeString(r===void 0?"undefined":JSON.stringify(r))}}getRef(){return 2}}const Nu=s=>{const t=s.readLen(),e=[];for(let n=0;n<t;n++){const i=s.readString();i==="undefined"?e.push(void 0):e.push(JSON.parse(i))}return new Fi(e)},Ru=Mi("node_env")==="development";class Xe{constructor(t){this.arr=t,Ru&&wl(t)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Xe(this.arr)}splice(t){const e=new Xe(this.arr.slice(t));return this.arr=this.arr.slice(0,t),e}mergeWith(t){return this.arr=this.arr.concat(t.arr),!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){const n=this.arr.length;t.writeLen(n-e);for(let i=e;i<n;i++){const r=this.arr[i];t.writeAny(r)}}getRef(){return 8}}const $u=s=>{const t=s.readLen(),e=[];for(let n=0;n<t;n++)e.push(s.readAny());return new Xe(e)};class jt{constructor(t){this.str=t}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new jt(this.str)}splice(t){const e=new jt(this.str.slice(t));this.str=this.str.slice(0,t);const n=this.str.charCodeAt(t-1);return n>=55296&&n<=56319&&(this.str=this.str.slice(0,t-1)+"�",e.str="�"+e.str.slice(1)),e}mergeWith(t){return this.str+=t.str,!0}integrate(t,e){}delete(t){}gc(t){}write(t,e){t.writeString(e===0?this.str:this.str.slice(e))}getRef(){return 4}}const Uu=s=>new jt(s.readString()),Vu=[gu,yu,Su,xu,ku,Iu,Au],Fu=0,Pu=1,Hu=2,Bu=3,zu=4,ju=5,Wu=6;class de{constructor(t){this.type=t}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new de(this.type._copy())}splice(t){throw Pt()}mergeWith(t){return!1}integrate(t,e){this.type._integrate(t.doc,e)}delete(t){let e=this.type._start;for(;e!==null;)e.deleted?e.id.clock<(t.beforeState.get(e.id.client)||0)&&t._mergeStructs.push(e):e.delete(t),e=e.right;this.type._map.forEach(n=>{n.deleted?n.id.clock<(t.beforeState.get(n.id.client)||0)&&t._mergeStructs.push(n):n.delete(t)}),t.changed.delete(this.type)}gc(t){let e=this.type._start;for(;e!==null;)e.gc(t,!0),e=e.right;this.type._start=null,this.type._map.forEach(n=>{for(;n!==null;)n.gc(t,!0),n=n.left}),this.type._map=new Map}write(t,e){this.type._write(t)}getRef(){return 7}}const Yu=s=>new de(Vu[s.readTypeRef()](s)),Gu=(s,t)=>{let e=t,n=0,i;do n>0&&(e=A(e.client,e.clock+n)),i=hi(s,e),n=e.clock-i.id.clock,e=i.redone;while(e!==null&&i instanceof N);return{item:i,diff:n}},No=(s,t)=>{for(;s!==null&&s.keep!==t;)s.keep=t,s=s.parent._item},Pi=(s,t,e)=>{const{client:n,clock:i}=t.id,r=new N(A(n,i+e),t,A(n,i+e-1),t.right,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e));return t.deleted&&r.markDeleted(),t.keep&&(r.keep=!0),t.redone!==null&&(r.redone=A(t.redone.client,t.redone.clock+e)),t.right=r,r.right!==null&&(r.right.left=r),s._mergeStructs.push(r),r.parentSub!==null&&r.right===null&&r.parent._map.set(r.parentSub,r),t.length=e,r},Aa=(s,t)=>gh(s,e=>qs(e.deletions,t)),ac=(s,t,e,n,i,r)=>{const a=s.doc,l=a.store,c=a.clientID,h=t.redone;if(h!==null)return lt(s,h);let d=t.parent._item,u=null,f;if(d!==null&&d.deleted===!0){if(d.redone===null&&(!e.has(d)||ac(s,d,e,n,i,r)===null))return null;for(;d.redone!==null;)d=lt(s,d.redone)}const p=d===null?t.parent:d.content.type;if(t.parentSub===null){for(u=t.left,f=t;u!==null;){let x=u;for(;x!==null&&x.parent._item!==d;)x=x.redone===null?null:lt(s,x.redone);if(x!==null&&x.parent._item===d){u=x;break}u=u.left}for(;f!==null;){let x=f;for(;x!==null&&x.parent._item!==d;)x=x.redone===null?null:lt(s,x.redone);if(x!==null&&x.parent._item===d){f=x;break}f=f.right}}else if(f=null,t.right&&!i){for(u=t;u!==null&&u.right!==null&&(u.right.redone||qs(n,u.right.id)||Aa(r.undoStack,u.right.id)||Aa(r.redoStack,u.right.id));)for(u=u.right;u.redone;)u=lt(s,u.redone);if(u&&u.right!==null)return null}else u=p._map.get(t.parentSub)||null;const g=W(l,c),b=A(c,g),E=new N(b,u,u&&u.lastId,f,f&&f.id,p,t.parentSub,t.content.copy());return t.redone=b,No(E,!0),E.integrate(s,0),E};class N extends Oo{constructor(t,e,n,i,r,a,l,c){super(t,c.getLength()),this.origin=n,this.left=e,this.right=i,this.rightOrigin=r,this.parent=a,this.parentSub=l,this.redone=null,this.content=c,this.info=this.content.isCountable()?ia:0}set marker(t){(this.info&sr)>0!==t&&(this.info^=sr)}get marker(){return(this.info&sr)>0}get keep(){return(this.info&sa)>0}set keep(t){this.keep!==t&&(this.info^=sa)}get countable(){return(this.info&ia)>0}get deleted(){return(this.info&nr)>0}set deleted(t){this.deleted!==t&&(this.info^=nr)}markDeleted(){this.info|=nr}getMissing(t,e){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=W(e,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=W(e,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===hn&&this.id.client!==this.parent.client&&this.parent.clock>=W(e,this.parent.client))return this.parent.client;if(this.origin&&(this.left=wa(t,e,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=lt(t,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===St||this.right&&this.right.constructor===St)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===N&&(this.parent=this.left.parent,this.parentSub=this.left.parentSub),this.right&&this.right.constructor===N&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===hn){const n=hi(e,this.parent);n.constructor===St?this.parent=null:this.parent=n.content.type}return null}integrate(t,e){if(e>0&&(this.id.clock+=e,this.left=wa(t,t.doc.store,A(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(e),this.length-=e),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let n=this.left,i;if(n!==null)i=n.right;else if(this.parentSub!==null)for(i=this.parent._map.get(this.parentSub)||null;i!==null&&i.left!==null;)i=i.left;else i=this.parent._start;const r=new Set,a=new Set;for(;i!==null&&i!==this.right;){if(a.add(i),r.add(i),ti(this.origin,i.origin)){if(i.id.client<this.id.client)n=i,r.clear();else if(ti(this.rightOrigin,i.rightOrigin))break}else if(i.origin!==null&&a.has(hi(t.doc.store,i.origin)))r.has(hi(t.doc.store,i.origin))||(n=i,r.clear());else break;i=i.right}this.left=n}if(this.left!==null){const n=this.left.right;this.right=n,this.left.right=this}else{let n;if(this.parentSub!==null)for(n=this.parent._map.get(this.parentSub)||null;n!==null&&n.left!==null;)n=n.left;else n=this.parent._start,this.parent._start=this;this.right=n}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(t)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),Hl(t.doc.store,this),this.content.integrate(t,this),Ea(t,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(t)}else new St(this.id,this.length).integrate(t,0)}get next(){let t=this.right;for(;t!==null&&t.deleted;)t=t.right;return t}get prev(){let t=this.left;for(;t!==null&&t.deleted;)t=t.left;return t}get lastId(){return this.length===1?this.id:A(this.id.client,this.id.clock+this.length-1)}mergeWith(t){if(this.constructor===t.constructor&&ti(t.origin,this.lastId)&&this.right===t&&ti(this.rightOrigin,t.rightOrigin)&&this.id.client===t.id.client&&this.id.clock+this.length===t.id.clock&&this.deleted===t.deleted&&this.redone===null&&t.redone===null&&this.content.constructor===t.content.constructor&&this.content.mergeWith(t.content)){const e=this.parent._searchMarker;return e&&e.forEach(n=>{n.p===t&&(n.p=this,!this.deleted&&this.countable&&(n.index-=this.length))}),t.keep&&(this.keep=!0),this.right=t.right,this.right!==null&&(this.right.left=this),this.length+=t.length,!0}return!1}delete(t){if(!this.deleted){const e=this.parent;this.countable&&this.parentSub===null&&(e._length-=this.length),this.markDeleted(),ds(t.deleteSet,this.id.client,this.id.clock,this.length),Ea(t,e,this.parentSub),this.content.delete(t)}}gc(t,e){if(!this.deleted)throw Bt();this.content.gc(t),e?qd(t,this,new St(this.id,this.length)):this.content=new ps(this.length)}write(t,e){const n=e>0?A(this.id.client,this.id.clock+e-1):this.origin,i=this.rightOrigin,r=this.parentSub,a=this.content.getRef()&ji|(n===null?0:pt)|(i===null?0:re)|(r===null?0:as);if(t.writeInfo(a),n!==null&&t.writeLeftID(n),i!==null&&t.writeRightID(i),n===null&&i===null){const l=this.parent;if(l._item!==void 0){const c=l._item;if(c===null){const h=Gd(l);t.writeParentInfo(!0),t.writeString(h)}else t.writeParentInfo(!1),t.writeLeftID(c.id)}else l.constructor===String?(t.writeParentInfo(!0),t.writeString(l)):l.constructor===hn?(t.writeParentInfo(!1),t.writeLeftID(l)):Bt();r!==null&&t.writeString(r)}this.content.write(t,e)}}const lc=(s,t)=>Ju[t&ji](s),Ju=[()=>{Bt()},Tu,Nu,Du,Uu,Mu,Ou,Yu,$u,Lu,()=>{Bt()}],qu=10;class kt extends Oo{get deleted(){return!0}delete(){}mergeWith(t){return this.constructor!==t.constructor?!1:(this.length+=t.length,!0)}integrate(t,e){Bt()}write(t,e){t.writeInfo(qu),S(t.restEncoder,this.length-e)}getMissing(t,e){return null}}const cc=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},hc="__ $YJS$ __";cc[hc]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");cc[hc]=!0;const nn=s=>An((t,e)=>{s.onerror=n=>e(new Error(n.target.error)),s.onsuccess=n=>t(n.target.result)}),Ku=(s,t)=>An((e,n)=>{const i=indexedDB.open(s);i.onupgradeneeded=r=>t(r.target.result),i.onerror=r=>n(le(r.target.error)),i.onsuccess=r=>{const a=r.target.result;a.onversionchange=()=>{a.close()},e(a)}}),Xu=s=>nn(indexedDB.deleteDatabase(s)),Zu=(s,t)=>t.forEach(e=>s.createObjectStore.apply(s,e)),Pn=(s,t,e="readwrite")=>{const n=s.transaction(t,e);return t.map(i=>af(n,i))},dc=(s,t)=>nn(s.count(t)),Qu=(s,t)=>nn(s.get(t)),uc=(s,t)=>nn(s.delete(t)),tf=(s,t,e)=>nn(s.put(t,e)),Kr=(s,t)=>nn(s.add(t)),ef=(s,t,e)=>nn(s.getAll(t,e)),nf=(s,t,e)=>{let n=null;return of(s,t,i=>(n=i,!1),e).then(()=>n)},sf=(s,t=null)=>nf(s,t,"prev"),rf=(s,t)=>An((e,n)=>{s.onerror=n,s.onsuccess=async i=>{const r=i.target.result;if(r===null||await t(r)===!1)return e();r.continue()}}),of=(s,t,e,n="next")=>rf(s.openKeyCursor(t,n),i=>e(i.key)),af=(s,t)=>s.objectStore(t),lf=(s,t)=>IDBKeyRange.upperBound(s,t),cf=(s,t)=>IDBKeyRange.lowerBound(s,t),cr="custom",fc="updates",pc=500,gc=(s,t=()=>{},e=()=>{})=>{const[n]=Pn(s.db,[fc]);return ef(n,cf(s._dbref,!1)).then(i=>{s._destroyed||(t(n),T(s.doc,()=>{i.forEach(r=>$l(s.doc,r))},s,!1),e(n))}).then(()=>sf(n).then(i=>{s._dbref=i+1})).then(()=>dc(n).then(i=>{s._dbsize=i})).then(()=>n)},hf=(s,t=!0)=>gc(s).then(e=>{(t||s._dbsize>=pc)&&Kr(e,Io(s.doc)).then(()=>uc(e,lf(s._dbref,!0))).then(()=>dc(e).then(n=>{s._dbsize=n}))});class df extends ll{constructor(t,e){super(),this.doc=e,this.name=t,this._dbref=0,this._dbsize=0,this._destroyed=!1,this.db=null,this.synced=!1,this._db=Ku(t,n=>Zu(n,[["updates",{autoIncrement:!0}],["custom"]])),this.whenSynced=An(n=>this.on("synced",()=>n(this))),this._db.then(n=>{this.db=n,gc(this,a=>Kr(a,Io(e)),()=>{if(this._destroyed)return this;this.synced=!0,this.emit("synced",[this])})}),this._storeTimeout=1e3,this._storeTimeoutId=null,this._storeUpdate=(n,i)=>{if(this.db&&i!==this){const[r]=Pn(this.db,[fc]);Kr(r,n),++this._dbsize>=pc&&(this._storeTimeoutId!==null&&clearTimeout(this._storeTimeoutId),this._storeTimeoutId=setTimeout(()=>{hf(this,!1),this._storeTimeoutId=null},this._storeTimeout))}},e.on("update",this._storeUpdate),this.destroy=this.destroy.bind(this),e.on("destroy",this.destroy)}destroy(){return this._storeTimeoutId&&clearTimeout(this._storeTimeoutId),this.doc.off("update",this._storeUpdate),this.doc.off("destroy",this.destroy),this._destroyed=!0,this._db.then(t=>{t.close()})}clearData(){return this.destroy().then(()=>{Xu(this.name)})}get(t){return this._db.then(e=>{const[n]=Pn(e,[cr],"readonly");return Qu(n,t)})}set(t,e){return this._db.then(n=>{const[i]=Pn(n,[cr]);return tf(i,e,t)})}del(t){return this._db.then(e=>{const[n]=Pn(e,[cr]);return uc(n,t)})}}const mc=new Map;class uf{constructor(t){this.room=t,this.onmessage=null,this._onChange=e=>e.key===t&&this.onmessage!==null&&this.onmessage({data:yd(e.newValue||"")}),qh(this._onChange)}postMessage(t){gl.setItem(this.room,md(dd(t)))}close(){Kh(this._onChange)}}const ff=typeof BroadcastChannel>"u"?uf:BroadcastChannel,Ro=s=>Wt(mc,s,()=>{const t=Ce(),e=new ff(s);return e.onmessage=n=>t.forEach(i=>i(n.data,"broadcastchannel")),{bc:e,subs:t}}),pf=(s,t)=>(Ro(s).subs.add(t),t),gf=(s,t)=>{const e=Ro(s),n=e.subs.delete(t);return n&&e.subs.size===0&&(e.bc.close(),mc.delete(s)),n},ln=(s,t,e=null)=>{const n=Ro(s);n.bc.postMessage(t),n.subs.forEach(i=>i(t,e))},yc=0,$o=1,wc=2,Xr=(s,t)=>{S(s,yc);const e=Wd(t);P(s,e)},bc=(s,t,e)=>{S(s,$o),P(s,Io(t,e))},mf=(s,t,e)=>bc(t,e,K(s)),Ec=(s,t,e)=>{try{$l(t,K(s),e)}catch(n){console.error("Caught error while handling a Yjs update",n)}},yf=(s,t)=>{S(s,wc),P(s,t)},wf=Ec,bf=(s,t,e,n)=>{const i=k(s);switch(i){case yc:mf(s,t,e);break;case $o:Ec(s,e,n);break;case wc:wf(s,e,n);break;default:throw new Error("Unknown message type")}return i},Ef=0,vf=(s,t,e)=>{switch(k(s)){case Ef:e(t,xe(s))}},hr=3e4;class Sf extends ll{constructor(t){super(),this.doc=t,this.clientID=t.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval(()=>{const e=Ie();this.getLocalState()!==null&&hr/2<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const n=[];this.meta.forEach((i,r)=>{r!==this.clientID&&hr<=e-i.lastUpdated&&this.states.has(r)&&n.push(r)}),n.length>0&&Uo(this,n,"timeout")},ae(hr/10)),t.on("destroy",()=>{this.destroy()}),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(t){const e=this.clientID,n=this.meta.get(e),i=n===void 0?0:n.clock+1,r=this.states.get(e);t===null?this.states.delete(e):this.states.set(e,t),this.meta.set(e,{clock:i,lastUpdated:Ie()});const a=[],l=[],c=[],h=[];t===null?h.push(e):r==null?t!=null&&a.push(e):(l.push(e),jn(r,t)||c.push(e)),(a.length>0||c.length>0||h.length>0)&&this.emit("change",[{added:a,updated:c,removed:h},"local"]),this.emit("update",[{added:a,updated:l,removed:h},"local"])}setLocalStateField(t,e){const n=this.getLocalState();n!==null&&this.setLocalState({...n,[t]:e})}getStates(){return this.states}}const Uo=(s,t,e)=>{const n=[];for(let i=0;i<t.length;i++){const r=t[i];if(s.states.has(r)){if(s.states.delete(r),r===s.clientID){const a=s.meta.get(r);s.meta.set(r,{clock:a.clock+1,lastUpdated:Ie()})}n.push(r)}}n.length>0&&(s.emit("change",[{added:[],updated:[],removed:n},e]),s.emit("update",[{added:[],updated:[],removed:n},e]))},Wn=(s,t,e=s.states)=>{const n=t.length,i=X();S(i,n);for(let r=0;r<n;r++){const a=t[r],l=e.get(a)||null,c=s.meta.get(a).clock;S(i,a),S(i,c),Je(i,JSON.stringify(l))}return R(i)},kf=(s,t,e)=>{const n=Te(t),i=Ie(),r=[],a=[],l=[],c=[],h=k(n);for(let d=0;d<h;d++){const u=k(n);let f=k(n);const p=JSON.parse(xe(n)),g=s.meta.get(u),b=s.states.get(u),E=g===void 0?0:g.clock;(E<f||E===f&&p===null&&s.states.has(u))&&(p===null?u===s.clientID&&s.getLocalState()!=null?f++:s.states.delete(u):s.states.set(u,p),s.meta.set(u,{clock:f,lastUpdated:i}),g===void 0&&p!==null?r.push(u):g!==void 0&&p===null?c.push(u):p!==null&&(jn(p,b)||l.push(u),a.push(u)))}(r.length>0||l.length>0||c.length>0)&&s.emit("change",[{added:r,updated:l,removed:c},e]),(r.length>0||a.length>0||c.length>0)&&s.emit("update",[{added:r,updated:a,removed:c},e])},xf=s=>Qh(s,(t,e)=>`${encodeURIComponent(e)}=${encodeURIComponent(t)}`).join("&"),$e=0,vc=3,un=1,Cf=2,Qs=[];Qs[$e]=(s,t,e,n,i)=>{S(s,$e);const r=bf(t,s,e.doc,e);n&&r===$o&&!e.synced&&(e.synced=!0)};Qs[vc]=(s,t,e,n,i)=>{S(s,un),P(s,Wn(e.awareness,Array.from(e.awareness.getStates().keys())))};Qs[un]=(s,t,e,n,i)=>{kf(e.awareness,K(t),e)};Qs[Cf]=(s,t,e,n,i)=>{vf(t,e.doc,(r,a)=>If(e,a))};const _a=3e4,If=(s,t)=>console.warn(`Permission denied to access ${s.url}.
${t}`),Sc=(s,t,e)=>{const n=Te(t),i=X(),r=k(n),a=s.messageHandlers[r];return a?a(i,n,s,e,r):console.error("Unable to compute message"),i},Zr=(s,t,e)=>{t===s.ws&&(s.emit("connection-close",[e,s]),s.ws=null,t.close(),s.wsconnecting=!1,s.wsconnected?(s.wsconnected=!1,s.synced=!1,Uo(s.awareness,Array.from(s.awareness.getStates().keys()).filter(n=>n!==s.doc.clientID),s),s.emit("status",[{status:"disconnected"}])):s.wsUnsuccessfulReconnects++,setTimeout(kc,fo(mh(2,s.wsUnsuccessfulReconnects)*100,s.maxBackoffTime),s))},kc=s=>{if(s.shouldConnect&&s.ws===null){const t=new s._WS(s.url,s.protocols);t.binaryType="arraybuffer",s.ws=t,s.wsconnecting=!0,s.wsconnected=!1,s.synced=!1,t.onmessage=e=>{s.wsLastMessageReceived=Ie();const n=Sc(s,new Uint8Array(e.data),!0);po(n)>1&&t.send(R(n))},t.onerror=e=>{s.emit("connection-error",[e,s])},t.onclose=e=>{Zr(s,t,e)},t.onopen=()=>{s.wsLastMessageReceived=Ie(),s.wsconnecting=!1,s.wsconnected=!0,s.wsUnsuccessfulReconnects=0,s.emit("status",[{status:"connected"}]);const e=X();if(S(e,$e),Xr(e,s.doc),t.send(R(e)),s.awareness.getLocalState()!==null){const n=X();S(n,un),P(n,Wn(s.awareness,[s.doc.clientID])),t.send(R(n))}},s.emit("status",[{status:"connecting"}])}},dr=(s,t)=>{const e=s.ws;s.wsconnected&&e&&e.readyState===e.OPEN&&e.send(t),s.bcconnected&&ln(s.bcChannel,t,s)};class Af extends uo{constructor(t,e,n,{connect:i=!0,awareness:r=new Sf(n),params:a={},protocols:l=[],WebSocketPolyfill:c=WebSocket,resyncInterval:h=-1,maxBackoffTime:d=2500,disableBc:u=!1}={}){for(super();t[t.length-1]==="/";)t=t.slice(0,t.length-1);this.serverUrl=t,this.bcChannel=t+"/"+e,this.maxBackoffTime=d,this.params=a,this.protocols=l,this.roomname=e,this.doc=n,this._WS=c,this.awareness=r,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=u,this.wsUnsuccessfulReconnects=0,this.messageHandlers=Qs.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=i,this._resyncInterval=0,h>0&&(this._resyncInterval=setInterval(()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const f=X();S(f,$e),Xr(f,n),this.ws.send(R(f))}},h)),this._bcSubscriber=(f,p)=>{if(p!==this){const g=Sc(this,new Uint8Array(f),!1);po(g)>1&&ln(this.bcChannel,R(g),this)}},this._updateHandler=(f,p)=>{if(p!==this){const g=X();S(g,$e),yf(g,f),dr(this,R(g))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:f,updated:p,removed:g},b)=>{const E=f.concat(p).concat(g),x=X();S(x,un),P(x,Wn(r,E)),dr(this,R(x))},this._exitHandler=()=>{Uo(this.awareness,[n.clientID],"app closed")},Ae&&typeof process<"u"&&process.on("exit",this._exitHandler),r.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval(()=>{this.wsconnected&&_a<Ie()-this.wsLastMessageReceived&&Zr(this,this.ws,null)},_a/10),i&&this.connect()}get url(){const t=xf(this.params);return this.serverUrl+"/"+this.roomname+(t.length===0?"":"?"+t)}get synced(){return this._synced}set synced(t){this._synced!==t&&(this._synced=t,this.emit("synced",[t]),this.emit("sync",[t]))}destroy(){this._resyncInterval!==0&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),Ae&&typeof process<"u"&&process.off("exit",this._exitHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;this.bcconnected||(pf(this.bcChannel,this._bcSubscriber),this.bcconnected=!0);const t=X();S(t,$e),Xr(t,this.doc),ln(this.bcChannel,R(t),this);const e=X();S(e,$e),bc(e,this.doc),ln(this.bcChannel,R(e),this);const n=X();S(n,vc),ln(this.bcChannel,R(n),this);const i=X();S(i,un),P(i,Wn(this.awareness,[this.doc.clientID])),ln(this.bcChannel,R(i),this)}disconnectBc(){const t=X();S(t,un),P(t,Wn(this.awareness,[this.doc.clientID],new Map)),dr(this,R(t)),this.bcconnected&&(gf(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),this.ws!==null&&Zr(this,this.ws,null)}connect(){this.shouldConnect=!0,!this.wsconnected&&this.ws===null&&(kc(this),this.connectBc())}}var Ee,En,vn,Sn;class _f{constructor(t){y(this,Ee);y(this,En);y(this,vn);y(this,Sn);w(this,Ee,new Vn),w(this,vn,o(this,Ee).getMap("things")),w(this,Sn,new tu(o(this,vn))),new df(t,o(this,Ee));let e;e===""?console.log("[Store] Cloud sync disabled"):(e===void 0&&(e="backend.ahoy.jrcpl.us"),console.log(`[Store] Sync server ${e}, room ${t}`),w(this,En,new Af(`wss://${e}`,t,o(this,Ee))))}get thingDataMap(){return o(this,vn)}get undoManager(){return o(this,Sn)}get awareness(){var t;return(t=o(this,En))==null?void 0:t.awareness}teardown(){var t;(t=o(this,En))==null||t.destroy(),o(this,Sn).destroy(),o(this,Ee).destroy()}}Ee=new WeakMap,En=new WeakMap,vn=new WeakMap,Sn=new WeakMap;const Df=["abate","abet","abut","abound","abreast","ado","afoot","afoul","agape","agasp","aghast","aglow","agog","aground","ahem","ahoy","ajar","akin","alas","aloft","amiss","amid","amidst","anew","aplomb","askance","askew","astray","avast","avow","awake","awash","away","aweigh","awry"];function Tf(s){const t=new Set(s);let e=1;for(;;){let n=[...Df];for(;n.length>0;){const i=Math.floor(Math.random()*n.length);let r=n[i];if(e>1&&(r+=e.toString()),!t.has(r))return r;n=n.filter(a=>a!==r)}e++}}var ve,As,H,bt,kn,_s,nt,xc,Hn,Cc,Ic,Ac;const Gt=class Gt{constructor(t){y(this,nt);y(this,As);y(this,H);y(this,bt,new Map);y(this,kn);y(this,_s);w(this,As,t),w(this,H,new _f(t)),w(this,kn,new Dr),w(this,_s,new dh(o(this,H).awareness)),m(this,nt,xc).call(this)}static createInstance(t){return o(Gt,ve)||w(Gt,ve,new Gt(t)),o(Gt,ve)}static getInstance(){if(!o(Gt,ve))throw new Error("ThingManager not initialized");return o(Gt,ve)}getDocId(){return o(this,As)}getSystem(){return o(this,kn)}createThing(t){const e=(t==null?void 0:t.id)||`ahoy:${crypto.randomUUID()}`,n=Bn(t.type),{id:i,...r}=Object.fromEntries(Object.entries(n).map(([l,c])=>[l,c.default])),a={...r,id:e,name:Tf(this.getAllThings().map(l=>l.name)),...t};if(this.getThingByName(a.name))throw new Error(`Thing with name "${a.name}" already exists`);return o(this,H).thingDataMap.set(e,a),e}getAllThings(){return Array.from(o(this,bt).values())}getThing(t){return o(this,bt).get(t)}getThingByName(t){return this.getAllThings().find(e=>e.name===t)}updateThing(t,e){const n=o(this,bt).get(t);if(!n)throw new Error(`Thing with ID ${t} not found`);const i={...n.getRawData(),...e};o(this,H).thingDataMap.set(t,i)}copyThing(t){const e=this.getThing(t);if(!e)return;const{id:n,name:i,...r}=e.getRawData();return r.x+=20,r.y+=20,this.createThing(r)}deleteThing(t){const e=o(this,bt).get(t);if(!e)throw new Error(`Thing with ID ${t} not found`);e.teardown(),o(this,H).thingDataMap.delete(t)}undo(){o(this,H).undoManager.undo()}redo(){o(this,H).undoManager.redo()}eval(t,e){const n=Object.fromEntries(this.getAllThings().map(r=>[r.name,r])),i={system:o(this,kn),...n};return Lf(t,e,i)}get userManager(){return o(this,_s)}loadData(t){for(const e of t)o(this,H).thingDataMap.set(e.id,e)}clearData(){const t=Array.from(o(this,H).thingDataMap.keys());for(const e of t)o(this,H).thingDataMap.delete(e)}teardown(){o(this,bt).clear(),o(this,H).teardown()}};ve=new WeakMap,As=new WeakMap,H=new WeakMap,bt=new WeakMap,kn=new WeakMap,_s=new WeakMap,nt=new WeakSet,xc=function(){o(this,H).thingDataMap.observe(t=>{for(const[e,n]of t.changes.keys)if(n.action==="add"){const i=o(this,H).thingDataMap.get(e);m(this,nt,Cc).call(this,i)}else if(n.action==="update"){const i=o(this,H).thingDataMap.get(e);m(this,nt,Ic).call(this,e,i)}else n.action==="delete"&&m(this,nt,Ac).call(this,e)}),o(this,H).undoManager.on("stack-item-added",({type:t})=>{}),o(this,H).undoManager.on("stack-item-popped",({type:t})=>{})},Hn=function(t,e=new Set,n=new Set){if(e.has(t.id))return n;e.add(t.id),n.add(t);for(const i of this.getAllThings()){if(i.id===t.id)continue;i.findReferencedSymbols().includes(t.name)&&m(this,nt,Hn).call(this,i,e,n)}return n},Cc=function(t){const e=t.type,n=Li[e];if(!n){console.warn(`Thing type "${e}" not supported; downgrading it!`),o(this,H).thingDataMap.delete(t.id);const l={type:"thing:label",value:JSON.stringify(t)};this.createThing(l);return}const i={updateThing:this.updateThing.bind(this),eval:this.eval.bind(this)},r=new n(t,i);o(this,bt).set(t.id,r),M.getInstance().emit("thing",{id:t.id,operation:"create"}),M.getInstance().emit("element",{id:t.id,operation:"create",element:r.element,data:t});const a=m(this,nt,Hn).call(this,r);for(const l of a)M.getInstance().emit("thing",{id:l.id,operation:"update"}),M.getInstance().emit("element",{id:l.id,operation:"update",element:l.element,parentId:l.parentId})},Ic=function(t,e){const n=o(this,bt).get(t);if(!n)throw new Error(`Thing with ID ${t} not found`);n._setRawData(e);const i=m(this,nt,Hn).call(this,n);for(const r of i)M.getInstance().emit("thing",{id:r.id,operation:"update"}),M.getInstance().emit("element",{id:r.id,operation:"update",element:r.element,parentId:r.parentId})},Ac=function(t){const e=o(this,bt).get(t);if(!e){console.warn(`Deleted thing with ID ${t} not found`);return}const n=m(this,nt,Hn).call(this,e);n.delete(e),o(this,bt).delete(t),M.getInstance().emit("thing",{id:t,operation:"delete"}),M.getInstance().emit("element",{id:t,operation:"delete",element:e.element});for(const i of n)M.getInstance().emit("thing",{id:i.id,operation:"update"}),M.getInstance().emit("element",{id:i.id,operation:"update",element:i.element,parentId:i.parentId})},y(Gt,ve);let C=Gt;function Lf(s,t,e){return new Function(...Object.keys(e),s).call(t,...Object.values(e))}var Kt,Qe,Qr,_c;class Mf{constructor(t,e,n){y(this,Qe);y(this,Kt);this.thingManager=C.createInstance(t),this.eventManager=M.getInstance(),this.canvasElement=this.getElementOrThrow(n),w(this,Kt,e?`ahoy:${e}`:void 0),m(this,Qe,_c).call(this)}getElementOrThrow(t){const e=document.getElementById(t);if(!e)throw new Error(`Element not found: ${t}`);return e}teardown(){this.thingManager.teardown()}}Kt=new WeakMap,Qe=new WeakSet,Qr=function(){if(!o(this,Kt))return;const t=document.getElementById(o(this,Kt));if(!t){console.warn(`Frame ${o(this,Kt)} not found`);return}const e=new Set;(i=>{e.add(i),i.querySelectorAll("*").forEach(r=>e.add(r))})(t),this.canvasElement.querySelectorAll('[id^="ahoy:"]').forEach(i=>{e.has(i)?i.style.display="":i.style.display="none"})},_c=function(){this.eventManager.on("element",t=>{var e;switch(t.operation){case"create":const n=t.data.parentId,i=n?document.getElementById(n):null;n?i?(i.contentElement.appendChild(t.element),t.element.needsDisplay()):this.canvasElement.appendChild(t.element):(this.canvasElement.appendChild(t.element),t.element.needsDisplay());const r=this.canvasElement.children;for(const a of Array.from(r)){const l=this.thingManager.getThing(a.id);(l==null?void 0:l.parentId)===t.element.id&&t.element.contentElement.appendChild(a)}o(this,Kt)&&m(this,Qe,Qr).call(this);break;case"update":{const a=t.element,l=(e=a.parentElement)==null?void 0:e.closest("ahoy-frame"),c=t.parentId;if(c){const h=document.getElementById(c);h&&(l==null?void 0:l.id)!==c&&h.contentElement.appendChild(a)}else l&&this.canvasElement.appendChild(a);t.element.needsDisplay(),o(this,Kt)&&m(this,Qe,Qr).call(this);break}case"delete":{t.element.remove();break}}})};const L=20;var _,Se,D,Xt,ze,Zt,gt,Dc,Ds,Tc,Lc,Mc,Ts,Ls,Ms,je,Os,Ns,to;class Of{constructor(t,e){y(this,gt);y(this,_);y(this,Se);y(this,D,{x:0,y:0,scale:1});y(this,Xt,!1);y(this,ze,!1);y(this,Zt,null);y(this,Ds,t=>{if(t.ctrlKey){t.preventDefault();const e=-t.deltaY*.01,n=this.getViewportPoint(t),i=o(this,D).scale*Math.exp(e);this.zoom(i,n)}});y(this,Ts,t=>{const e=t.target,n=m(this,gt,Lc).call(this,e);if(n){const i=window.getComputedStyle(n);if(["auto","scroll"].includes(i.overflowY)||["auto","scroll"].includes(i.overflowX))if(m(this,gt,Mc).call(this,e)){if(document.activeElement===e)return;t.preventDefault()}else return}this.pan(-t.deltaX,-t.deltaY)});y(this,Ls,t=>{(o(this,ze)||t.button===1)&&!o(this,Xt)&&(t.preventDefault(),w(this,Xt,!0),w(this,Zt,this.getViewportPoint(t)),o(this,_).style.cursor="grabbing",o(this,_).setPointerCapture(t.pointerId),t.stopPropagation())});y(this,Ms,t=>{if(!o(this,Xt)||!o(this,Zt))return;t.stopPropagation();const e=this.getViewportPoint(t),n=e.x-o(this,Zt).x,i=e.y-o(this,Zt).y;(n!==0||i!==0)&&(this.pan(n,i),w(this,Zt,e))});y(this,je,t=>{o(this,Xt)&&(w(this,Xt,!1),w(this,Zt,null),o(this,_).style.cursor=o(this,ze)?"grab":"",o(this,_).releasePointerCapture(t.pointerId))});y(this,Os,t=>{if(t.code==="Space")w(this,ze,!0),o(this,Xt)||(o(this,_).style.cursor="grab"),t.stopPropagation();else if(t.metaKey||t.ctrlKey){const e=o(this,_).getBoundingClientRect(),n={x:e.width/2,y:e.height/2};switch(t.key){case"0":this.zoom(1,n),t.preventDefault();break;case"=":case"+":this.zoom(o(this,D).scale*1.2,n),t.preventDefault();break;case"-":case"_":this.zoom(o(this,D).scale/1.2,n),t.preventDefault();break}}});y(this,Ns,t=>{t.code==="Space"&&(w(this,ze,!1),o(this,_).style.cursor="",t.stopPropagation())});w(this,_,t),w(this,Se,e),o(this,_).style.position="absolute",o(this,_).style.inset="0",o(this,_).style.overflow="clip",o(this,_).style.setProperty("--grid-size",`${L}px`),o(this,_).style.setProperty("--grid-offset-x","0px"),o(this,_).style.setProperty("--grid-offset-y","0px"),o(this,Se).style.position="absolute",o(this,Se).style.transformOrigin="0 0",m(this,gt,Dc).call(this)}getViewportElement(){return o(this,_)}getCanvasElement(){return o(this,Se)}pan(t,e){o(this,D).x+=t,o(this,D).y+=e,m(this,gt,to).call(this)}zoom(t,e){const n=o(this,D).scale;if(o(this,D).scale=Math.min(Math.max(t,.25),4),n!==o(this,D).scale){const i={x:(e.x-o(this,D).x)/n,y:(e.y-o(this,D).y)/n},r=e.x-(i.x*o(this,D).scale+o(this,D).x),a=e.y-(i.y*o(this,D).scale+o(this,D).y);o(this,D).x+=r,o(this,D).y+=a}m(this,gt,to).call(this)}setGridVisible(t){t?o(this,_).classList.add("viewport-grid"):o(this,_).classList.remove("viewport-grid")}getScale(){return o(this,D).scale}getViewportPoint(t){const e=o(this,_).getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}}toCanvasPoint(t){return{x:(t.x-o(this,D).x)/o(this,D).scale,y:(t.y-o(this,D).y)/o(this,D).scale}}teardown(){o(this,_).removeEventListener("wheel",o(this,Ds)),o(this,_).removeEventListener("wheel",o(this,Ts)),o(this,_).removeEventListener("pointerdown",o(this,Ls)),o(this,_).removeEventListener("pointermove",o(this,Ms)),o(this,_).removeEventListener("pointerup",o(this,je)),o(this,_).removeEventListener("pointercancel",o(this,je)),document.removeEventListener("keydown",o(this,Os)),document.removeEventListener("keyup",o(this,Ns))}}_=new WeakMap,Se=new WeakMap,D=new WeakMap,Xt=new WeakMap,ze=new WeakMap,Zt=new WeakMap,gt=new WeakSet,Dc=function(){o(this,_).addEventListener("wheel",o(this,Ds),{capture:!0}),o(this,_).addEventListener("wheel",o(this,Ts)),o(this,_).addEventListener("pointerdown",o(this,Ls),{capture:!0}),o(this,_).addEventListener("pointermove",o(this,Ms),{capture:!0}),o(this,_).addEventListener("pointerup",o(this,je),{capture:!0}),o(this,_).addEventListener("pointercancel",o(this,je),{capture:!0}),document.addEventListener("keydown",o(this,Os)),document.addEventListener("keyup",o(this,Ns))},Ds=new WeakMap,Tc=function(t){const e=window.getComputedStyle(t),n=["auto","scroll"].includes(e.overflowY)||["auto","scroll"].includes(e.overflowX),i=t.scrollHeight>t.clientHeight||t.scrollWidth>t.clientWidth;return n&&i},Lc=function(t){for(;t&&t!==o(this,_);){if(m(this,gt,Tc).call(this,t))return t;t=t.parentElement}return null},Mc=function(t){return t.tabIndex>=0},Ts=new WeakMap,Ls=new WeakMap,Ms=new WeakMap,je=new WeakMap,Os=new WeakMap,Ns=new WeakMap,to=function(){o(this,Se).style.transform=`translate(${o(this,D).x}px, ${o(this,D).y}px) scale(${o(this,D).scale})`;const t=L*o(this,D).scale;o(this,_).style.setProperty("--grid-size",`${t}px`);const e=o(this,D).x%t,n=o(this,D).y%t;o(this,_).style.setProperty("--grid-offset-x",`${e}px`),o(this,_).style.setProperty("--grid-offset-y",`${n}px`)};function gs(s,t){return s.x>=t.left&&s.x<=t.left+t.width&&s.y>=t.top&&s.y<=t.top+t.height}function Nf(s,t,e){return gs(s,e)||gs(t,e)?!0:[{x:e.left,y:e.top},{x:e.left+e.width,y:e.top},{x:e.left+e.width,y:e.top},{x:e.left+e.width,y:e.top+e.height},{x:e.left+e.width,y:e.top+e.height},{x:e.left,y:e.top+e.height},{x:e.left,y:e.top+e.height},{x:e.left,y:e.top}].reduce((i,r,a,l)=>(a<l.length-1&&i.push([r,l[a+1]]),i),[]).some(([i,r])=>Rf(s,t,i,r))}function Rf(s,t,e,n){const i=t.x-s.x,r=t.y-s.y,a=n.x-e.x,l=n.y-e.y,c=i*l-r*a;if(c===0)return!1;const h=((e.x-s.x)*l-(e.y-s.y)*a)/c,d=((e.x-s.x)*r-(e.y-s.y)*i)/c;return h>=0&&h<=1&&d>=0&&d<=1}var dt,Qt,$t,_t,ui,eo,Oc;class $f{constructor(t){y(this,_t);y(this,dt);y(this,Qt,new Map);y(this,$t,null);w(this,dt,t)}startDrag(t,e){var r;const n=o(this,dt).toCanvasPoint(e),i=t.filter(a=>{var c;const l=(c=a.parentElement)==null?void 0:c.closest('[id^="ahoy:"]');return!l||!t.includes(l)});for(const a of i){const l=(r=a.parentElement)==null?void 0:r.closest("ahoy-frame");let c;l?c=m(this,_t,ui).call(this,n,l):c=n,o(this,Qt).set(a.id,{element:a,offset:{x:a.offsetLeft-c.x,y:a.offsetTop-c.y},originalParent:a.parentElement,targetParentId:l==null?void 0:l.id}),a.classList.add("dragging")}}updateDrag(t,e=!1){var a;const n={},i=o(this,dt).toCanvasPoint(t),r=m(this,_t,Oc).call(this,t);r!==o(this,$t)&&(o(this,$t)&&o(this,$t).classList.remove("frame-drop-target"),r&&r.classList.add("frame-drop-target"),w(this,$t,r));for(const[l,c]of o(this,Qt)){const h=(a=c.element.parentElement)==null?void 0:a.closest("ahoy-frame");let d,u;if(h){const f=m(this,_t,ui).call(this,i,h);d=Math.round(f.x+c.offset.x),u=Math.round(f.y+c.offset.y)}else d=Math.round(i.x+c.offset.x),u=Math.round(i.y+c.offset.y);if(e&&(d=Math.round(d/L)*L,u=Math.round(u/L)*L),h&&!r){const f=m(this,_t,eo).call(this,{x:d,y:u},h);d=Math.round(f.x),u=Math.round(f.y),c.targetParentId=void 0,o(this,dt).getCanvasElement().appendChild(c.element)}else if(r&&(!h||h!==r)){const f=h?m(this,_t,eo).call(this,{x:d,y:u},h):{x:d,y:u},p=m(this,_t,ui).call(this,f,r);d=Math.round(p.x),u=Math.round(p.y),c.targetParentId=r.id,r.contentElement.appendChild(c.element)}c.element.style.left=`${Math.round(d)}px`,c.element.style.top=`${Math.round(u)}px`,n[l]={x:d,y:u}}return n}completeDrag(){for(const[t,e]of o(this,Qt))e.element.classList.remove("dragging"),C.getInstance().updateThing(t,{x:parseInt(e.element.style.left),y:parseInt(e.element.style.top),parentId:e.targetParentId});o(this,$t)&&o(this,$t).classList.remove("frame-drop-target"),o(this,Qt).clear(),w(this,$t,null)}isDragging(){return o(this,Qt).size>0}}dt=new WeakMap,Qt=new WeakMap,$t=new WeakMap,_t=new WeakSet,ui=function(t,e){const n=e.getBoundingClientRect(),i=o(this,dt).getCanvasElement().getBoundingClientRect(),r=o(this,dt).getScale();return{x:t.x-(n.left-i.left)/r,y:t.y-(n.top-i.top)/r}},eo=function(t,e){const n=e.getBoundingClientRect(),i=o(this,dt).getCanvasElement().getBoundingClientRect(),r=o(this,dt).getScale();return{x:t.x+(n.left-i.left)/r,y:t.y+(n.top-i.top)/r}},Oc=function(t){const e=o(this,dt).toCanvasPoint(t),n=Array.from(o(this,dt).getCanvasElement().querySelectorAll("ahoy-frame")).filter(i=>!o(this,Qt).has(i.id)).filter(i=>{const r={left:parseInt(i.style.left),top:parseInt(i.style.top),width:parseInt(i.style.width),height:parseInt(i.style.height)};return gs(e,r)});return n[n.length-1]||null};var It,te,O,Nc,no,so,Rc,io,$c,ro,Uc,Vc,Fc;class Uf{constructor(t){y(this,O);y(this,It);y(this,te);w(this,It,document.createElement("div")),o(this,It).classList.add("inspector-panel-container"),t.appendChild(o(this,It)),m(this,O,Nc).call(this)}updateSelection(t,e=!1){if(o(this,It).innerHTML="",w(this,te,void 0),!t||e){const n=document.createElement("p");n.className="no-selection",n.textContent=e?"Multiple objects selected":"No object selected",o(this,It).appendChild(n);return}m(this,O,Rc).call(this,t)}teardown(){o(this,It).remove()}}It=new WeakMap,te=new WeakMap,O=new WeakSet,Nc=function(){M.getInstance().on("element",({id:t,operation:e})=>{if(t===o(this,te))if(e==="delete")this.updateSelection(null);else{const n=C.getInstance().getThing(t);n&&m(this,O,so).call(this,n.getDisplayData())}}),M.getInstance().on("selection",({ids:t})=>{if(t.size===1){const e=Array.from(t)[0],n=C.getInstance().getThing(e);this.updateSelection((n==null?void 0:n.getDisplayData())||null)}else this.updateSelection(null,t.size>1)}),M.getInstance().on("move",({positions:t})=>{if(o(this,te)&&t[o(this,te)]){const e=t[o(this,te)];m(this,O,so).call(this,{x:e.x,y:e.y})}})},no=function(t,e){t instanceof HTMLInputElement&&t.type==="checkbox"?t.checked=e:t.dataset.type==="JsonValue"?t.value=JSON.stringify(e,null,2):t.value=(e==null?void 0:e.toString())||""},so=function(t){const e=o(this,It).querySelector("form");if(e)for(const[n,i]of Object.entries(t)){const r=e.querySelector(`[name="${n}"]`);r&&m(this,O,no).call(this,r,i)}},Rc=function(t){w(this,te,t.id);const e=C.getInstance().getThing(t.id);if(!e)throw new Error(`Thing with ID ${t.id} not found`);const n=e.constructor.getThingInfo(),i=document.createElement("form"),r=document.createElement("h3");r.textContent=n.metadata.title,i.appendChild(r);const a=document.createElement("p");if(a.textContent=n.metadata.description,a.style.fontSize="small",i.appendChild(a),e.type==="thing:frame"){const d=document.createElement("div");d.className="share-urls-container";const u=C.getInstance().getDocId(),f=t.id.replace(/^ahoy:/,""),p=`${window.location.origin}/s/${u}/${f}`,g=`${window.location.origin}/r/${u}/${f}`;d.appendChild(m(this,O,io).call(this,"Editor URL",p)),d.appendChild(m(this,O,io).call(this,"Viewer URL",g)),i.appendChild(d)}const l=new Map;for(const[d,u]of Object.entries(n.propertiesRecord)){if(["type"].includes(d))continue;const f=u.category||"Other";l.has(f)||l.set(f,[]),l.get(f).push({...u,name:d})}const c=[...l.keys()];for(const d of c){const u=l.get(d);if(!(u!=null&&u.length))continue;const f=document.createElement("div");f.className="category-header",f.textContent=d,i.appendChild(f);for(const p of u){const g=m(this,O,$c).call(this,p,e,t);i.appendChild(g)}}const h=Object.values(n.methodsRecord);if(h.length>0){const d=new Map;for(const u of h){const f=u.category||"Actions";d.has(f)||d.set(f,[]),d.get(f).push(u)}for(const[u,f]of d){const p=document.createElement("div");p.className="category-header",p.textContent=u,i.appendChild(p);const g=document.createElement("div");g.className="methods-group",g.style.display="flex",g.style.flexDirection="column",g.style.gap="4px";for(const b of f){const E=m(this,O,Vc).call(this,b,e);g.appendChild(E)}i.appendChild(g)}}o(this,It).appendChild(i)},io=function(t,e){const n=document.createElement("div");n.className="share-url-container";const i=document.createElement("span");i.textContent=`${t}: `,i.className="share-url-label",n.appendChild(i);const r=document.createElement("input");return r.type="text",r.value=e,r.readOnly=!0,r.className="share-url-input",r.addEventListener("click",()=>{r.select()}),n.appendChild(r),n},$c=function(t,e,n){const i=document.createElement("div"),r=t.type==="JsonValue"||t.type==="string"&&t.format==="code-js";if(i.className=r?"property-group property-group-stacked":"property-group",i.dataset.property=t.name,r){const a=document.createElement("label");a.textContent=t.name,a.title=t.description,a.className="label-stacked",i.appendChild(a);const l=m(this,O,ro).call(this,t,n[t.name],e,t.name);if(i.appendChild(l),l instanceof HTMLTextAreaElement&&l.dataset.codeField==="true"){const c=CodeMirror.fromTextArea(l,{mode:t.type==="JsonValue"?"application/json":"javascript",tabSize:2,lineWrapping:!0,viewportMargin:1/0,lint:{onUpdateLinting:function(h,d,u){(t.type==="JsonValue"?h.length>0:h.some(p=>p.severity==="error"))?u.getWrapperElement().classList.add("invalid"):u.getWrapperElement().classList.remove("invalid")},...t.type!=="JsonValue"&&{esversion:6,browser:!0}}});c.getInputField().dataset.codeField="true",c.on("change",()=>{try{const h=t.type==="JsonValue"?JSON.parse(c.getValue()):c.getValue();e.setSlotValue(t.name,h),c.getWrapperElement().classList.remove("invalid")}catch{c.getWrapperElement().classList.add("invalid")}}),setTimeout(()=>c.refresh(),0)}}else{const a=document.createElement("div");a.className="property-group-row",i.appendChild(a);let l;const c=document.createElement("label");if(c.textContent=t.name,c.title=t.description,a.appendChild(c),l=m(this,O,ro).call(this,t,n[t.name],e,t.name),l.title=t.description,a.appendChild(l),!t.disallowFormula&&!t.readonly){let h=m(this,O,Uc).call(this,a,t,e,l);i.appendChild(h)}}return i},ro=function(t,e,n,i){let r;if(t.enum){r=document.createElement("select");const a=n.getSlotDisplayValue(i);t.enum.forEach(l=>{const c=document.createElement("option");c.value=c.textContent=l,c.selected=l===a,r.appendChild(c)})}else if(t.type==="JsonValue"||t.type==="string"&&t.format==="code-js")r=document.createElement("textarea"),r.rows=10,r.spellcheck=!1,r.dataset.codeField="true";else{switch(r=document.createElement("input"),t.format){case"color":r.type="color";break;case"date-time":r.type="datetime-local";break;default:switch(t.type){case"boolean":r.type="checkbox";break;case"string":r.type="text",r.autocomplete="off",t.minLength!==void 0&&(r.minLength=t.minLength),t.maxLength!==void 0&&(r.maxLength=t.maxLength),t.pattern!==void 0&&(r.pattern=t.pattern);break;default:r.type=t.type}}t.min!==void 0&&(r.min=t.min.toString()),t.max!==void 0&&(r.max=t.max.toString()),t.step!==void 0&&(r.step=t.step.toString())}return r.name=i,r.dataset.type=t.type,t.format!==void 0&&(r.dataset.format=t.format),m(this,O,no).call(this,r,e),t.readonly&&(r instanceof HTMLSelectElement||(r.readOnly=!0),r.disabled=!0),r.addEventListener("focus",a=>{a.target.setAttribute("oldValue",r.value)}),r.addEventListener("input",a=>{const l=a.target;let c=l.reportValidity();if(c&&t.minLength&&t.minLength>0&&l.value.length===0&&(c=!1),!c)return;let h;l instanceof HTMLInputElement&&l.type==="checkbox"?h=l.checked:l instanceof HTMLInputElement&&l.type==="number"?h=parseFloat(l.value):t.type==="JsonValue"?h=JSON.parse(l.value):h=l.value,n.setSlotValue(i,h)}),r.addEventListener("blur",a=>{const l=a.target,c=l.getAttribute("oldValue")||"";l.removeAttribute("oldValue");let h=l.checkValidity();h&&t.minLength&&t.minLength>0&&l.value.length===0&&(h=!1),h||(l.value=c)}),r},Uc=function(t,e,n,i){const r=document.createElement("input");r.type="text",r.className="formula-input",r.value=(n==null?void 0:n.getSlotFormula(e.name))||"",r.placeholder="Enter formula",r.dataset.codeField="true";const a=document.createElement("button");return a.type="button",a.className="formula-toggle",a.textContent="▸",a.tabIndex=-1,a.onclick=()=>{a.textContent=a.textContent==="▸"?"▾":"▸",r.classList.toggle("hidden")},t.appendChild(a),!!r.value?(a.disabled=!0,a.textContent="▾",i.disabled=!0):r.classList.add("hidden"),r.addEventListener("change",()=>{n.setSlotFormula(e.name,r.value);const c=!!(r.value&&r.value.length>0);a.disabled=c,i.disabled=c}),r},Vc=function(t,e){const n=document.createElement("button");return n.type="button",n.title=t.description||t.name,n.textContent=`${t.name}(${t.parameters.map(i=>i.name).join(", ")})`,n.onclick=async()=>{if(t.parameters.length>0)throw new Error("Not implemented");try{const i=e[t.name]();i!==void 0&&t.returns&&m(this,O,Fc).call(this,i)}catch(i){e.setError(i)}},n},Fc=function(t){const e=document.createElement("dialog");e.innerHTML=`
      <div style="margin-bottom: 16px">
        <div style="margin-bottom: 8px">Result:</div>
        <pre style="margin: 0">${JSON.stringify(t,null,2)}</pre>
      </div>
      <div style="display: flex; justify-content: flex-end">
        <button onclick="this.closest('dialog').close()">OK</button>
      </div>
    `,document.body.appendChild(e),e.showModal(),e.addEventListener("close",()=>e.remove())};var xn,At,Rs,oo;class Pc{constructor(t){y(this,Rs);y(this,xn);y(this,At,null);w(this,xn,t)}static addResizeHandles(t){t.querySelectorAll(".resize-handle").forEach(n=>n.remove());const e=t.constructor.SHAPE;if(e==="rect"){const n=["n","s","e","w","nw","ne","sw","se"];for(const i of n){const r=document.createElement("div");r.className=`resize-handle resize-handle-${i}`,r.dataset.handle=i,t.appendChild(r)}}else if(e==="line"){const n=["start","end"];for(const i of n){const r=document.createElement("div");r.className=`resize-handle resize-handle-${i}`,r.dataset.handle=i,i==="end"&&(r.style.left="100%",r.style.top="100%",r.style.transform="translate(-50%, -50%)"),t.appendChild(r)}}}startResize(t,e){if(t.constructor.SHAPE==="rect"){if(!["n","s","e","w","nw","ne","sw","se"].includes(e))return!1;w(this,At,{shape:"rect",element:t,handle:e,initialRect:{left:parseInt(t.style.left),top:parseInt(t.style.top),width:parseInt(t.style.width),height:parseInt(t.style.height)},constraints:m(this,Rs,oo).call(this,t,"rect")})}else{if(!["start","end"].includes(e))return!1;w(this,At,{shape:"line",element:t,handle:e,initialRect:{left:parseInt(t.style.left),top:parseInt(t.style.top),width:parseInt(t.style.width),height:parseInt(t.style.height)},constraints:m(this,Rs,oo).call(this,t,"line")})}return!0}updateResize(t,e,n=!1){if(!o(this,At))return;const{element:i,handle:r,shape:a,initialRect:l,constraints:c}=o(this,At),h=o(this,xn).toCanvasPoint(t),d=o(this,xn).toCanvasPoint(e),u=h.x-d.x,f=h.y-d.y;if(a==="rect"){let p=l.width,g=l.height,b=l.left,E=l.top;r.includes("w")&&(p-=u,b+=u),r.includes("e")&&(p+=u),r.includes("n")&&(g-=f,E+=f),r.includes("s")&&(g+=f),p=Math.max(c.minWidth,p),g=Math.max(c.minHeight,g),c.maxWidth!==void 0&&(p=Math.min(c.maxWidth,p)),c.maxHeight!==void 0&&(g=Math.min(c.maxHeight,g)),n&&(b=Math.round(b/L)*L,E=Math.round(E/L)*L,p=Math.round(p/L)*L,g=Math.round(g/L)*L),i.style.width=`${Math.round(p)}px`,i.style.height=`${Math.round(g)}px`,i.style.left=`${Math.round(b)}px`,i.style.top=`${Math.round(E)}px`}else if(r==="start"){let p=l.left+u,g=l.top+f,b=l.width-u,E=l.height-f;n&&(p=Math.round(p/L)*L,g=Math.round(g/L)*L,b=Math.round(b/L)*L,E=Math.round(E/L)*L),i.style.width=`${Math.round(b)}px`,i.style.height=`${Math.round(E)}px`,i.style.left=`${Math.round(p)}px`,i.style.top=`${Math.round(g)}px`}else{let p=l.width+u,g=l.height+f;n&&(p=Math.round(p/L)*L,g=Math.round(g/L)*L),p=Math.max(c.minWidth,p),g=Math.max(c.minHeight,g),c.maxWidth!==void 0&&(p=Math.min(c.maxWidth,p)),c.maxHeight!==void 0&&(g=Math.min(c.maxHeight,g)),i.style.width=`${Math.round(p)}px`,i.style.height=`${Math.round(g)}px`}}completeResize(){if(!o(this,At))return;const{element:t}=o(this,At);C.getInstance().updateThing(t.id,{width:parseInt(t.style.width),height:parseInt(t.style.height),x:parseInt(t.style.left),y:parseInt(t.style.top)}),w(this,At,null)}isResizing(){return o(this,At)!==null}}xn=new WeakMap,At=new WeakMap,Rs=new WeakSet,oo=function(t,e){var a,l,c,h;const n=C.getInstance().getThing(t.id);if(!n)return e==="rect"?{minWidth:20,minHeight:20}:{minWidth:1,minHeight:1};const r=n.getThingInfo().propertiesRecord;return{minWidth:((a=r.width)==null?void 0:a.min)??(e==="rect"?20:1),maxWidth:(l=r.width)==null?void 0:l.max,minHeight:((c=r.height)==null?void 0:c.min)??(e==="rect"?20:1),maxHeight:(h=r.height)==null?void 0:h.max}};var Ut,$s,We,ee,ce,Hc,ao,Bc;class Vf{constructor(t){y(this,ce);y(this,Ut);y(this,$s,!0);y(this,We,new Set);y(this,ee,null);w(this,Ut,t),M.getInstance().on("selection",({ids:e})=>{w(this,We,e),m(this,ce,ao).call(this)})}setSelectionVisible(t){w(this,$s,t),m(this,ce,ao).call(this)}select(t){const e=new Set(t);M.getInstance().emit("selection",{ids:e})}getSelectedIds(){return o(this,We)}startMarqueeSelection(){const t=document.createElement("div");return t.className="selection-box",o(this,Ut).getViewportElement().appendChild(t),w(this,ee,t),t}updateMarqueeSelection(t,e){if(!o(this,ee))return;const n=Math.min(e.x,t.x),i=Math.min(e.y,t.y),r=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y);Object.assign(o(this,ee).style,{left:`${n}px`,top:`${i}px`,width:`${r}px`,height:`${a}px`,position:"absolute"});const l=o(this,Ut).toCanvasPoint(e),c=o(this,Ut).toCanvasPoint(t),h=Math.min(l.x,c.x),d=Math.min(l.y,c.y),u=Math.abs(c.x-l.x),f=Math.abs(c.y-l.y),p=new DOMRect(h,d,u,f),g=m(this,ce,Bc).call(this,p);this.select(g)}endMarqueeSelection(){o(this,ee)&&(o(this,ee).remove(),w(this,ee,null))}}Ut=new WeakMap,$s=new WeakMap,We=new WeakMap,ee=new WeakMap,ce=new WeakSet,Hc=function(t){const e=[],n=Array.from(t.querySelectorAll(".thing-content")[0].children);for(;n.length>0;){const i=n.pop();if(e.push(i),i.tagName.toLowerCase().startsWith("ahoy-frame")){const r=i.querySelector(".thing-content");r&&n.push(...Array.from(r.children))}}return e},ao=function(){if(o(this,Ut).getCanvasElement().querySelectorAll(".resize-handle").forEach(t=>t.remove()),o(this,Ut).getCanvasElement().querySelectorAll(".selected").forEach(t=>t.classList.remove("selected")),o(this,$s))for(const t of o(this,We)){const e=document.getElementById(t);e&&(e.classList.add("selected"),o(this,We).size===1&&Pc.addResizeHandles(e))}},Bc=function(t){const e=new Set(Array.from(o(this,Ut).getCanvasElement().children).filter(n=>{if(!(n instanceof V)||n.classList.contains("selection-box"))return!1;if(n.constructor.SHAPE==="rect"){const i=new DOMRect(parseInt(n.style.left),parseInt(n.style.top),parseInt(n.style.width),parseInt(n.style.height));return!(i.left>t.right||i.right<t.left||i.top>t.bottom||i.bottom<t.top)}else{const i={x:parseInt(n.style.left),y:parseInt(n.style.top)},r={x:i.x+parseInt(n.dataset.dx||"0"),y:i.y+parseInt(n.dataset.dy||"0")};return gs(i,t)||gs(r,t)?!0:Nf(i,r,t)}}).map(n=>n.id));for(const n of Array.from(e)){const i=document.getElementById(n);i!=null&&i.tagName.toLowerCase().startsWith("ahoy-frame")&&m(this,ce,Hc).call(this,i).forEach(a=>e.add(a.id))}return Array.from(e)};var Nn,zc,jc;class Ff{constructor(t,e){y(this,Nn);m(this,Nn,zc).call(this,t),m(this,Nn,jc).call(this,e)}}Nn=new WeakSet,zc=function(t){const e=new Map,n="Other";for(const i of Object.values(Li)){const a=i.getThingInfo().metadata.category||n;e.has(a)||e.set(a,[]),e.get(a).push(i)}for(const[i,r]of e){const a=document.createElement("div");a.className="things-category-header",a.textContent=i,t.appendChild(a);const l=document.createElement("div");l.className="things-category-group";for(const c of r){const h=c.getThingInfo(),d=document.createElement("button");d.className="object-btn",d.textContent=h.metadata.title,d.title=h.metadata.description,d.draggable=!0,d.tabIndex=-1,d.addEventListener("dragstart",u=>{u.dataTransfer.effectAllowed="copy",u.dataTransfer.setData("text/plain",c.TYPE)}),l.appendChild(d)}t.appendChild(l)}},jc=function(t){const e=t.getViewportElement();e.addEventListener("dragover",n=>{n.preventDefault(),n.dataTransfer.dropEffect="copy"}),e.addEventListener("drop",n=>{n.preventDefault();const i=t.toCanvasPoint(t.getViewportPoint(n)),r=Math.round(i.x),a=Math.round(i.y),l=n.dataTransfer.getData("text/plain");if(!l.startsWith("thing:"))throw new Error("Invalid drag data type");const c=Bn(l),h=c.width.default,d=c.height.default,u={type:l,x:r-h/2,y:a-d/2};C.getInstance().createThing(u)})};function Wc(){var t;let s=document.activeElement;for(;(t=s==null?void 0:s.shadowRoot)!=null&&t.activeElement;)s=s.shadowRoot.activeElement;return s?s instanceof HTMLInputElement?["text","email","number","password","search","tel","url","date","datetime-local","month","time","week"].includes(s.type):s instanceof HTMLTextAreaElement?!0:s.isContentEditable:!1}var Vt,ut,ne,Rn,Yc,Gc,Us,Vs,Fs;class Pf{constructor(t,e){y(this,Rn);y(this,Vt);y(this,ut);y(this,ne,!1);y(this,Us,t=>{const e=o(this,Vt).querySelector('[data-tool="browse-tool"]'),n=o(this,Vt).querySelector('[data-tool="edit-tool"]'),i=e==null?void 0:e.classList.contains("active"),r=n==null?void 0:n.classList.contains("active");if(t.metaKey&&t.altKey&&!o(this,ne)){w(this,ne,!0),r?o(this,ut).emit("tool",{tool:"browse-tool",springLoaded:!0}):i&&o(this,ut).emit("tool",{tool:"edit-tool",springLoaded:!0});return}if(!Wc()&&!t.metaKey&&!t.altKey)switch(t.key){case"Escape":case"1":case"b":o(this,ut).emit("tool",{tool:"browse-tool"});break;case"2":case"e":o(this,ut).emit("tool",{tool:"edit-tool"});break}});y(this,Vs,t=>{if(o(this,ne)&&(!t.metaKey||!t.altKey)){w(this,ne,!1);const e=o(this,Vt).querySelector('[data-tool="browse-tool"]'),n=o(this,Vt).querySelector('[data-tool="edit-tool"]');e!=null&&e.classList.contains("active")?o(this,ut).emit("tool",{tool:"edit-tool"}):n!=null&&n.classList.contains("active")&&o(this,ut).emit("tool",{tool:"browse-tool"})}});y(this,Fs,()=>{o(this,ne)&&(w(this,ne,!1),o(this,ut).emit("tool",{tool:"edit-tool"}))});w(this,Vt,t),w(this,ut,e),m(this,Rn,Yc).call(this),m(this,Rn,Gc).call(this),o(this,ut).on("tool",({tool:n})=>{const i=o(this,Vt).querySelectorAll(".toolbar-item");for(const r of i)r.classList.toggle("active",r.dataset.tool===n)})}teardown(){document.removeEventListener("keydown",o(this,Us)),document.removeEventListener("keyup",o(this,Vs)),window.removeEventListener("blur",o(this,Fs))}}Vt=new WeakMap,ut=new WeakMap,ne=new WeakMap,Rn=new WeakSet,Yc=function(){const t=[["browse-tool","hand-index-thumb.svg","Browse — B"],["edit-tool","pencil.svg","Edit — E"]];for(const[e,n,i]of t){const r=document.createElement("button");r.className="toolbar-item",e==="browse-tool"&&r.classList.add("active"),r.dataset.tool=e,r.title=i;const a=document.createElement("img");a.src=`/${n}`,r.appendChild(a),r.onclick=()=>o(this,ut).emit("tool",{tool:e}),o(this,Vt).appendChild(r)}},Gc=function(){document.addEventListener("keydown",o(this,Us)),document.addEventListener("keyup",o(this,Vs)),window.addEventListener("blur",o(this,Fs))},Us=new WeakMap,Vs=new WeakMap,Fs=new WeakMap;const si=24;var ft,B,Cn,Ht,Jc,fi,qc;class Hf{constructor(t,e){y(this,Ht);y(this,ft);y(this,B);y(this,Cn);w(this,ft,e.localUser),w(this,B,document.createElement("div")),o(this,B).style.position="absolute",o(this,B).style.cursor="pointer",o(this,B).style.width=`${si}px`,o(this,B).style.height=`${si}px`,o(this,B).style.top="16px",o(this,B).style.left=`-${16+si}px`,o(this,B).style.borderRadius="50%",o(this,B).style.textAlign="center",o(this,B).style.lineHeight=`${si-2}px`,o(this,B).style.backgroundColor=o(this,ft).color,o(this,B).style.color=Vr(o(this,ft).color)?"white":"black",o(this,B).onclick=()=>m(this,Ht,qc).call(this),t.appendChild(o(this,B)),m(this,Ht,fi).call(this),w(this,Cn,m(this,Ht,Jc).bind(this)),M.getInstance().on("user",o(this,Cn))}teardown(){var t;M.getInstance().off("user",o(this,Cn)),(t=o(this,B))==null||t.remove()}}ft=new WeakMap,B=new WeakMap,Cn=new WeakMap,Ht=new WeakSet,Jc=function(){m(this,Ht,fi).call(this)},fi=function(){const t=o(this,ft).name==="Anonymous"?"":o(this,ft).name.slice(0,1);o(this,B).textContent=t,o(this,B).title=o(this,ft).name},qc=function(){let t=prompt("Enter your name:",o(this,ft).name);t!==null&&(o(this,ft).name=t.trim(),o(this,ft).name.length===0&&(o(this,ft).name="Anonymous"),m(this,Ht,fi).call(this))};var Ps,U,Hs,Et,se,F,ie,Ft,vt,I,Kc,Xc,Bs,lo,zs,js,Ye,Ws,Ys,Zc,Qc,th,eh,nh,sh,co,pi,fe,ih;class Bf{constructor(t,e,n,i,r,a,l,c,h){y(this,I);y(this,Ps);y(this,U);y(this,Hs);y(this,Et);y(this,se);y(this,F);y(this,ie,null);y(this,Ft);y(this,vt,null);y(this,Bs,t=>{m(this,I,fe).call(this)==="edit-tool"&&(t.stopPropagation(),t.preventDefault())});y(this,zs,t=>{if(m(this,I,fe).call(this)==="browse-tool"||t.button!==0)return;let e=t.target;const n=e.closest(".resize-handle");if(n){const i=n.parentElement,r=n.dataset.handle;if(!r)throw new Error("Resize handle missing data-handle attribute");if(o(this,se).startResize(i,r)){w(this,Ft,o(this,U).getViewportPoint(t)),t.stopPropagation();return}}if(e=m(this,I,lo).call(this,e)||e,o(this,vt)){if(o(this,vt)===e)return;m(this,I,pi).call(this)}if(e===this.canvasElement||e===o(this,U).getViewportElement())t.shiftKey||this.select([]),o(this,F).startMarqueeSelection();else{const i=o(this,F).getSelectedIds();if(t.shiftKey){const r=new Set(i);r.has(e.id)?r.delete(e.id):r.add(e.id),this.select(Array.from(r))}else i.has(e.id)||this.select([e.id])}w(this,Ft,o(this,U).getViewportPoint(t)),t.preventDefault()});y(this,js,async t=>{var n,i,r,a;if(!o(this,Ft))return;const e=o(this,U).getViewportPoint(t);if(o(this,se).isResizing()){const l=m(this,I,fe).call(this)==="edit-tool"&&((n=o(this,ie))==null?void 0:n.ctrlKey);o(this,se).updateResize(e,o(this,Ft),l)}else if(o(this,Et).isDragging()){const l=m(this,I,fe).call(this)==="edit-tool"&&((i=o(this,ie))==null?void 0:i.ctrlKey),c=o(this,Et).updateDrag(e,l);this.eventManager.emit("move",{positions:c})}else{const l=t.target;if(m(this,I,lo).call(this,l)){const h=Array.from(o(this,F).getSelectedIds()).map(d=>document.getElementById(d)).filter(d=>d instanceof V);if((r=o(this,ie))!=null&&r.altKey&&!((a=o(this,ie))!=null&&a.metaKey)){const d=await m(this,I,sh).call(this);h.length=0,h.push(...d.map(u=>document.getElementById(u)).filter(u=>u instanceof V)),this.select(d)}o(this,Et).startDrag(h,o(this,Ft)),this.canvasElement.setPointerCapture(t.pointerId)}else o(this,F).updateMarqueeSelection(e,o(this,Ft)),this.canvasElement.setPointerCapture(t.pointerId)}});y(this,Ye,t=>{this.canvasElement.releasePointerCapture(t.pointerId),o(this,Et).isDragging()?o(this,Et).completeDrag():o(this,se).isResizing()?o(this,se).completeResize():o(this,F).endMarqueeSelection(),w(this,Ft,void 0)});y(this,Ws,t=>{if(w(this,ie,t),m(this,I,fe).call(this)==="edit-tool"){if(o(this,vt)&&o(this,vt).isFieldEditor()){(t.key==="Enter"||t.key==="Escape")&&(m(this,I,pi).call(this,t.key!=="Escape"),t.preventDefault());return}if(!Wc()){switch(t.key){case"Delete":case"Backspace":m(this,I,eh).call(this),t.preventDefault();break;case"Escape":this.select([]);break;case"Enter":m(this,I,nh).call(this),t.preventDefault();break;case"ArrowLeft":case"ArrowRight":case"ArrowUp":case"ArrowDown":if(o(this,F).getSelectedIds().size>0){const n=t.shiftKey?L:1,i=(t.key==="ArrowRight"?1:t.key==="ArrowLeft"?-1:0)*n,r=(t.key==="ArrowDown"?1:t.key==="ArrowUp"?-1:0)*n,a=Array.from(o(this,F).getSelectedIds()).map(l=>document.getElementById(l)).filter(l=>l instanceof V);if(a.length>0){o(this,Et).startDrag(a,{x:0,y:0});const l=t.shiftKey,c=o(this,Et).updateDrag({x:i,y:r},l);this.eventManager.emit("move",{positions:c}),o(this,Et).completeDrag(),t.preventDefault()}}break}if(t.metaKey||t.ctrlKey)switch(t.key.toLowerCase()){case"c":case"x":m(this,I,Zc).call(this,t.key==="x"),t.preventDefault();break;case"v":m(this,I,Qc).call(this),t.preventDefault();break;case"z":t.shiftKey?this.thingManager.redo():this.thingManager.undo(),t.preventDefault();break;case"a":m(this,I,th).call(this),t.preventDefault();break}}}});y(this,Ys,()=>{w(this,ie,null)});this.containerElement=this.getElementOrThrow(i),this.canvasElement=this.getElementOrThrow(a);const d=this.getElementOrThrow(r);w(this,Ps,new Mf(t,e,a)),w(this,U,new Of(d,this.canvasElement)),this.thingManager=C.getInstance(),this.eventManager=M.getInstance(),w(this,Et,new $f(o(this,U))),w(this,se,new Pc(o(this,U))),w(this,F,new Vf(o(this,U))),new Ff(this.getElementOrThrow(c),o(this,U));const u=this.getElementOrThrow(h);w(this,Hs,new Uf(u)),new Pf(this.getElementOrThrow(l),this.eventManager),new Hf(u,this.thingManager.userManager),n&&(this.getElementOrThrow(l).style.display="none",this.getElementOrThrow(c).style.display="none",this.getElementOrThrow(h).style.display="none"),m(this,I,ih).call(this,"browse-tool"),m(this,I,Kc).call(this),m(this,I,Xc).call(this)}getElementOrThrow(t){const e=document.getElementById(t);if(!e)throw new Error(`Element not found: ${t}`);return e}select(t){o(this,F).select(t)}teardown(){this.canvasElement.removeEventListener("click",o(this,Bs)),o(this,U).getViewportElement().removeEventListener("pointerdown",o(this,zs)),o(this,U).getViewportElement().removeEventListener("pointermove",o(this,js)),o(this,U).getViewportElement().removeEventListener("pointerup",o(this,Ye)),o(this,U).getViewportElement().removeEventListener("pointercancel",o(this,Ye)),document.removeEventListener("keydown",o(this,Ws)),document.removeEventListener("keyup",o(this,Ys)),o(this,Hs).teardown(),o(this,U).teardown(),o(this,Ps).teardown()}}Ps=new WeakMap,U=new WeakMap,Hs=new WeakMap,Et=new WeakMap,se=new WeakMap,F=new WeakMap,ie=new WeakMap,Ft=new WeakMap,vt=new WeakMap,I=new WeakSet,Kc=function(){this.eventManager.on("tool",({tool:t,springLoaded:e})=>{this.containerElement.dataset.tool=t,this.containerElement.dataset.springLoaded=e?"true":"false",o(this,U).setGridVisible(t==="edit-tool"),o(this,F).setSelectionVisible(t==="edit-tool")}),this.eventManager.on("element",({id:t,operation:e})=>{e==="create"&&m(this,I,fe).call(this)==="edit-tool"&&this.select([t])}),this.eventManager.on("editing",({id:t})=>{m(this,I,fe).call(this)==="edit-tool"&&m(this,I,co).call(this,t)}),this.eventManager.on("selection",()=>{o(this,vt)&&m(this,I,pi).call(this)})},Xc=function(){this.canvasElement.addEventListener("click",o(this,Bs),{capture:!0}),o(this,U).getViewportElement().addEventListener("pointerdown",o(this,zs)),o(this,U).getViewportElement().addEventListener("pointermove",o(this,js)),o(this,U).getViewportElement().addEventListener("pointerup",o(this,Ye)),o(this,U).getViewportElement().addEventListener("pointercancel",o(this,Ye)),document.addEventListener("keydown",o(this,Ws)),document.addEventListener("keyup",o(this,Ys))},Bs=new WeakMap,lo=function(t){let e=t;for(;e&&!e.tagName.toLowerCase().startsWith("ahoy-");)e=e.parentElement;return e||null},zs=new WeakMap,js=new WeakMap,Ye=new WeakMap,Ws=new WeakMap,Ys=new WeakMap,Zc=async function(t){if(o(this,F).getSelectedIds().size===0)return;const e=[];for(const n of o(this,F).getSelectedIds()){const i=this.thingManager.getThing(n);if(!i)continue;const r=i.getRawData();e.push(r)}try{if(await navigator.clipboard.writeText(JSON.stringify(e)),t){for(const n of o(this,F).getSelectedIds())this.thingManager.deleteThing(n);this.select([])}}catch(n){throw new Error(`Clipboard operation failed: ${n}`)}},Qc=async function(){try{const t=await navigator.clipboard.readText(),e=JSON.parse(t);if(!Array.isArray(e))throw new Error("Clipboard data must be an array");if(!e.every(a=>typeof a=="object"&&a!==null&&"type"in a))throw new Error("Each pasted item must have a 'type' field");const r=e.map(a=>{const{id:l,...c}=a;return l&&this.thingManager.getThing(l)?c:a}).map(a=>this.thingManager.createThing(a));this.select(r)}catch(t){throw new Error(`Paste failed: ${t}`)}},th=function(){const t=Array.from(this.canvasElement.children).filter(e=>e instanceof HTMLElement).map(e=>e.id).filter(Boolean);this.select(t)},eh=function(){if(o(this,F).getSelectedIds().size!==0){for(const t of o(this,F).getSelectedIds())this.thingManager.deleteThing(t);this.select([])}},nh=function(){if(o(this,F).getSelectedIds().size!==1)return;const t=Array.from(o(this,F).getSelectedIds())[0],e=this.thingManager.getThing(t);e!=null&&e.element&&m(this,I,co).call(this,t)},sh=async function(){const t=[];for(const e of o(this,F).getSelectedIds()){const n=this.thingManager.getThing(e);if(!n)continue;const{id:i,name:r,...a}=n.getRawData();t.push(a)}return t.map(e=>this.thingManager.createThing(e))},co=function(t){const e=document.getElementById(t);!e||!("beginEditing"in e)||(e.contentElement.classList.add("editing"),w(this,vt,e),o(this,vt).beginEditing())},pi=function(t=!0){const e=o(this,vt);if(e)if(e.contentElement.classList.remove("editing"),e.endEditing(),w(this,vt,null),t){let n=e.getEditableData();this.thingManager.updateThing(e.id,n)}else e.needsDisplay()},fe=function(){return this.containerElement.dataset.tool},ih=function(t){this.containerElement.dataset.tool=t};const On=new URL(window.location.href),Xi=On.pathname.split("/").filter(Boolean),ho=Xi[0];if(ho!=="s"&&ho!=="r"||!Xi[1]){const s=crypto.randomUUID();On.pathname=`/s/${s}`,window.location.href=On.href}const zf=Xi[1],jf=Xi[2],Wf=ho==="r";window.ahoyEditor=new Bf(zf,jf,Wf,"container","viewport","canvas","toolbar","system-panel","inspector-panel");const ur=On.searchParams.get("template");if(ur){console.log(`Loading snapshot from template: ${ur}`),C.getInstance().getSystem().restoreFromUrl(ur,n=>{console.error(`Error loading snapshot: ${n.message}`),alert(`Failed to load snapshot: ${n.message}`)}),On.searchParams.delete("template");const t=On.searchParams.toString(),e=t?`?${t}`:"";window.history.replaceState({},"",`${window.location.pathname}${e}`)}
